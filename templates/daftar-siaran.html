{% extends "base.html" %}

{% block title %}Daftar Siaran Digital - KTVDI{% endblock %}

{% block content %}
<div class="container fade-in-up" style="max-width: 800px; margin-top: 2rem;">

    <div style="text-align: center; margin-bottom: 2rem;">
        <h1 style="color: var(--primary); font-weight: 700;">Daftar Siaran Digital</h1>
        <p class="text-muted">Cari frekuensi dan daftar saluran TV di wilayah Anda.</p>
    </div>

    <div class="auth-card" style="text-align: left; margin-bottom: 2rem;">
        <div class="form-group">
            <label for="provinsi"><i class="fas fa-map-marker-alt"></i> Pilih Provinsi</label>
            <div style="position: relative;">
                <select id="provinsi" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9; appearance: none;">
                    <option value="">-- Silakan Pilih --</option>
                    {% for p in provinsi_list %}
                        <option value="{{ p }}">{{ p }}</option>
                    {% endfor %}
                </select>
                <i class="fas fa-chevron-down" style="position: absolute; right: 15px; top: 15px; color: #999; pointer-events: none;"></i>
            </div>
        </div>

        <div class="form-group">
            <label for="wilayah"><i class="fas fa-map"></i> Pilih Wilayah Layanan</label>
            <div style="position: relative;">
                <select id="wilayah" disabled style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: #eee; appearance: none; cursor: not-allowed;">
                    <option value="">-- Menunggu Provinsi --</option>
                </select>
                <i class="fas fa-chevron-down" style="position: absolute; right: 15px; top: 15px; color: #999; pointer-events: none;"></i>
            </div>
        </div>

        <div class="form-group">
            <label for="mux"><i class="fas fa-broadcast-tower"></i> Pilih Penyelenggara MUX</label>
            <div style="position: relative;">
                <select id="mux" disabled style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: #eee; appearance: none; cursor: not-allowed;">
                    <option value="">-- Menunggu Wilayah --</option>
                </select>
                <i class="fas fa-chevron-down" style="position: absolute; right: 15px; top: 15px; color: #999; pointer-events: none;"></i>
            </div>
        </div>
    </div>

    <div id="loading" style="display: none; text-align: center; margin: 20px 0;">
        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i>
        <p style="color: #666; margin-top: 10px;">Sedang memuat data...</p>
    </div>

    <div id="detail"></div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const provinsiSelect = document.getElementById("provinsi");
        const wilayahSelect = document.getElementById("wilayah");
        const muxSelect = document.getElementById("mux");
        const detailDiv = document.getElementById("detail");
        const loadingDiv = document.getElementById("loading");

        // --- 1. Saat Provinsi Dipilih ---
        provinsiSelect.addEventListener("change", function () {
            const provinsi = this.value;
            
            // Reset dropdown di bawahnya
            wilayahSelect.innerHTML = '<option value="">-- Silakan Pilih --</option>';
            wilayahSelect.disabled = true;
            wilayahSelect.style.background = "#eee";
            wilayahSelect.style.cursor = "not-allowed";
            
            muxSelect.innerHTML = '<option value="">-- Menunggu Wilayah --</option>';
            muxSelect.disabled = true;
            muxSelect.style.background = "#eee";
            muxSelect.style.cursor = "not-allowed";
            
            detailDiv.innerHTML = ""; // Bersihkan tabel

            if (provinsi) {
                loadingDiv.style.display = "block";
                
                // Panggil API get_wilayah
                fetch(`/get_wilayah?provinsi=${encodeURIComponent(provinsi)}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingDiv.style.display = "none";
                        wilayahSelect.disabled = false;
                        wilayahSelect.style.background = "#f9f9f9";
                        wilayahSelect.style.cursor = "pointer";

                        data.wilayah.forEach(w => {
                            const option = document.createElement("option");
                            option.value = w;
                            option.textContent = w;
                            wilayahSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        loadingDiv.style.display = "none";
                        alert("Gagal memuat wilayah.");
                    });
            }
        });

        // --- 2. Saat Wilayah Dipilih ---
        wilayahSelect.addEventListener("change", function () {
            const provinsi = provinsiSelect.value;
            const wilayah = this.value;

            // Reset dropdown MUX
            muxSelect.innerHTML = '<option value="">-- Silakan Pilih --</option>';
            muxSelect.disabled = true;
            muxSelect.style.background = "#eee";
            muxSelect.style.cursor = "not-allowed";
            
            detailDiv.innerHTML = ""; 

            if (wilayah) {
                loadingDiv.style.display = "block";

                // Panggil API get_mux
                fetch(`/get_mux?provinsi=${encodeURIComponent(provinsi)}&wilayah=${encodeURIComponent(wilayah)}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingDiv.style.display = "none";
                        muxSelect.disabled = false;
                        muxSelect.style.background = "#f9f9f9";
                        muxSelect.style.cursor = "pointer";

                        data.mux.forEach(m => {
                            const option = document.createElement("option");
                            option.value = m;
                            option.textContent = m;
                            muxSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        loadingDiv.style.display = "none";
                        console.error('Error:', error);
                    });
            }
        });

        // --- 3. Saat MUX Dipilih (Tampilkan Tabel) ---
        muxSelect.addEventListener("change", function () {
            const provinsi = provinsiSelect.value;
            const wilayah = wilayahSelect.value;
            const mux = this.value;

            detailDiv.innerHTML = ""; 

            if (mux) {
                loadingDiv.style.display = "block";

                // Panggil API get_siaran
                fetch(`/get_siaran?provinsi=${encodeURIComponent(provinsi)}&wilayah=${encodeURIComponent(wilayah)}&mux=${encodeURIComponent(mux)}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingDiv.style.display = "none";

                        // Buat Tabel HTML
                        let html = `
                            <div class="auth-card fade-in-up">
                                <h3 style="color: var(--primary); margin-bottom: 15px;">
                                    <i class="fas fa-tv"></i> Daftar Saluran
                                </h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem;">
                                    <strong><i class="fas fa-info-circle"></i> Info Pembaruan:</strong><br>
                                    Updated: ${data.last_updated_date} pukul ${data.last_updated_time}<br>
                                    Oleh: <strong>${data.last_updated_by_name}</strong>
                                </div>
                                
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--primary); color: white;">
                                            <th style="padding: 12px; text-align: left; border-radius: 8px 0 0 0;">No</th>
                                            <th style="padding: 12px; text-align: left; border-radius: 0 8px 0 0;">Nama Saluran</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        if (data.siaran.length > 0) {
                            data.siaran.forEach((siaran, index) => {
                                html += `
                                    <tr style="border-bottom: 1px solid #eee;">
                                        <td style="padding: 12px;">${index + 1}</td>
                                        <td style="padding: 12px; font-weight: 500;">${siaran}</td>
                                    </tr>
                                `;
                            });
                        } else {
                            html += `<tr><td colspan="2" style="padding: 20px; text-align: center;">Belum ada data siaran.</td></tr>`;
                        }

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;

                        detailDiv.innerHTML = html;
                    })
                    .catch(error => {
                        loadingDiv.style.display = "none";
                        console.error('Error:', error);
                        detailDiv.innerHTML = "<p style='color:red; text-align:center;'>Gagal mengambil data siaran.</p>";
                    });
            }
        });
    });
</script>

{% endblock %}
