{% extends "base.html" %}

{% block title %}Daftar Siaran TV Digital Indonesia{% endblock %}

{% block content %}
  <div class="container">
    <h1>üì∫ Daftar Siaran TV Digital</h1>

    <!-- Filter Provinsi -->
    <label for="provinsi">Pilih Provinsi:</label>
    <select id="provinsi">
      <option value="">-- Pilih Provinsi --</option>
      {% for p in provinsi_list %}
        <option value="{{ p }}">{{ p }}</option>
      {% endfor %}
    </select>

    <!-- Filter Wilayah -->
    <label for="wilayah">Pilih Wilayah:</label>
    <select id="wilayah">
      <option value="">-- Pilih Wilayah --</option>
    </select>

    <!-- Filter MUX -->
    <label for="mux">Pilih MUX:</label>
    <select id="mux">
      <option value="">-- Pilih MUX --</option>
    </select>

    <!-- Detail Siaran -->
    <div id="detail"></div>
  </div>

  <!-- Script -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Saat pilih provinsi
      document.getElementById("provinsi").addEventListener("change", function () {
        var provinsi = this.value;
    
        if (provinsi) {
          fetch("/get_wilayah?provinsi=" + provinsi)
            .then((response) => response.json())
            .then((data) => {
              var wilayahSelect = document.getElementById("wilayah");
              var muxSelect = document.getElementById("mux");
              var detailDiv = document.getElementById("detail");
    
              if (!data.wilayah || data.wilayah.length === 0) {
                wilayahSelect.innerHTML = '<option value="">-- Pilih Wilayah --</option>';
                muxSelect.innerHTML = '<option value="">-- Pilih MUX --</option>';
                detailDiv.innerHTML =
                  '<div class="alert">‚ö†Ô∏è Data siaran untuk provinsi ini belum ditambahkan. Silahkan <a href="/login">login</a> untuk menambahkan data siaran!</div>';
              } else {
                wilayahSelect.innerHTML = '<option value="">-- Pilih Wilayah --</option>';
                data.wilayah.forEach(function (w) {
                  var option = document.createElement("option");
                  option.value = w;
                  option.textContent = w;
                  wilayahSelect.appendChild(option);
                });
    
                muxSelect.innerHTML = '<option value="">-- Pilih MUX --</option>';
                detailDiv.innerHTML = "";
              }
            });
        } else {
          document.getElementById("wilayah").innerHTML = '<option value="">-- Pilih Wilayah --</option>';
          document.getElementById("mux").innerHTML = '<option value="">-- Pilih MUX --</option>';
          document.getElementById("detail").innerHTML = "";
        }
      });
    
      // Saat pilih wilayah
      document.getElementById("wilayah").addEventListener("change", function () {
        var provinsi = document.getElementById("provinsi").value;
        var wilayah = this.value;
    
        if (wilayah) {
          fetch("/get_mux?provinsi=" + provinsi + "&wilayah=" + wilayah)
            .then((response) => response.json())
            .then((data) => {
              var muxSelect = document.getElementById("mux");
              var detailDiv = document.getElementById("detail");
    
              if (!data.mux || data.mux.length === 0) {
                muxSelect.innerHTML = '<option value="">-- Pilih MUX --</option>';
                detailDiv.innerHTML =
                  '<div class="alert-siaran">‚ö†Ô∏è Data siaran untuk provinsi ini belum ditambahkan. Silahkan <a href="/login">login</a> untuk menambahkan data siaran!</div>';
              } else {
                muxSelect.innerHTML = '<option value="">-- Pilih MUX --</option>';
                data.mux.forEach(function (m) {
                  var option = document.createElement("option");
                  option.value = m;
                  option.textContent = m;
                  muxSelect.appendChild(option);
                });
                detailDiv.innerHTML = "";
              }
            });
        }
      });
    
      // Saat pilih mux
      document.getElementById("mux").addEventListener("change", function () {
        var provinsi = document.getElementById("provinsi").value;
        var wilayah = document.getElementById("wilayah").value;
        var mux = this.value;
    
        if (mux) {
          fetch("/get_siaran?provinsi=" + provinsi + "&wilayah=" + wilayah + "&mux=" + mux)
            .then((response) => response.json())
            .then((data) => {
              var detailDiv = document.getElementById("detail");
    
              if (!data.siaran || data.siaran.length === 0) {
                detailDiv.innerHTML =
                  '<div class="alert">‚ö†Ô∏è Data siaran untuk provinsi ini belum ditambahkan. Silahkan <a href="/login">login</a> untuk menambahkan data siaran!</div>';
              } else {
                var html = '<div class="card">';
                html += "<h3>üì° " + mux + "</h3>";
                html += "<p><strong>Update:</strong> " + (data.last_updated_date || "-") + " " + (data.last_updated_time || "") + "</p>";
                html += "<p><strong>Oleh:</strong> " + (data.last_updated_by_name || "-") + " (" + (data.last_updated_by_username || "-") + ")</p>";
                html += "<h4>üì∫ Daftar Siaran:</h4><ul>";
    
                data.siaran.forEach(function (s) {
                  html += "<li>" + s + "</li>";
                });
    
                html += "</ul></div>";
                detailDiv.innerHTML = html;
              }
            });
        }
      });
    });
  </script>
{% endblock %}
