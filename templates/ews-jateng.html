{% extends 'base.html' %}

{% block title %}EWS Bendungan & Cuaca Jateng - KTVDI{% endblock %}

{% block content %}
<style>
    /* 1. GLASSMORPHISM CARD */
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-color: #38bdf8;
    }

    /* 2. CARD ALERT STYLE (UNTUK STATUS BAHAYA) */
    .card-awas {
        border: 2px solid #ef4444 !important;
        background: linear-gradient(to bottom right, #fff1f2, #fff);
        animation: pulse-border 2s infinite;
    }
    @keyframes pulse-border {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* 3. ANIMASI AIR (WATER WAVE) */
    .water-container {
        position: relative;
        height: 120px; /* Lebih tinggi agar detail */
        width: 100%;
        overflow: hidden;
        border-radius: 16px;
        background: #f1f5f9; /* Warna langit mendung */
        margin-top: 1rem;
        border: 1px solid #e2e8f0;
    }
    
    .wave {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 200%;
        height: 100%;
        background-repeat: repeat-x;
        background-size: 50% 100%;
        opacity: 0.8;
        transform-origin: center bottom;
    }

    /* Variasi Warna & Tinggi Air Berdasarkan Status */
    .wave.normal { 
        background: linear-gradient(to top, #3b82f6 0%, #93c5fd 100%); 
        opacity: 0.6; height: 35%; 
        animation: wave-move 8s linear infinite; 
    }
    .wave.waspada { 
        background: linear-gradient(to top, #eab308 0%, #fde047 100%); 
        opacity: 0.75; height: 55%; 
        animation: wave-move 6s linear infinite; 
    }
    .wave.siaga { 
        background: linear-gradient(to top, #f97316 0%, #fdba74 100%); 
        opacity: 0.85; height: 70%; 
        animation: wave-move 4s linear infinite; 
    }
    .wave.awas { 
        background: linear-gradient(to top, #ef4444 0%, #fca5a5 100%); 
        opacity: 0.95; height: 90%; 
        animation: wave-move 2s linear infinite; /* Ombak lebih cepat */
    }
    
    @keyframes wave-move {
        0% { transform: translateX(0) scaleY(1); }
        50% { transform: translateX(-25%) scaleY(1.1); }
        100% { transform: translateX(-50%) scaleY(1); }
    }

    /* 4. SCROLLBAR HIDING */
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

    /* 5. TEXT OVERLAY ON WATER */
    .water-text {
        position: absolute;
        bottom: 10px;
        right: 10px;
        text-align: right;
        z-index: 20;
        text-shadow: 0 2px 4px rgba(255,255,255,0.8);
    }
</style>

<div class="min-h-screen bg-[#f0f9ff] py-24 px-4 font-['Plus_Jakarta_Sans']">
    <div class="max-w-7xl mx-auto">
        
        <div class="text-center mb-12">
            <div class="inline-flex items-center gap-2 bg-white border border-blue-200 text-blue-700 px-4 py-1.5 rounded-full text-xs font-bold shadow-sm mb-4">
                <span class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></span>
                PUSAT KOMANDO EWS JATENG
            </div>
            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 leading-tight mb-3">
                Monitoring <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-sky-500">Bendungan & Cuaca</span>
            </h1>
            <p class="text-slate-500 text-sm md:text-base max-w-2xl mx-auto">
                Sistem Peringatan Dini (Early Warning System) ketinggian air bendungan se-Jawa Tengah terintegrasi data BMKG.
            </p>
        </div>

        <div class="mb-12">
            <div class="flex justify-between items-end mb-4 px-2">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg"><i class="fa-solid fa-cloud-sun text-orange-400 mr-2"></i>Cuaca Terkini</h3>
                    <p class="text-xs text-slate-400">Data BMKG Jawa Tengah (Geser untuk melihat)</p>
                </div>
            </div>
            
            <div class="hide-scroll flex gap-4 overflow-x-auto pb-4 snap-x cursor-grab active:cursor-grabbing">
                {% for c in cuaca_list %}
                <div class="min-w-[140px] bg-white p-5 rounded-2xl border border-slate-100 shadow-sm snap-center flex flex-col items-center text-center group hover:border-blue-400 transition-all">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">{{ c.kota }}</p>
                    <div class="text-4xl text-blue-500 my-2 transform group-hover:scale-110 transition-transform duration-300">
                        <i class="fa-solid {{ c.icon }}"></i>
                    </div>
                    <div class="text-2xl font-black text-slate-800">{{ c.suhu }}¬∞C</div>
                    <div class="text-[10px] font-bold text-slate-500 bg-slate-50 px-3 py-1 rounded-full mt-2 border border-slate-200 w-full">{{ c.cuaca }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="sticky top-20 z-40 mb-10">
            <div class="relative max-w-2xl mx-auto">
                <div class="absolute inset-0 bg-blue-400 rounded-full blur-md opacity-20"></div>
                <div class="relative bg-white rounded-full shadow-xl border border-slate-100 flex items-center px-6 py-4">
                    <i class="fa-solid fa-magnifying-glass text-blue-500 text-xl mr-4"></i>
                    <input type="text" id="searchDam" placeholder="Cari Bendungan (Contoh: Gajah Mungkur, Wadaslintang)..." class="w-full bg-transparent focus:outline-none text-slate-700 font-bold placeholder:font-normal placeholder:text-slate-400 text-sm md:text-base">
                </div>
            </div>
        </div>

        {% if dams %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="damContainer">
            {% for dam in dams %}
            
            {% set status_code = 'normal' %}
            {% set color = 'blue' %}
            {% set wave_class = 'normal' %}
            {% set card_class = '' %}
            {% set icon_status = 'fa-circle-check' %}
            
            {% if dam.status_alert == 'Siaga 1' or dam.status_alert == 'Awas' %}
                {% set status_code = 'AWAS' %}
                {% set color = 'red' %}
                {% set wave_class = 'awas' %}
                {% set card_class = 'card-awas' %}
                {% set icon_status = 'fa-triangle-exclamation' %}
            {% elif dam.status_alert == 'Siaga 2' or dam.status_alert == 'Siaga' %}
                {% set status_code = 'SIAGA' %}
                {% set color = 'orange' %}
                {% set wave_class = 'siaga' %}
                {% set icon_status = 'fa-bell' %}
            {% elif dam.status_alert == 'Siaga 3' or dam.status_alert == 'Waspada' %}
                {% set status_code = 'WASPADA' %}
                {% set color = 'yellow' %}
                {% set wave_class = 'waspada' %}
                {% set icon_status = 'fa-circle-exclamation' %}
            {% else %}
                {% set status_code = 'NORMAL' %}
            {% endif %}

            <div class="glass-card rounded-3xl p-5 dam-item group {{ card_class }} flex flex-col h-full">
                
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="flex items-center gap-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">
                            <i class="fa-solid fa-location-dot text-{{ color }}-500"></i> {{ dam.regency_name if dam.regency_name else 'Jawa Tengah' }}
                        </div>
                        <h3 class="text-lg font-extrabold text-slate-800 leading-tight line-clamp-2 dam-name">{{ dam.name }}</h3>
                    </div>
                    <span class="status-badge bg-{{ color }}-100 text-{{ color }}-700 border border-{{ color }}-200 flex items-center gap-1">
                        <i class="fa-solid {{ icon_status }}"></i> {{ status_code }}
                    </span>
                </div>

                <div class="water-container">
                    <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(#000 1px, transparent 1px); background-size: 100% 20px;"></div>
                    
                    <div class="wave {{ wave_class }}"></div>
                    
                    <div class="water-text">
                        <p class="text-[10px] font-bold text-slate-600 uppercase mb-0.5">Tinggi Muka Air</p>
                        <p class="text-3xl font-black text-slate-800 leading-none drop-shadow-sm">
                            {{ dam.tma if dam.tma else '0' }}<span class="text-sm font-bold text-slate-500 ml-1">m</span>
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4">
                    <div class="bg-slate-50 p-2.5 rounded-xl border border-slate-100 text-center">
                        <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Outflow (Keluar)</p>
                        <p class="text-sm font-bold text-blue-600">{{ dam.outflow_q if dam.outflow_q else '0' }} <span class="text-[8px]">m¬≥/s</span></p>
                    </div>
                    <div class="bg-slate-50 p-2.5 rounded-xl border border-slate-100 text-center">
                        <p class="text-[9px] text-slate-400 uppercase font-bold mb-1">Inflow (Masuk)</p>
                        <p class="text-sm font-bold text-green-600">{{ dam.inflow_q if dam.inflow_q else '0' }} <span class="text-[8px]">m¬≥/s</span></p>
                    </div>
                </div>

                <div class="mt-auto pt-4">
                    <details class="group/edu text-xs">
                        <summary class="font-bold text-brand-blue cursor-pointer list-none flex justify-between items-center bg-blue-50/50 p-2 rounded-lg hover:bg-blue-50 transition">
                            <span><i class="fa-solid fa-circle-info mr-1"></i> Apa artinya?</span>
                            <i class="fa-solid fa-chevron-down transition-transform group-open/edu:rotate-180 text-blue-400"></i>
                        </summary>
                        <div class="mt-2 text-slate-600 leading-relaxed bg-white p-2 rounded-lg border border-blue-50 text-[11px]">
                            {% if status_code == 'NORMAL' %}
                                <p class="text-green-600 font-bold mb-1">‚úÖ Kondisi Aman</p>
                                <p>Volume air stabil. Tidak ada ancaman banjir bagi warga sekitar sungai.</p>
                            {% elif status_code == 'WASPADA' %}
                                <p class="text-yellow-600 font-bold mb-1">‚ö†Ô∏è Hati-Hati</p>
                                <p>Air mulai naik. Warga di bantaran sungai harap waspada terhadap arus deras.</p>
                            {% else %}
                                <p class="text-red-600 font-bold mb-1">üö® BAHAYA / EVAKUASI</p>
                                <p>Pintu air dibuka penuh! Potensi banjir besar. Ikuti arahan petugas BPBD/SAR segera!</p>
                            {% endif %}
                        </div>
                    </details>
                    
                    <div class="mt-3 flex justify-between items-center text-[9px] text-slate-400 border-t border-slate-100 pt-2">
                        <span><i class="fa-regular fa-clock"></i> Update: {{ dam.updated_at_wib if dam.updated_at_wib else 'Hari ini' }}</span>
                        <span class="font-bold text-brand-navy">EWS JATENG</span>
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center py-20 bg-white rounded-[2rem] shadow-sm border border-slate-100 text-center p-8">
            <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mb-6">
                <i class="fa-solid fa-signal-stream-slash text-red-400 text-3xl animate-pulse"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800">Koneksi Data Terputus</h3>
            <p class="text-slate-500 text-sm mb-6 max-w-md">
                Maaf Ndan, server EWS Jawa Tengah sedang tidak dapat dihubungi. Data bendungan tidak tampil, namun Ndan tetap bisa memantau Cuaca di atas.
            </p>
            <button onclick="location.reload()" class="px-8 py-3 bg-brand-navy text-white rounded-full font-bold shadow-lg hover:bg-brand-blue transition transform hover:scale-105">
                <i class="fa-solid fa-rotate-right mr-2"></i> Coba Muat Ulang
            </button>
        </div>
        {% endif %}

    </div>
</div>

<script>
    // Search Functionality (Real-time Filtering)
    document.getElementById('searchDam').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let items = document.querySelectorAll('.dam-item');
        
        items.forEach(function(item) {
            let name = item.querySelector('.dam-name').textContent.toLowerCase();
            let location = item.innerText.toLowerCase(); // Search also in location text
            
            if (name.includes(filter) || location.includes(filter)) {
                item.style.display = "";
            } else {
                item.style.display = "none";
            }
        });
    });
</script>
{% endblock %}
