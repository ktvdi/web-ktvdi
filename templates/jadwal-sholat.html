{% extends 'base.html' %}

{% block title %}Jadwal Sholat & Imsakiyah - KTVDI{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
    /* === THEME: RAMADAN ULTRA GLASS iOS 26.2 === */
    :root {
        --glass-bg: rgba(255, 255, 255, 0.65);
        --glass-border: rgba(255, 255, 255, 0.4);
        --primary-emerald: #059669;
        --gold-accent: #d97706;
    }

    body {
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%);
        background-attachment: fixed;
    }

    .font-amiri { font-family: 'Amiri', serif; }

    /* Pattern Latar Belakang Halus */
    .bg-arabesque {
        position: fixed; inset: 0; pointer-events: none; z-index: -1;
        background-image: url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23059669' fill-opacity='0.04'%3E%3Cpath d='M40 40c0-8.8-7.2-16-16-16S8 31.2 8 40s7.2 16 16 16 16-7.2 16-16zm0 0c0 8.8 7.2 16 16 16s16-7.2 16-16-7.2-16-16-16-16 7.2-16 16z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    /* GLASS CARD SYSTEM */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        border-radius: 28px;
    }

    /* ORNAMEN LAMPION (ANIMASI) */
    .lantern-container { position: absolute; top: -20px; width: 100%; height: 150px; overflow: hidden; pointer-events: none; z-index: 0; }
    .lantern {
        position: absolute; top: 0;
        filter: drop-shadow(0 10px 15px rgba(245, 158, 11, 0.5));
        animation: swing ease-in-out infinite alternate;
        transform-origin: top center;
    }
    .l-1 { right: 10%; width: 50px; animation-duration: 3s; }
    .l-2 { right: 25%; width: 35px; top: -10px; animation-duration: 4s; opacity: 0.8; }
    .l-3 { left: 10%; width: 60px; animation-duration: 3.5s; }
    @keyframes swing { 0% { transform: rotate(3deg); } 100% { transform: rotate(-3deg); } }

    /* CITY GLIDER (SCROLL SNAP UI) */
    .city-glider-wrapper {
        position: relative;
        mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
    }
    .city-glider {
        display: flex; gap: 0.75rem; overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding: 0.5rem 1rem;
        scrollbar-width: none; /* Hide scrollbar Firefox */
    }
    .city-glider::-webkit-scrollbar { display: none; } /* Hide Chrome */
    
    .city-pill {
        flex: 0 0 auto; scroll-snap-align: center;
        padding: 0.75rem 1.5rem;
        border-radius: 99px;
        background: rgba(255,255,255,0.6);
        border: 1px solid rgba(255,255,255,0.8);
        color: #475569; font-weight: 600; font-size: 0.9rem;
        cursor: pointer; transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    .city-pill.active {
        background: linear-gradient(135deg, #059669, #047857);
        color: white; border-color: transparent;
        box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
        transform: scale(1.05);
    }

    /* FLIP CARD SYSTEM (RAMADAN KNOWLEDGE) */
    .flip-grid { perspective: 1000px; }
    .flip-card {
        background-color: transparent;
        height: 200px; /* Tinggi kartu */
        perspective: 1000px; cursor: pointer;
    }
    .flip-card-inner {
        position: relative; width: 100%; height: 100%;
        text-align: center; transition: transform 0.8s;
        transform-style: preserve-3d;
        border-radius: 24px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    }
    .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
    
    .flip-front, .flip-back {
        position: absolute; width: 100%; height: 100%;
        -webkit-backface-visibility: hidden; backface-visibility: hidden;
        border-radius: 24px; display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        padding: 1.5rem;
        border: 1px solid rgba(255,255,255,0.5);
    }
    
    /* Front: Glassy Emerald */
    .flip-front {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(20px);
    }
    /* Back: Solid White/Gradient */
    .flip-back {
        background: linear-gradient(135deg, #f0fdf4, #fff);
        transform: rotateY(180deg);
        overflow-y: auto;
    }

    /* PRAYER TIME CARD */
    .time-card.active {
        background: linear-gradient(135deg, #d97706, #b45309); /* Gold Active */
        color: white; border: none;
        box-shadow: 0 10px 25px rgba(217, 119, 6, 0.4);
        transform: translateY(-5px);
    }
    .time-card.active .label { color: #fef3c7; }
</style>

<div class="bg-arabesque"></div>

<div class="lantern-container relative max-w-6xl mx-auto">
    <img src="https://cdn-icons-png.flaticon.com/512/3655/3655562.png" class="lantern l-1" alt="Lampion">
    <img src="https://cdn-icons-png.flaticon.com/512/3655/3655562.png" class="lantern l-2" alt="Lampion">
    <img src="https://cdn-icons-png.flaticon.com/512/3655/3655562.png" class="lantern l-3 hidden md:block" alt="Lampion">
</div>

<div class="min-h-screen py-10 px-4 pb-32">
    <div class="max-w-6xl mx-auto relative z-10">
        
        <div class="text-center mb-10 mt-6">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-emerald-100/80 backdrop-blur-md border border-emerald-200 text-emerald-800 text-[10px] font-bold tracking-widest uppercase mb-4 shadow-sm">
                <i class="fa-solid fa-moon"></i> Ramadan 1447 H Special
            </div>
            <h1 class="text-4xl md:text-6xl font-bold text-emerald-950 font-amiri mb-2 drop-shadow-sm">
                Jadwal Sholat & Imsakiyah
            </h1>
            <p class="text-emerald-700 font-medium opacity-80">Raih Keberkahan di Bulan Suci Penuh Ampunan</p>
        </div>

        <div class="glass-card p-6 mb-10">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <h3 class="text-lg font-bold text-emerald-900 flex items-center gap-2">
                    <i class="fa-solid fa-map-location-dot"></i> Pilih Kota Anda
                </h3>
                <div class="relative w-full md:w-64">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
                    <input type="text" id="citySearch" placeholder="Cari kota..." class="w-full pl-9 pr-4 py-2 rounded-xl bg-white/50 border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-sm transition font-medium">
                </div>
            </div>

            <div class="city-glider-wrapper">
                <div class="city-glider" id="cityGliderContainer">
                    <div class="city-pill active" onclick="alert('Memuat...')">Memuat Data Kota...</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-12">
            <div class="glass-card p-8 lg:col-span-1 bg-gradient-to-br from-emerald-800 to-teal-900 text-white flex flex-col justify-center items-center text-center relative overflow-hidden">
                <div class="absolute inset-0 opacity-10" style="background-image: url('https://www.transparenttextures.com/patterns/cubes.png');"></div>
                
                <div id="countdownContent" class="relative z-10">
                    <p class="text-emerald-200 text-xs font-bold uppercase tracking-widest mb-2">Menuju Waktu <span id="nextPrayerName" class="text-yellow-400">...</span></p>
                    <div class="text-6xl font-mono font-bold tracking-tight mb-4 drop-shadow-lg" id="countdownTimer">--:--:--</div>
                    
                    <div id="prePrayerAlert" class="hidden animate-bounce mt-4">
                        <span class="px-3 py-1 bg-yellow-500/20 border border-yellow-400/50 rounded-lg text-yellow-300 text-xs font-bold">
                            <i class="fa-solid fa-bell mr-1"></i> <span id="prePrayerMessage"></span>
                        </span>
                    </div>

                    <div id="locationBadge" class="mt-8 inline-flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full backdrop-blur-md border border-white/10 text-sm">
                        <i class="fa-solid fa-location-dot text-red-400"></i> <span id="currentCityDisplay" class="font-bold">Jakarta</span>
                    </div>
                </div>

                <div id="scheduleLoading" class="hidden absolute inset-0 bg-emerald-900 z-50 flex flex-col justify-center items-center">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl text-emerald-200"></i>
                    <p class="text-xs mt-2 text-emerald-200">Sinkronisasi Jadwal...</p>
                </div>
            </div>

            <div class="glass-card p-8 lg:col-span-2 flex flex-col justify-center">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="prayerGrid">
                    </div>
                <div class="mt-6 text-center text-[10px] text-slate-500">
                    <i class="fa-solid fa-info-circle"></i> Jadwal berdasarkan metode Kemenag RI (20Â°). Ditambah 2 menit waktu ihtiyati.
                </div>
            </div>
        </div>

        <div class="mb-12">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-emerald-900 font-amiri"><i class="fa-solid fa-book-quran mr-2 text-emerald-600"></i> Khazanah Ramadan</h2>
                <span class="text-xs text-slate-500 hidden md:block">Ketuk kartu untuk membaca</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 flip-grid" id="flipContainer">
                </div>
        </div>

        <div class="glass-card p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 via-yellow-400 to-emerald-400"></div>
            <i class="fa-solid fa-quote-left text-4xl text-emerald-100 absolute top-4 left-4"></i>
            
            <div id="quoteCarousel" class="h-20 flex items-center justify-center relative z-10">
                <p class="text-lg md:text-xl text-emerald-900 font-serif italic leading-relaxed transition-opacity duration-500" id="quoteText">
                    "Memuat pesan persaudaraan..."
                </p>
            </div>
            
            <div class="mt-4 flex justify-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                <span class="w-2 h-2 rounded-full bg-emerald-300"></span>
                <span class="w-2 h-2 rounded-full bg-emerald-300"></span>
            </div>
        </div>

    </div>
</div>

<script type="application/json" id="cityData">
    {{ daftar_kota | tojson }}
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    // --- 1. DATA KNOWLEDGE RAMADAN (FLIP CONTENT) ---
    const ramadanKnowledge = [
        {
            title: "Keutamaan Sahur",
            icon: "fa-utensils",
            content: "Sahur bukan sekadar makan, tapi ibadah penuh berkah. Rasulullah SAW bersabda: 'Makan sahurlah kalian, karena sesungguhnya dalam sahur itu terdapat keberkahan.' (HR. Bukhari & Muslim). Sahur memberi energi dan membedakan puasa kita dengan umat terdahulu."
        },
        {
            title: "Tingkatan Puasa",
            icon: "fa-stairs",
            content: "Imam Al-Ghazali membagi puasa menjadi 3: (1) Puasa Umum (menahan perut & syahwat), (2) Puasa Khusus (menahan pendengaran, penglihatan, lisan, tangan dari dosa), (3) Puasa Khususul Khusus (menahan hati dari selain Allah)."
        },
        {
            title: "Malam Lailatul Qadar",
            icon: "fa-moon",
            content: "Malam yang lebih baik dari seribu bulan. Terjadi pada malam ganjil di 10 hari terakhir Ramadan. Perbanyaklah i'tikaf, sholat malam, dan doa: 'Allahumma innaka 'afuwwun tuhibbul 'afwa fa'fu 'anni'."
        },
        {
            title: "Zakat Fitrah",
            icon: "fa-hand-holding-dollar",
            content: "Wajib dikeluarkan sebelum Sholat Idul Fitri. Tujuannya untuk mensucikan orang yang berpuasa dari ucapan sia-sia dan perbuatan keji, serta memberi makan kepada orang miskin agar mereka juga bahagia di hari raya."
        },
        {
            title: "Puasa & Kesehatan",
            icon: "fa-heart-pulse",
            content: "Secara medis, puasa (autophagy) membantu detoksifikasi tubuh, meregenerasi sel imun, menstabilkan gula darah, dan menurunkan kolesterol jahat. Puasa adalah 'reset' alami bagi sistem pencernaan tubuh manusia."
        },
        {
            title: "Adab Berbuka",
            icon: "fa-glass-water",
            content: "Segerakan berbuka saat matahari terbenam. Awali dengan Bismillah, makan kurma basah (ruthab) atau kurma kering (tamr), atau seteguk air. Jangan langsung makan besar agar lambung tidak kaget. Berdoalah, karena doa saat berbuka mustajab."
        },
        {
            title: "Menjaga Lisan",
            icon: "fa-comment-slash",
            content: "Puasa tidak sah sempurna jika lisan masih berdusta atau menggunjing. Rasulullah bersabda: 'Barangsiapa tidak meninggalkan perkataan dusta dan malah mengamalkannya, maka Allah tidak butuh dari rasa lapar dan hausnya.'"
        },
        {
            title: "Sedekah di Ramadan",
            icon: "fa-gift",
            content: "Rasulullah adalah orang yang paling dermawan, dan beliau lebih dermawan lagi di bulan Ramadan. Pahala sedekah dilipatgandakan. Memberi bukaan (takjil) kepada orang berpuasa pahalanya sama dengan orang yang berpuasa tersebut."
        },
        {
            title: "Persaudaraan (Ukhuwah)",
            icon: "fa-handshake",
            content: "Ramadan momentum mempererat silaturahmi. Maafkan kesalahan saudara, teman, dan tetangga. Hilangkan dendam. 'Tidak halal bagi seorang muslim mendiamkan saudaranya lebih dari 3 hari.' Jadikan Ramadan bulan rekonsiliasi hati."
        }
    ];

    // --- 2. GENERATE CONTENT ---

    // A. City Glider
    const cities = JSON.parse(document.getElementById('cityData').textContent);
    const gliderContainer = document.getElementById('cityGliderContainer');
    const citySearch = document.getElementById('citySearch');

    function renderCities(filterText = '') {
        gliderContainer.innerHTML = '';
        const filtered = cities.filter(c => c.toLowerCase().includes(filterText.toLowerCase()));
        
        if(filtered.length === 0) {
            gliderContainer.innerHTML = '<div class="text-sm text-slate-500 py-2">Kota tidak ditemukan</div>';
            return;
        }

        filtered.forEach((city, index) => {
            const pill = document.createElement('div');
            pill.className = `city-pill ${index === 0 && filterText === '' ? 'active' : ''}`; // Default active first
            pill.innerText = city;
            pill.onclick = () => {
                document.querySelectorAll('.city-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                loadJadwal(city);
            };
            gliderContainer.appendChild(pill);
        });
    }

    renderCities(); // Init
    citySearch.addEventListener('input', (e) => renderCities(e.target.value));

    // B. Flip Cards
    const flipContainer = document.getElementById('flipContainer');
    ramadanKnowledge.forEach(item => {
        const cardHTML = `
            <div class="flip-card" onclick="this.classList.toggle('flipped')">
                <div class="flip-card-inner">
                    <div class="flip-front">
                        <i class="fa-solid ${item.icon} text-4xl text-emerald-500 mb-3"></i>
                        <h3 class="font-bold text-lg text-emerald-900 font-amiri">${item.title}</h3>
                        <p class="text-xs text-slate-400 mt-2">(Ketuk untuk membaca)</p>
                    </div>
                    <div class="flip-back">
                        <h4 class="font-bold text-emerald-800 mb-2 border-b border-emerald-200 pb-1">${item.title}</h4>
                        <p class="text-sm text-slate-700 leading-snug">${item.content}</p>
                    </div>
                </div>
            </div>
        `;
        flipContainer.innerHTML += cardHTML;
    });

    // C. Quotes Carousel
    const quotes = [
        "Integritas adalah melakukan hal yang benar, bahkan ketika tidak ada orang yang melihat.",
        "Perbedaan adalah rahmat. Mari saling menghargai dan merajut tali persaudaraan.",
        "Senyummu di hadapan saudaramu adalah sedekah.",
        "Maka dirikanlah shalat, sesungguhnya shalat itu adalah kewajiban yang ditentukan waktunya. (QS. An-Nisa: 103)",
        "Puasa itu perisai, yang membentengi hamba dari api neraka.",
        "Sebaik-baik manusia adalah yang paling bermanfaat bagi orang lain."
    ];
    let qIdx = 0;
    setInterval(() => {
        const el = document.getElementById('quoteText');
        el.style.opacity = 0;
        setTimeout(() => {
            qIdx = (qIdx + 1) % quotes.length;
            el.innerText = `"${quotes[qIdx]}"`;
            el.style.opacity = 1;
        }, 500);
    }, 6000);

    // --- 3. JADWAL SHOLAT LOGIC ---
    let countdownInterval;

    function loadJadwal(city) {
        document.getElementById('scheduleLoading').classList.remove('hidden');
        document.getElementById('currentCityDisplay').innerText = city;

        const date = new Date();
        const url = `https://api.aladhan.com/v1/timingsByCity/${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}?city=${city}&country=Indonesia&method=20`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                const t = data.data.timings;
                renderPrayerGrid(t);
                startCountdown(t);
                document.getElementById('scheduleLoading').classList.add('hidden');
            })
            .catch(err => {
                alert('Gagal memuat jadwal. Cek koneksi internet.');
                document.getElementById('scheduleLoading').classList.add('hidden');
            });
    }

    function renderPrayerGrid(t) {
        const grid = document.getElementById('prayerGrid');
        const prayers = [
            { id: 'Imsak', name: 'IMSAK', time: t.Imsak },
            { id: 'Fajr', name: 'SUBUH', time: t.Fajr },
            { id: 'Dhuhr', name: 'DZUHUR', time: t.Dhuhr },
            { id: 'Asr', name: 'ASHAR', time: t.Asr },
            { id: 'Maghrib', name: 'MAGHRIB', time: t.Maghrib },
            { id: 'Isha', name: 'ISYA', time: t.Isha }
        ];

        let html = '';
        prayers.forEach(p => {
            html += `
                <div id="card-${p.id}" class="time-card bg-white p-4 rounded-2xl text-center shadow-sm border border-slate-100 transition-transform duration-300">
                    <div class="label text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">${p.name}</div>
                    <div class="text-2xl font-black text-slate-800 font-amiri">${p.time}</div>
                </div>
            `;
        });
        grid.innerHTML = html;
    }

    function startCountdown(timings) {
        if (countdownInterval) clearInterval(countdownInterval);

        const prayers = [
            { name: "IMSAK", time: timings.Imsak, id: 'card-Imsak' },
            { name: "SUBUH", time: timings.Fajr, id: 'card-Fajr' },
            { name: "DZUHUR", time: timings.Dhuhr, id: 'card-Dhuhr' },
            { name: "ASHAR", time: timings.Asr, id: 'card-Asr' },
            { name: "MAGHRIB", time: timings.Maghrib, id: 'card-Maghrib' },
            { name: "ISYA", time: timings.Isha, id: 'card-Isha' }
        ];

        countdownInterval = setInterval(() => {
            const now = new Date();
            let nextPrayer = null;
            let minDiff = Infinity;

            // Reset Active Cards
            document.querySelectorAll('.time-card').forEach(el => el.classList.remove('active'));

            for (let p of prayers) {
                const [h, m] = p.time.split(':');
                const pTime = new Date();
                pTime.setHours(h, m, 0);
                let diff = pTime - now;

                if (diff > 0 && diff < minDiff) {
                    minDiff = diff;
                    nextPrayer = p;
                }
            }

            if (!nextPrayer) { 
                nextPrayer = prayers[0]; // Besok Imsak
                const [h, m] = nextPrayer.time.split(':');
                const pTime = new Date();
                pTime.setDate(pTime.getDate() + 1);
                pTime.setHours(h, m, 0);
                minDiff = pTime - now;
            }

            // Highlight Next Prayer
            const activeCard = document.getElementById(nextPrayer.id);
            if(activeCard) activeCard.classList.add('active');

            // Countdown Logic
            const hh = Math.floor((minDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mm = Math.floor((minDiff % (1000 * 60 * 60)) / (1000 * 60));
            const ss = Math.floor((minDiff % (1000 * 60)) / 1000);

            document.getElementById('countdownTimer').innerText = `${hh.toString().padStart(2, '0')}:${mm.toString().padStart(2, '0')}:${ss.toString().padStart(2, '0')}`;
            document.getElementById('nextPrayerName').innerText = nextPrayer.name;

            // Pre-Prayer Alert
            const msgBox = document.getElementById('prePrayerAlert');
            const minutesLeft = Math.floor(minDiff / 60000);

            if (minutesLeft <= 10) {
                msgBox.classList.remove('hidden');
                document.getElementById('prePrayerMessage').innerText = `Sebentar lagi masuk waktu ${nextPrayer.name}. Siapkan diri.`;
            } else {
                msgBox.classList.add('hidden');
            }

        }, 1000);
    }

    // Load default (Jakarta)
    loadJadwal('Jakarta');

</script>
{% endblock %}
