{% extends 'base.html' %}

{% block title %}Khazanah Islam - KTVDI{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
<script src="https://cdn.tailwindcss.com"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

<style>
    /* =========================================
       THEME CONFIGURATION: ROYAL NAVY & GOLD
       ========================================= */
    :root {
        --c-navy-dark: #02040a;      /* Background Utama (Sangat Gelap) */
        --c-navy-card: #0b1120;      /* Card Background */
        --c-navy-light: #1e293b;     /* Input/Hover */
        
        --c-gold-main: #d4af37;      /* Emas Klasik */
        --c-gold-light: #fcd34d;     /* Emas Terang */
        --c-gold-dim: #785e10;       /* Emas Gelap */
        
        --c-text-main: #f8fafc;
        --c-text-muted: #94a3b8;
        
        --glass-border: 1px solid rgba(212, 175, 55, 0.15);
        --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    body {
        background-color: var(--c-navy-dark);
        /* Islamic Geometric Pattern Overlay (Subtle) */
        background-image: radial-gradient(circle at 50% 50%, rgba(11, 17, 32, 0.8), #02040a), 
                          url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4af37' fill-opacity='0.03'%3E%3Cpath d='M40 40c0-8.8-7.2-16-16-16S8 31.2 8 40s7.2 16 16 16 16-7.2 16-16zm0 0c0 8.8 7.2 16 16 16s16-7.2 16-16-7.2-16-16-16-16 7.2-16 16z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        color: var(--c-text-main);
        font-family: 'Plus Jakarta Sans', sans-serif;
        overflow-x: hidden;
    }

    .font-arab { font-family: 'Amiri', serif; line-height: 2.2; }
    .font-luxury { font-family: 'Cinzel', serif; }

    /* --- COMPONENT STYLES --- */
    
    /* Card Design */
    .islamic-card {
        background: var(--c-navy-card);
        border: var(--glass-border);
        border-radius: 16px;
        box-shadow: var(--glass-shadow);
        position: relative;
        overflow: hidden;
        transition: transform 0.3s ease, border-color 0.3s ease;
    }
    .islamic-card:hover {
        border-color: rgba(212, 175, 55, 0.4);
    }
    
    /* Gold Gradient Text */
    .text-gold-gradient {
        background: linear-gradient(to right, #bf953f, #fcf6ba, #bf953f);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
    }

    /* Animations */
    @keyframes pulse-gold {
        0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
        100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
    }
    .pulse-active { animation: pulse-gold 2s infinite; }

    /* Prayer Times Grid */
    .prayer-time-box {
        background: rgba(255,255,255,0.02);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    .prayer-time-box.active {
        background: linear-gradient(135deg, var(--c-gold-dim), var(--c-gold-main));
        border-color: var(--c-gold-light);
        color: #000;
        transform: translateY(-5px);
    }
    .prayer-time-box.active h4, .prayer-time-box.active p { color: #02040a; font-weight: 800; }

    /* Toast Notification */
    .toast-pro {
        position: fixed; top: 100px; right: -400px;
        background: rgba(11, 17, 32, 0.95);
        border-left: 4px solid var(--c-gold-main);
        backdrop-filter: blur(10px);
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        z-index: 9999;
        transition: right 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        display: flex; align-items: center; gap: 15px;
        max-width: 90vw;
    }
    .toast-pro.show { right: 20px; }
    
    /* Loading Scan Effect */
    .gps-scan {
        position: relative;
    }
    .gps-scan::after {
        content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
        border: 2px solid var(--c-gold-main); border-radius: 50%;
        opacity: 0; animation: ripple 1.5s infinite;
    }
    @keyframes ripple { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.5); opacity: 0; } }

    /* Custom Select Style for Default Browser Dropdown */
    #kotaSelect {
        background-color: var(--c-navy-light);
        color: white;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        appearance: auto; /* Force default arrow */
    }
    #kotaSelect:focus {
        outline: none;
        border-color: var(--c-gold-main);
    }

</style>

<div class="pt-[140px] pb-20 px-4 max-w-7xl mx-auto min-h-screen">

    <div id="prayerToast" class="toast-pro">
        <div class="text-3xl text-gold-main"><i class="fa-solid fa-mosque"></i></div>
        <div>
            <h4 class="text-white font-bold text-sm uppercase tracking-wider mb-1" id="toastTitle">Peringatan Waktu</h4>
            <p class="text-slate-300 text-xs" id="toastMessage">Waktu sholat segera tiba.</p>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row justify-between items-center lg:items-end mb-10 border-b border-white/10 pb-6 gap-6 text-center lg:text-left">
        <div>
            <h1 class="text-4xl md:text-5xl font-luxury text-white mb-2 drop-shadow-xl flex flex-col md:flex-row items-center gap-2 md:gap-3">
                <span class="bg-[#d4af37]/10 p-2 md:p-3 rounded-xl border border-[#d4af37]/30">
                    <i class="fa-solid fa-kaaba text-[#d4af37] drop-shadow-md"></i>
                </span>
                <span>Pojok <span class="text-gold-gradient">Religi/span></span>
            </h1>
            <p class="text-slate-400 text-xs md:text-sm tracking-[0.2em] uppercase pl-1 mt-2">Menyajikan informasi religi bagi Sobat KTVDI</p>
            <p class="text-[#d4af37] text-xs md:text-sm italic mt-1">Kedamaian untuk seluruh umat manusia, rahmat bagi semesta ala.</p>
        </div>

        <div class="w-full lg:w-auto flex flex-col gap-2">
            <label class="text-[10px] uppercase text-slate-500 font-bold tracking-widest lg:text-right hidden lg:block">Lokasi Anda</label>
            <div class="flex items-center w-full lg:w-[320px] transition gap-2">
                <div id="gpsIcon" class="w-10 h-10 rounded-full bg-[#1e293b] border border-slate-700 flex items-center justify-center text-[#d4af37] shrink-0 gps-scan cursor-pointer" onclick="forceGPS()" title="Sinkronkan dengan Lokasi Saat Ini">
                    <i class="fa-solid fa-location-crosshairs"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <select id="kotaSelect" class="w-full text-sm">
                        <option value="" disabled selected>Pilih Kota/Kabupaten...</option>
                        {% for kota in daftar_kota %}
                        <option value="{{ kota.id }}">{{ kota.nama }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div id="locStatus" class="text-[10px] lg:text-right text-center text-[#d4af37] h-4 italic">Memeriksa ketersediaan GPS...</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-12">
        <div class="lg:col-span-8 islamic-card p-8 flex flex-col justify-between min-h-[300px] relative">
            <div class="absolute top-0 right-0 opacity-10 text-9xl text-white transform translate-x-10 -translate-y-10 pointer-events-none">
                <i class="fa-solid fa-clock"></i>
            </div>

            <div class="flex justify-between items-start z-10">
                <div>
                    <span class="block text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Tanggal Hari Ini</span>
                    <div class="text-xl md:text-2xl font-luxury text-white" id="hijriDate">{{ hijri_date }}</div>
                    <div class="text-sm text-[#d4af37]" id="dateMasehi">...</div>
                </div>
                <div class="text-right">
                    <span class="block text-slate-500 text-[10px] uppercase font-bold tracking-widest">Lokasi Terkunci</span>
                    <div class="text-white font-bold" id="currentCityLabel">...</div>
                    <div class="text-xs text-[#d4af37] mt-1 hidden" id="currentKecamatanLabel"></div>
                </div>
            </div>

            <div class="text-center z-10 py-8 min-h-[160px] flex flex-col justify-center">
                <p class="text-slate-400 text-xs md:text-sm uppercase tracking-[0.2em] mb-4">
                    <span id="prayerLabelText">Menuju Waktu </span>
                    <span id="nextPrayerName" class="text-white font-bold">...</span>
                </p>
                <div id="countdown" class="text-6xl md:text-8xl font-bold text-gold-gradient tabular-nums tracking-tight font-luxury drop-shadow-md">--:--:--</div>
            </div>

            <div class="w-full bg-slate-800 h-1 rounded-full overflow-hidden mt-4">
                <div id="timeProgressBar" class="h-full bg-[#d4af37] w-0 transition-all duration-1000 ease-linear shadow-[0_0_15px_#d4af37]"></div>
            </div>
        </div>

        <div class="lg:col-span-4 islamic-card p-0 flex flex-col">
            <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
                <h3 class="text-[#d4af37] font-bold text-xs uppercase tracking-widest">Asmaul Husna</h3>
                <i class="fa-solid fa-star-and-crescent text-slate-600"></i>
            </div>
            <div class="flex-1 flex items-center justify-center p-6 relative">
                <div class="swiper asmaulSwiper w-full h-full">
                    <div class="swiper-wrapper" id="asmaulWrapper">
                        </div>
                </div>
                <div class="swiper-button-next text-[#d4af37] scale-50"></div>
                <div class="swiper-button-prev text-[#d4af37] scale-50"></div>
            </div>
        </div>
    </div>

    <div class="mb-12">
        <h3 class="text-white font-luxury text-lg mb-2 border-l-4 border-[#d4af37] pl-4 flex items-center">
            Jadwal Sholat Hari ini :
        </h3>
        <p class="text-xs text-slate-400 mb-6 pl-5 italic">*Waktu setempat. Data jadwal Imsakiyah bersumber dari Sistem Informasi Bimas Islam Kemenag RI.</p>
        
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="prayerGrid">
            <div class="col-span-full py-12 text-center text-slate-600">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl text-[#d4af37] mb-3"></i>
                <p class="text-xs uppercase tracking-widest">Sinkronisasi Waktu...</p>
            </div>
        </div>
    </div>

    <div class="mb-12">
        <h3 class="text-white font-luxury text-lg mb-6 border-l-4 border-[#d4af37] pl-4 flex items-center">
                Doa Harian Ramadhan
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="islamic-card p-6 flex flex-col justify-center text-center">
                <div class="flex items-center justify-center gap-3 mb-6">
                    <i class="fa-solid fa-moon text-2xl text-[#d4af37]"></i>
                    <h4 class="text-white font-bold text-lg">Niat Sahur (Puasa Ramadhan)</h4>
                </div>
                <p class="text-2xl md:text-3xl font-arab text-white leading-loose mb-4">نَوَيْتُ صَوْمَ غَدٍ عَنْ أَدَاءِ فَرْضِ شَهْرِ رَمَضَانَ هَذِهِ السَّنَةِ لِلَّهِ تَعَالَى</p>
                <p class="text-sm font-bold text-[#d4af37] mb-2">Nawaitu shauma ghadin 'an adaa'i fardhi syahri Ramadhaana haadzihis sanati lillaahi ta'aalaa.</p>
                <p class="text-xs text-slate-400 italic">"Aku niat berpuasa esok hari untuk menunaikan fardhu di bulan Ramadhan tahun ini, karena Allah Ta'ala."</p>
            </div>
            
            <div class="islamic-card p-6 flex flex-col justify-center text-center">
                <div class="flex items-center justify-center gap-3 mb-6">
                    <i class="fa-solid fa-utensils text-2xl text-emerald-500"></i>
                    <h4 class="text-white font-bold text-lg">Doa Berbuka Puasa</h4>
                </div>
                <p class="text-2xl md:text-3xl font-arab text-white leading-loose mb-4">اللَّهُمَّ لَكَ صُمْتُ وَعَلَى رِزْقِكَ أَفْطَرْتُ ذَهَبَ الظَّمَأُ وَابْتَلَّتِ الْعُرُوقُ وَثَبَتَ الأَجْرُ إِنْ شَاءَ اللَّهُ</p>
                <p class="text-sm font-bold text-emerald-400 mb-2">Allahumma laka shumtu wa 'alaa rizqika afthartu, dzahabazh zhama'u wabtallatil 'uruuqu wa tsabatal ajru, insyaa Allah.</p>
                <p class="text-xs text-slate-400 italic">"Ya Allah, untuk-Mu aku berpuasa, dan dengan rezeki-Mu aku berbuka. Telah hilang rasa haus, telah basah urat-urat, dan telah pasti pahala, insya Allah."</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">
        <div class="islamic-card p-6 flex flex-col">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded bg-[#d4af37]/20 flex items-center justify-center text-[#d4af37]">
                    <i class="fa-solid fa-quran"></i>
                </div>
                <h4 class="text-white font-bold text-sm">Ayat Pilihan</h4>
            </div>
            <div id="quranContent" class="flex-1 flex flex-col justify-center mb-4">
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-4 py-1">
                        <div class="h-4 bg-slate-700 rounded w-3/4 mx-auto"></div>
                        <div class="h-4 bg-slate-700 rounded w-1/2 mx-auto"></div>
                    </div>
                </div>
            </div>
            <button onclick="fetchQuran()" class="w-full py-2 rounded border border-slate-700 text-xs text-slate-400 hover:text-white hover:border-[#d4af37] transition">
                <i class="fa-solid fa-refresh mr-1"></i> Acak Ayat
            </button>
        </div>

        <div class="islamic-card p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded bg-emerald-500/20 flex items-center justify-center text-emerald-500">
                    <i class="fa-solid fa-calculator"></i>
                </div>
                <h4 class="text-white font-bold text-sm">Kalkulator Zakat Maal</h4>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] text-slate-400 uppercase">Total Harta (Rp)</label>
                    <input type="number" id="zakatInput" placeholder="Contoh: 100000000" class="w-full bg-[#1e293b] border border-slate-700 rounded p-2 text-white text-sm focus:border-emerald-500 outline-none transition">
                </div>
                <div class="flex justify-between items-center bg-black/20 p-3 rounded border border-white/5">
                    <span class="text-xs text-slate-400">Wajib Zakat (2.5%)</span>
                    <span id="zakatResult" class="text-emerald-400 font-bold font-mono">Rp 0</span>
                </div>
                <button onclick="calcZakat()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded text-xs font-bold transition">Hitung</button>
            </div>
        </div>

        <div class="islamic-card p-6 text-center relative overflow-hidden group cursor-pointer" onclick="countTasbih()">
            <div class="absolute inset-0 bg-[#d4af37] opacity-0 group-hover:opacity-5 transition duration-300"></div>
            <div class="flex items-center justify-center gap-2 mb-2 text-slate-400">
                <i class="fa-solid fa-fingerprint"></i> <span class="text-[10px] uppercase tracking-widest">Tasbih Digital</span>
            </div>
            <div id="tasbihCount" class="text-7xl font-bold text-white my-4 select-none drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">0</div>
            <p class="text-[10px] text-slate-500 italic mb-4">Ketuk area kartu untuk bertasbih</p>
            <button onclick="event.stopPropagation(); resetTasbih()" class="absolute top-4 right-4 text-slate-600 hover:text-red-400 transition">
                <i class="fa-solid fa-rotate-left"></i>
            </button>
        </div>
    </div>
</div>

<script>
    // =========================================
    // 1. SYSTEM INITIALIZATION & GPS LOCK
    // =========================================
    let currentSchedule = null;
    let timerInterval = null;
    
    // Default Fallback ID (1301 = Kota Jakarta)
    let userCityId = localStorage.getItem('userCityId') || '1301'; 
    let userCityName = localStorage.getItem('userCityName') || 'Kota Jakarta';
    let userKecamatan = localStorage.getItem('userKecamatan') || '';
    let gpsLocked = false;

    $(document).ready(function() {
        initAsmaulHusna();
        fetchQuran();

        // 1. Set State Awal berdasarkan Storage
        $('#kotaSelect').val(userCityId);
        $('#currentCityLabel').text(userCityName);
        if(userKecamatan) {
            $('#currentKecamatanLabel').text("Kec. " + userKecamatan).removeClass('hidden');
        }
        
        // 2. Tarik Data Jadwal Perdana
        fetchSchedule(userCityId);
        
        // 3. Coba Deteksi GPS otomatis
        forceGPS();

        // Handler saat user manual memilih kota
        $('#kotaSelect').on('change', function() {
            const idKota = $(this).val();
            const namaKota = $("#kotaSelect option:selected").text();
            
            userCityId = idKota;
            userCityName = namaKota;
            userKecamatan = ""; // Reset kecamatan if manual selection

            localStorage.setItem('userCityId', idKota);
            localStorage.setItem('userCityName', namaKota);
            localStorage.setItem('userKecamatan', "");
            
            $('#currentCityLabel').text(namaKota);
            $('#currentKecamatanLabel').addClass('hidden');
            $('#locStatus').text("Lokasi Diset Manual").removeClass("animate-pulse").css('color', '#94a3b8');
            
            fetchSchedule(idKota);
        });
    });

    function forceGPS() {
        $('#locStatus').text("Sedang mencari koordinat GPS...").addClass("animate-pulse").css('color', '#d4af37');
        $('#gpsIcon').addClass("animate-spin text-white").removeClass("text-[#d4af37] text-emerald-400 shadow-[0_0_10px_#10b981]");

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    $.getJSON(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`, function(data) {
                        
                        let detected = data.address.city || data.address.town || data.address.county || 'Jakarta';
                        let detectedKecamatan = data.address.village || data.address.suburb || data.address.neighbourhood || '';

                        detected = detected.replace(/(Kota|Kabupaten|City of)\s+/i, '').trim();

                        let matchId = null;
                        let matchName = null;
                        
                        // Cari kota di opsi select yang paling cocok dengan hasil GPS
                        $('#kotaSelect option').each(function() {
                            const optText = $(this).text().toLowerCase();
                            if (optText.includes(detected.toLowerCase())) {
                                matchId = $(this).val();
                                matchName = $(this).text();
                                return false; // Break loop
                            }
                        });

                        if (matchId) {
                            $('#kotaSelect').val(matchId);
                            
                            userCityId = matchId;
                            userCityName = matchName;
                            userKecamatan = detectedKecamatan;

                            localStorage.setItem('userCityId', matchId);
                            localStorage.setItem('userCityName', matchName);
                            localStorage.setItem('userKecamatan', detectedKecamatan);

                            $('#currentCityLabel').text(matchName);
                            
                            let locStatusText = "GPS Terkunci: " + matchName;

                            if(detectedKecamatan) {
                                $('#currentKecamatanLabel').text("Kec. " + detectedKecamatan).removeClass('hidden');
                                locStatusText += " (Kec. " + detectedKecamatan + ")";
                            } else {
                                $('#currentKecamatanLabel').addClass('hidden');
                            }

                            $('#locStatus').text(locStatusText).removeClass("animate-pulse").addClass("text-emerald-400").css('color', '#10b981');
                            $('#gpsIcon').removeClass("animate-spin text-white").addClass("text-emerald-400 shadow-[0_0_10px_#10b981]");
                            gpsLocked = true;

                            fetchSchedule(matchId);

                        } else {
                            fallbackLocation("Koordinat ditemukan, tapi kota tidak terdaftar di database Kemenag.");
                        }
                    }).fail(function() {
                        fallbackLocation("Gagal menerjemahkan data satelit wilayah.");
                    });
                },
                (error) => { fallbackLocation("Akses GPS ditolak atau dimatikan oleh perangkat."); },
                { timeout: 10000, enableHighAccuracy: true }
            );
        } else {
            fallbackLocation("Browser tidak mendukung deteksi lokasi.");
        }
    }

    function fallbackLocation(reasonMsg = "") {
        $('#locStatus').text(reasonMsg + " Menggunakan riwayat lokasi.").removeClass("animate-pulse").css('color', '#94a3b8');
        $('#gpsIcon').removeClass("animate-spin").addClass("text-slate-500");
    }

    // =========================================
    // 2. PRAYER SCHEDULE API (INTERNAL) & ALERTS
    // =========================================
    function fetchSchedule(id_kota) {
        if(!id_kota) return;

        // Tampilkan indikator Loading sebelum data masuk
        $('#prayerGrid').html(`
            <div class="col-span-full py-12 text-center text-slate-600">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl text-[#d4af37] mb-3"></i>
                <p class="text-xs uppercase tracking-widest">Menarik Data Kemenag...</p>
            </div>
        `);

        // Panggil API Python/Flask Ndan sendiri (yang diteruskan dari MyQuran)
        $.get(`/api/jadwal-imsakiyah?id_kota=${id_kota}`, function(res) {
            if(res.status && res.data && res.data.jadwal) {
                // Mendapatkan format tanggal hari ini (YYYY-MM-DD)
                const d = new Date();
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const todayDateStr = `${yyyy}-${mm}-${dd}`;
                
                // Cari jadwal spesifik untuk TANGGAL HARI INI dari respon API
                let todayJadwal = res.data.jadwal.find(j => j.date === todayDateStr);
                
                // Jika server tidak memiliki tanggal hari ini (misal pergantian bulan/timezone), pakai index 0
                if (!todayJadwal) todayJadwal = res.data.jadwal[0]; 

                $('#dateMasehi').text(todayJadwal.tanggal);
                
                renderPrayerGrid(todayJadwal);
                startCountdownEngine(todayJadwal);
            } else {
                $('#prayerGrid').html('<div class="col-span-full py-12 text-center text-red-500 font-bold">Gagal mengambil jadwal Kemenag. Coba segarkan halaman.</div>');
            }
        }).fail(function() {
            $('#prayerGrid').html('<div class="col-span-full py-12 text-center text-red-500 font-bold">Server Offline. Gagal menghubungi Kemenag.</div>');
        });
    }

    function renderPrayerGrid(t) {
        // Mapping kunci lowercase karena JSON API MyQuran menggunakan huruf kecil
        const prayers = [
            {id:'Imsak', n:'Imsak', t:t.imsak},
            {id:'Fajr', n:'Subuh', t:t.subuh},
            {id:'Dhuhr', n:'Dzuhur', t:t.dzuhur},
            {id:'Asr', n:'Ashar', t:t.ashar},
            {id:'Maghrib', n:'Maghrib', t:t.maghrib},
            {id:'Isha', n:'Isya', t:t.isya}
        ];

        let html = '';
        prayers.forEach(p => {
            html += `
            <div id="card-${p.id}" class="prayer-time-box p-4 flex flex-col items-center justify-center text-center">
                <h4 class="text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2">${p.n}</h4>
                <p class="text-xl font-luxury text-white">${p.t}</p>
            </div>`;
        });
        $('#prayerGrid').html(html);
    }

    function startCountdownEngine(timings) {
        if(timerInterval) clearInterval(timerInterval);

        const prayers = [
            {name:'Imsak', time:timings.imsak, id:'Imsak'},
            {name:'Subuh', time:timings.subuh, id:'Fajr'},
            {name:'Dzuhur', time:timings.dzuhur, id:'Dhuhr'},
            {name:'Ashar', time:timings.ashar, id:'Asr'},
            {name:'Maghrib', time:timings.maghrib, id:'Maghrib'},
            {name:'Isya', time:timings.isya, id:'Isha'}
        ];

        timerInterval = setInterval(() => {
            const now = new Date();
            let nextP = null;
            let minDiff = Infinity;
            let activeAzanPrayer = null;

            prayers.forEach(p => {
                const [h, m] = p.time.split(':');
                const pTime = new Date(); 
                pTime.setHours(h, m, 0, 0);

                let diff = pTime - now;
                
                const el = $(`#card-${p.id}`);
                
                // Menyorot box jadwal jika masuk waktu. 
                // DURASI NYALA: 15 Menit = 900.000 milidetik
                if (diff <= 0 && diff > -900000) {
                    el.addClass('active pulse-active');
                    // Kondisi spesial Azan Berlangsung (15 menit nyala alert UI)
                    if (p.id !== 'Imsak') {
                        activeAzanPrayer = p;
                    }
                } else {
                    el.removeClass('active pulse-active');
                }

                if (diff > 0 && diff < minDiff) {
                    minDiff = diff;
                    nextP = p;
                }
            });

            // Rollover logic: Jika isya sudah lewat, target = besok Imsak
            if (!nextP) {
                nextP = prayers[0];
                const [h, m] = nextP.time.split(':');
                const tmrw = new Date(); tmrw.setDate(now.getDate() + 1); tmrw.setHours(h, m, 0, 0);
                minDiff = tmrw - now;
            }

            const totalSeconds = Math.floor(minDiff / 1000);
            const hh = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const mm = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const ss = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            
            // Logic update tampilan utama
            if (activeAzanPrayer) {
                $('#prayerLabelText').text(`Saat Waktu ${activeAzanPrayer.name} untuk wilayah ${userCityName} dan Sekitarnya`);
                $('#nextPrayerName').text('');
                $('#countdown').text('WAKTUNYA SHOLAT').addClass('text-emerald-400 text-3xl md:text-5xl mt-4').removeClass('text-gold-gradient text-red-500 text-6xl md:text-8xl font-luxury');
            } else {
                $('#prayerLabelText').text('Menuju Waktu ');
                $('#nextPrayerName').text(nextP.name);
                $('#countdown').text(`${hh}:${mm}:${ss}`).removeClass('text-emerald-400 text-3xl md:text-5xl mt-4').addClass('text-6xl md:text-8xl font-luxury');
                
                // Beri warna peringatan jika kurang 60 detik
                if (totalSeconds <= 60) {
                    $('#countdown').addClass('text-red-500').removeClass('text-gold-gradient');
                } else {
                    $('#countdown').removeClass('text-red-500').addClass('text-gold-gradient');
                }
            }

            const oneHour = 3600000;
            const percentage = Math.max(0, Math.min(100, 100 - ((minDiff / oneHour) * 100)));
            $('#timeProgressBar').css('width', `${percentage}%`);

            // Notifikasi Toast
            const minutesLeft = Math.floor(totalSeconds / 60);
            const secondsLeft = totalSeconds % 60;

            if (nextP.name !== 'Subuh' && nextP.name !== 'Imsak' && minutesLeft === 15 && secondsLeft === 0) {
                showToast(`Persiapan ${nextP.name}`, `Waktu ${nextP.name} akan masuk dalam 15 menit.`);
            }
            if (nextP.name === 'Imsak' && minutesLeft === 10 && secondsLeft === 0) {
                showToast(`⚠️ Peringatan Imsak`, `Waktu Imsak tersisa 10 menit lagi. Segera selesaikan sahur.`);
            }
            if (totalSeconds === 0) {
                showToast(`Waktu ${nextP.name}`, `Telah masuk waktu sholat ${nextP.name} untuk wilayah ${userCityName}.`);
            }

        }, 1000);
    }

    function showToast(title, msg) {
        $('#toastTitle').text(title);
        $('#toastMessage').text(msg);
        const toast = $('#prayerToast');
        toast.addClass('show');
        setTimeout(() => { toast.removeClass('show'); }, 8000);
    }

    // =========================================
    // 3. FEATURES LOGIC (QURAN, ZAKAT, ASMAUL HUSNA)
    // =========================================
    
    function initAsmaulHusna() {
        const asmaulHusna = [
            { Arab: "الرَّحْمَنُ", Latin: "Ar Rahman", Arti: "Yang Maha Pengasih" },
            { Arab: "الرَّحِيمُ", Latin: "Ar Rahiim", Arti: "Yang Maha Penyayang" },
            { Arab: "الْمَلِكُ", Latin: "Al Malik", Arti: "Yang Maha Merajai" },
            { Arab: "الْقُدُّوسُ", Latin: "Al Quddus", Arti: "Yang Maha Suci" },
            { Arab: "السَّلاَمُ", Latin: "As Salaam", Arti: "Yang Maha Memberi Kesejahteraan" },
            { Arab: "الْمُؤْمِنُ", Latin: "Al Mu'min", Arti: "Yang Maha Memberi Keamanan" },
            { Arab: "الْمُهَيْمِنُ", Latin: "Al Muhaimin", Arti: "Yang Maha Pemelihara" },
            { Arab: "الْعَزِيزُ", Latin: "Al 'Aziz", Arti: "Yang Maha Perkasa" },
            { Arab: "الْجَبَّارُ", Latin: "Al Jabbar", Arti: "Yang Memiliki Mutlak Kegagahan" },
            { Arab: "الْمُتَكَبِّرُ", Latin: "Al Mutakabbir", Arti: "Yang Maha Megah" },
            { Arab: "الْخَالِقُ", Latin: "Al Khaliq", Arti: "Yang Maha Pencipta" },
            { Arab: "الْبَارِئُ", Latin: "Al Baari'", Arti: "Yang Maha Melepaskan" },
            { Arab: "الْمُصَوِّرُ", Latin: "Al Mushawwir", Arti: "Yang Maha Membentuk Rupa" },
            { Arab: "الْغَفَّارُ", Latin: "Al Ghaffaar", Arti: "Yang Maha Pengampun" },
            { Arab: "الْقَهَّارُ", Latin: "Al Qahhaar", Arti: "Yang Maha Memaksa" },
            { Arab: "الْوَهَّابُ", Latin: "Al Wahhaab", Arti: "Yang Maha Pemberi Karunia" },
            { Arab: "الرَّزَّاقُ", Latin: "Ar Razzaaq", Arti: "Yang Maha Pemberi Rezeki" },
            { Arab: "الْفَتَّاحُ", Latin: "Al Fattaah", Arti: "Yang Maha Pembuka Rahmat" },
            { Arab: "الْعَلِيمُ", Latin: "Al 'Aliim", Arti: "Yang Maha Mengetahui" },
            { Arab: "الْقَابِضُ", Latin: "Al Qaabidh", Arti: "Yang Maha Menyempitkan" },
            { Arab: "الْبَاسِطُ", Latin: "Al Baasith", Arti: "Yang Maha Melapangkan" },
            { Arab: "الْخَافِضُ", Latin: "Al Khaafidh", Arti: "Yang Maha Merendahkan" },
            { Arab: "الرَّافِعُ", Latin: "Ar Raafi'", Arti: "Yang Maha Meninggikan" },
            { Arab: "الْمُعِزُّ", Latin: "Al Mu'izz", Arti: "Yang Maha Memuliakan" },
            { Arab: "المُذِلُّ", Latin: "Al Mudzil", Arti: "Yang Maha Menghinakan" },
            { Arab: "السَّمِيعُ", Latin: "As Samii'", Arti: "Yang Maha Mendengar" },
            { Arab: "الْبَصِيرُ", Latin: "Al Bashiir", Arti: "Yang Maha Melihat" },
            { Arab: "الْحَكَمُ", Latin: "Al Hakam", Arti: "Yang Maha Menetapkan" },
            { Arab: "الْعَدْلُ", Latin: "Al 'Adl", Arti: "Yang Maha Adil" },
            { Arab: "اللَّطِيفُ", Latin: "Al Lathiif", Arti: "Yang Maha Lembut" },
            { Arab: "الْخَبِيرُ", Latin: "Al Khabiir", Arti: "Yang Maha Mengenal" },
            { Arab: "الْحَلِيمُ", Latin: "Al Haliim", Arti: "Yang Maha Penyantun" },
            { Arab: "الْعَظِيمُ", Latin: "Al 'Azhiim", Arti: "Yang Maha Agung" },
            { Arab: "الْغَفُورُ", Latin: "Al Ghafuur", Arti: "Yang Maha Pengampun" },
            { Arab: "الشَّكُورُ", Latin: "Asy Syakuur", Arti: "Yang Maha Pembalas Budi" },
            { Arab: "الْعَلِيُّ", Latin: "Al 'Aliy", Arti: "Yang Maha Tinggi" },
            { Arab: "الْكَبِيرُ", Latin: "Al Kabiir", Arti: "Yang Maha Besar" },
            { Arab: "الْحَفِيظُ", Latin: "Al Hafizh", Arti: "Yang Maha Memelihara" },
            { Arab: "الْمُقِيتُ", Latin: "Al Muqiit", Arti: "Yang Maha Pemberi Kecukupan" },
            { Arab: "الْحَسِيبُ", Latin: "Al Hasiib", Arti: "Yang Maha Membuat Perhitungan" },
            { Arab: "الْجَلِيلُ", Latin: "Al Jaliil", Arti: "Yang Maha Mulia" },
            { Arab: "الْكَرِيمُ", Latin: "Al Kariim", Arti: "Yang Maha Pemurah" },
            { Arab: "الرَّقِيبُ", Latin: "Ar Raqiib", Arti: "Yang Maha Mengawasi" },
            { Arab: "الْمُجِيبُ", Latin: "Al Mujiib", Arti: "Yang Maha Mengabulkan" },
            { Arab: "الْوَاسِعُ", Latin: "Al Waasi'", Arti: "Yang Maha Luas" },
            { Arab: "الْحَكِيمُ", Latin: "Al Hakiim", Arti: "Yang Maha Bijaksana" },
            { Arab: "الْوَدُودُ", Latin: "Al Waduud", Arti: "Yang Maha Mengasihi" },
            { Arab: "الْمَجِيدُ", Latin: "Al Majiid", Arti: "Yang Maha Mulia" },
            { Arab: "الْبَاعِثُ", Latin: "Al Baa'its", Arti: "Yang Maha Membangkitkan" },
            { Arab: "الشَّهِيدُ", Latin: "Asy Syahiid", Arti: "Yang Maha Menyaksikan" },
            { Arab: "الْحَقُّ", Latin: "Al Haqq", Arti: "Yang Maha Benar" },
            { Arab: "الْوَكِيلُ", Latin: "Al Wakiil", Arti: "Yang Maha Memelihara" },
            { Arab: "الْقَوِيُّ", Latin: "Al Qawiyyu", Arti: "Yang Maha Kuat" },
            { Arab: "الْمَتِينُ", Latin: "Al Matiin", Arti: "Yang Maha Kokoh" },
            { Arab: "الْوَلِيُّ", Latin: "Al Waliyy", Arti: "Yang Maha Melindungi" },
            { Arab: "الْحَمِيدُ", Latin: "Al Hamiid", Arti: "Yang Maha Terpuji" },
            { Arab: "الْمُحْصِي", Latin: "Al Muhshii", Arti: "Yang Maha Mengalkulasi" },
            { Arab: "الْمُبْدِئُ", Latin: "Al Mubdi'", Arti: "Yang Maha Memulai" },
            { Arab: "الْمُعِيدُ", Latin: "Al Mu'iid", Arti: "Yang Maha Mengembalikan" },
            { Arab: "الْمُحْيِي", Latin: "Al Muhyii", Arti: "Yang Maha Menghidupkan" },
            { Arab: "اَلْمُمِيتُ", Latin: "Al Mumiitu", Arti: "Yang Maha Mematikan" },
            { Arab: "الْحَيُّ", Latin: "Al Hayyu", Arti: "Yang Maha Hidup" },
            { Arab: "الْقَيُّومُ", Latin: "Al Qayyuum", Arti: "Yang Maha Mandiri" },
            { Arab: "الْوَاجِدُ", Latin: "Al Waajid", Arti: "Yang Maha Penemu" },
            { Arab: "الْمَاجِدُ", Latin: "Al Maajid", Arti: "Yang Maha Mulia" },
            { Arab: "الْوَاحِدُ", Latin: "Al Waahid", Arti: "Yang Maha Tunggal" },
            { Arab: "اَلاَحَدُ", Latin: "Al Ahad", Arti: "Yang Maha Esa" },
            { Arab: "الصَّمَدُ", Latin: "Ash Shamad", Arti: "Yang Maha Dibutuhkan" },
            { Arab: "الْقَادِرُ", Latin: "Al Qaadir", Arti: "Yang Maha Menentukan" },
            { Arab: "الْمُقْتَدِرُ", Latin: "Al Muqtadir", Arti: "Yang Maha Berkuasa" },
            { Arab: "الْمُقَدِّمُ", Latin: "Al Muqaddim", Arti: "Yang Maha Mendahulukan" },
            { Arab: "الْمُؤَخِّرُ", Latin: "Al Mu'akkhir", Arti: "Yang Maha Mengakhirkan" },
            { Arab: "الأوَّلُ", Latin: "Al Awwal", Arti: "Yang Maha Awal" },
            { Arab: "الآخِرُ", Latin: "Al Aakhir", Arti: "Yang Maha Akhir" },
            { Arab: "الظَّاهِرُ", Latin: "Azh Zhaahir", Arti: "Yang Maha Nyata" },
            { Arab: "الْبَاطِنُ", Latin: "Al Baathin", Arti: "Yang Maha Ghaib" },
            { Arab: "الْوَالِي", Latin: "Al Waali", Arti: "Yang Maha Memerintah" },
            { Arab: "الْمُتَعَالِي", Latin: "Al Muta'aalii", Arti: "Yang Maha Tinggi" },
            { Arab: "الْبَرُّ", Latin: "Al Barru", Arti: "Yang Maha Penderma" },
            { Arab: "التَّوَابُ", Latin: "At Tawwaab", Arti: "Yang Maha Penerima Taubat" },
            { Arab: "الْمُنْتَقِمُ", Latin: "Al Muntaqim", Arti: "Yang Maha Pemberi Balasan" },
            { Arab: "العَفُوُّ", Latin: "Al Afuww", Arti: "Yang Maha Pemaaf" },
            { Arab: "الرَّؤُوفُ", Latin: "Ar Ra'uuf", Arti: "Yang Maha Pengasuh" },
            { Arab: "مَالِكُ الْمُلْكِ", Latin: "Malikul Mulk", Arti: "Yang Maha Penguasa Kerajaan" },
            { Arab: "ذُوالْجَلاَلِ وَالإكْرَامِ", Latin: "Dzul Jalaali Wal Ikraam", Arti: "Yang Maha Pemilik Kebesaran & Kemuliaan" },
            { Arab: "الْمُقْسِطُ", Latin: "Al Muqsith", Arti: "Yang Maha Pemberi Keadilan" },
            { Arab: "الْجَامِعُ", Latin: "Al Jaami'", Arti: "Yang Maha Mengumpulkan" },
            { Arab: "الْغَنِيُّ", Latin: "Al Ghaniyy", Arti: "Yang Maha Kaya" },
            { Arab: "الْمُغْنِي", Latin: "Al Mughnii", Arti: "Yang Maha Pemberi Kekayaan" },
            { Arab: "الْمَانِعُ", Latin: "Al Maani'", Arti: "Yang Maha Mencegah" },
            { Arab: "الضَّارُ", Latin: "Adh Dhaar", Arti: "Yang Maha Penimpa Kemudharatan" },
            { Arab: "النَّافِعُ", Latin: "An Naafi'", Arti: "Yang Maha Memberi Manfaat" },
            { Arab: "النُّورُ", Latin: "An Nuur", Arti: "Yang Maha Bercahaya" },
            { Arab: "الْهَادِي", Latin: "Al Haadii", Arti: "Yang Maha Pemberi Petunjuk" },
            { Arab: "الْبَدِيعُ", Latin: "Al Badii'", Arti: "Yang Maha Pencipta Tiada Bandingannya" },
            { Arab: "اَلْبَاقِي", Latin: "Al Baaqii", Arti: "Yang Maha Kekal" },
            { Arab: "الْوَارِثُ", Latin: "Al Waarits", Arti: "Yang Maha Pewaris" },
            { Arab: "الرَّشِيدُ", Latin: "Ar Rasyiid", Arti: "Yang Maha Pandai" },
            { Arab: "الصَّبُورُ", Latin: "Ash Shabuur", Arti: "Yang Maha Sabar" }
        ];

        let html = '';
        asmaulHusna.forEach(a => {
            html += `
            <div class="swiper-slide flex flex-col items-center justify-center text-center px-4">
                <div class="text-3xl md:text-4xl font-arab text-white mb-2 drop-shadow-md">${a.Arab}</div>
                <div class="text-sm font-bold text-[#d4af37]">${a.Latin}</div>
                <div class="text-[10px] text-slate-400 italic">"${a.Arti}"</div>
            </div>`;
        });
        $('#asmaulWrapper').html(html);

        new Swiper(".asmaulSwiper", {
            navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
            autoplay: { delay: 3500, disableOnInteraction: false },
            loop: true
        });
    }

    function fetchQuran() {
        $('#quranContent').html('<div class="text-xs text-slate-500">Memuat ayat...</div>');
        const id = Math.floor(Math.random() * 6236) + 1;
        $.get(`https://api.alquran.cloud/v1/ayah/${id}/editions/quran-uthmani,id.indonesian`, function(res) {
            const arab = res.data[0];
            const indo = res.data[1];
            $('#quranContent').html(`
                <p class="text-xl font-arab text-right text-white leading-loose mb-3" dir="rtl">${arab.text}</p>
                <p class="text-xs text-slate-400 italic">"${indo.text}"</p>
                <div class="mt-3 text-[10px] font-bold text-[#d4af37] uppercase text-right">QS. ${arab.surah.englishName} : ${arab.numberInSurah}</div>
            `);
        });
    }

    function calcZakat() {
        const val = parseFloat($('#zakatInput').val()) || 0;
        const zakat = val * 0.025;
        $('#zakatResult').text(new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(zakat));
    }

    let tasbih = 0;
    function countTasbih() { tasbih++; $('#tasbihCount').text(tasbih); }
    function resetTasbih() { tasbih=0; $('#tasbihCount').text(0); }

</script>

{% endblock %}
