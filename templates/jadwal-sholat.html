{% extends 'base.html' %}

{% block title %}Khazanah Islam - KTVDI{% endblock %}

{% block content %}

<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Cinzel:wght@400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

<style>
    /* =========================================
       THEME: PROFESSIONAL DEEP NAVY & GOLD
       ========================================= */
    :root {
        --color-bg: #020617;        /* Solid Deep Navy */
        --color-panel: #0f172a;     /* Lighter Navy for Cards */
        --color-gold: #d4af37;      /* Classic Gold */
        --color-gold-hover: #b4941f;
        --color-text: #f8fafc;
        --color-muted: #94a3b8;
        --border-color: #1e293b;
        
        --nav-offset: 130px;        /* Safe area for Navbar */
        --radius: 12px;
    }

    body {
        background-color: var(--color-bg);
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4af37' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        color: var(--color-text);
        font-family: 'Plus Jakarta Sans', sans-serif;
        margin: 0; 
        overflow-x: hidden;
    }

    .font-arab { font-family: 'Amiri', serif; line-height: 2.4; }
    .font-head { font-family: 'Cinzel', serif; }

    /* LAYOUT CONTAINER */
    .app-container {
        padding-top: var(--nav-offset);
        padding-bottom: 80px;
        padding-left: 20px; padding-right: 20px;
        max-width: 1400px; margin: 0 auto;
    }

    /* PROFESSIONAL CARD */
    .pro-card {
        background-color: var(--color-panel);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        transition: border-color 0.3s;
    }
    .pro-card:hover { border-color: var(--color-gold); }

    /* HEADER & SEARCH */
    .location-wrapper {
        background: #1e293b;
        border: 1px solid var(--color-gold);
        border-radius: 50px;
        padding: 4px 20px;
        display: flex; align-items: center;
        width: 100%; max-width: 350px;
    }
    
    /* Select2 Custom */
    .select2-container .select2-selection--single {
        height: 40px !important; background: transparent !important;
        border: none !important; color: white !important; display: flex; align-items: center;
    }
    .select2-selection__rendered { color: var(--color-gold) !important; font-weight: 700; font-size: 14px; }
    .select2-dropdown { background-color: var(--color-panel) !important; border: 1px solid var(--color-gold) !important; }
    .select2-results__option--highlighted { background-color: var(--color-gold) !important; color: #000 !important; }

    /* PRAYER TIME GRID */
    .time-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border-color);
        border-radius: 8px; padding: 15px; text-align: center;
        transition: 0.3s;
    }
    .time-card.active {
        background: var(--color-gold);
        border-color: var(--color-gold);
        color: #020617 !important;
        transform: scale(1.02);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
    }
    .time-card.active * { color: #020617 !important; font-weight: bold; }

    /* TIMELINE PROGRESS BAR */
    .timeline-track {
        width: 100%; height: 6px; background: rgba(255,255,255,0.1);
        border-radius: 10px; margin-top: 20px; position: relative; overflow: hidden;
    }
    .timeline-fill {
        height: 100%; background: var(--color-gold);
        border-radius: 10px; transition: width 1s linear;
        box-shadow: 0 0 10px rgba(212, 175, 55, 0.6);
    }

    /* TAB SYSTEM (BUKU SAKU) */
    .tab-btn {
        padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent;
        color: var(--color-muted); font-weight: 600; transition: 0.3s; font-size: 14px;
    }
    .tab-btn:hover { color: white; }
    .tab-btn.active {
        color: var(--color-gold); border-bottom-color: var(--color-gold);
    }
    .tab-content { display: none; padding: 20px; animation: fadeIn 0.5s; }
    .tab-content.active { display: block; }

    /* FLIP CARDS */
    .flip-container { perspective: 1000px; height: 260px; cursor: pointer; }
    .flip-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
    .flip-container.flipped .flip-inner { transform: rotateY(180deg); }
    .flip-front, .flip-back {
        position: absolute; inset: 0; backface-visibility: hidden;
        border-radius: 12px; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center;
        border: 1px solid var(--border-color); background: var(--color-panel);
    }
    .flip-back { transform: rotateY(180deg); border-color: var(--color-gold); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .gps-pulse { animation: pulse-slow 2s infinite; }
</style>

<div class="app-container">

    <div class="flex flex-col lg:flex-row justify-between items-end mb-10 pb-6 border-b border-gray-800 gap-6">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <i class="fa-solid fa-kaaba text-3xl text-amber-400"></i>
                <h1 class="text-3xl md:text-4xl font-bold font-head text-white tracking-wide">Khazanah Islam</h1>
            </div>
            <p class="text-slate-400 text-sm pl-1 uppercase tracking-widest">Portal Ibadah & Wawasan Terpercaya</p>
        </div>
        
        <div class="location-wrapper">
            <div id="gpsIcon" class="text-amber-400 mr-3 gps-pulse"><i class="fa-solid fa-location-crosshairs"></i></div>
            <div class="flex-1">
                <select id="kotaSelect">
                    <option value="Jakarta" selected>Jakarta</option>
                    {% for kota in daftar_kota %}
                    <option value="{{ kota }}">{{ kota }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
        
        <div class="lg:col-span-2 pro-card p-8 flex flex-col justify-center items-center text-center relative overflow-hidden bg-[#0a1525]">
            <div class="flex justify-between w-full mb-8 border-b border-white/5 pb-4">
                <span class="text-amber-400 text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                    <i class="fa-regular fa-calendar-check"></i> <span id="hijriDate">...</span>
                </span>
                <span class="text-slate-400 text-xs font-mono" id="dateMasehi">...</span>
            </div>

            <div class="w-full">
                <p class="text-xs text-slate-500 uppercase tracking-[0.3em] mb-4 font-bold">Menuju Waktu <span id="nextPrayerName" class="text-white">...</span></p>
                <div id="countdown" class="text-7xl md:text-9xl font-head font-bold text-white tabular-nums tracking-tight">--:--:--</div>
                
                <div class="timeline-track">
                    <div id="timeProgressBar" class="timeline-fill" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500 mt-2 uppercase font-bold">
                    <span id="prevPrayerLabel">Mulai</span>
                    <span id="nextPrayerLabel">Selesai</span>
                </div>
            </div>

            <div id="smartAlert" class="mt-6 hidden w-full bg-red-900/20 border border-red-800 text-red-200 px-4 py-2 rounded text-xs items-center justify-center gap-2">
                <i class="fa-solid fa-triangle-exclamation"></i> <span id="alertText">...</span>
            </div>
        </div>

        <div class="pro-card p-0 flex flex-col">
            <div class="bg-[#152030] p-4 border-b border-gray-800 flex justify-between items-center">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest">Kalam Ilahi</h3>
                <i class="fa-solid fa-book-quran text-slate-600"></i>
            </div>
            <div class="p-6 flex-1 flex flex-col justify-center text-center">
                <div id="quranContent" class="flex-1 flex flex-col justify-center">
                    <div class="text-slate-500 text-sm"><i class="fa-solid fa-circle-notch fa-spin mb-2"></i><br>Memuat Ayat...</div>
                </div>
                <button onclick="fetchQuran()" class="w-full mt-6 py-2 border border-slate-700 rounded text-slate-400 text-xs hover:text-white hover:border-amber-400 transition">
                    <i class="fa-solid fa-rotate mr-2"></i> Ayat Lainnya
                </button>
            </div>
        </div>
    </div>

    <div class="mb-12">
        <h3 class="text-white font-bold text-lg mb-6 border-l-4 border-amber-400 pl-3">Jadwal Sholat Hari Ini</h3>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="prayerGrid">
            <div class="col-span-full py-8 text-center text-slate-500 bg-[#0f172a] rounded-lg border border-gray-800">
                <i class="fa-solid fa-spinner fa-spin text-2xl text-amber-400"></i>
            </div>
        </div>
    </div>

    <div class="mb-12 pro-card overflow-hidden">
        <div class="flex overflow-x-auto bg-[#0a1525] border-b border-gray-800 px-4">
            <div class="tab-btn active" onclick="openTab(event, 'tabPuasa')">Niat & Doa Puasa</div>
            <div class="tab-btn" onclick="openTab(event, 'tabTarawih')">Doa Tarawih (Kamilin)</div>
            <div class="tab-btn" onclick="openTab(event, 'tabWudhu')">Tutorial Wudhu</div>
            <div class="tab-btn" onclick="openTab(event, 'tabTayammum')">Tutorial Tayammum</div>
        </div>

        <div id="tabPuasa" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h4 class="text-emerald-400 font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-check"></i> Niat Puasa</h4>
                    <p class="text-2xl font-arab text-right text-white mb-2 leading-loose" dir="rtl">نَوَيْتُ صَوْمَ غَدٍ عَنْ أَدَاءِ فَرْضِ شَهْرِ رَمَضَانَ هَذِهِ السَّنَةِ لِلّٰهِ تَعَالَى</p>
                    <p class="text-sm text-slate-400 italic">"Nawaitu shauma ghadin 'an ada'i fardhi syahri Ramadhana hadzihis sanati lillahi ta'ala."</p>
                </div>
                <div>
                    <h4 class="text-amber-400 font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-mug-hot"></i> Doa Berbuka</h4>
                    <p class="text-2xl font-arab text-right text-white mb-2 leading-loose" dir="rtl">ذَهَبَ الظَّمَأُ وَابْتَلَّتِ الْعُرُوقُ، وَثَبَتَ الأَجْرُ إِنْ شَاءَ اللهُ</p>
                    <p class="text-sm text-slate-400 italic">"Dzahabaz zhama'u wabtallatil 'uruqu wa tsabatal ajru in syaa-allah."</p>
                </div>
            </div>
        </div>

        <div id="tabTarawih" class="tab-content">
            <h4 class="text-amber-400 font-bold mb-4">Doa Kamilin (Dibaca setelah Sholat Tarawih)</h4>
            <div class="bg-black/20 p-6 rounded-lg max-h-64 overflow-y-auto custom-scrollbar">
                <p class="text-2xl font-arab text-right text-white mb-4 leading-loose" dir="rtl">
                    اَللّٰهُمَّ اجْعَلْنَا بِالْإِيْمَانِ كَامِلِيْنَ، وَلِلْفَرَائِضِ مُؤَدِّيْنَ، وَلِلصَّلَاةِ حَافِظِيْنَ، وَلِلزَّكَاةِ فَاعِلِيْنَ، وَلِمَا عِنْدَكَ طَالِبِيْنَ، وَلِعَفْوِكَ رَاجِيْنَ، وَبِالْهُدَى مُتَمَسِّكِيْنَ، وَعَنِ اللَّغْوِ مُعْرِضِيْنَ، وَفِي الدُّنْيَا زَاهِدِيْنَ، وَفِي الْاٰخِرَةِ رَاغِبِيْنَ، وَبِالْقَضَاءِ رَاضِيْنَ، وَلِلنَّعْمَاءِ شَاكِرِيْنَ، وَعَلَى الْبَلَاءِ صَابِرِيْنَ...
                </p>
                <p class="text-sm text-slate-300 mt-4">
                    <strong>Artinya:</strong> "Ya Allah, jadikanlah kami orang-orang yang sempurna imannya, yang memenuhi kewajiban-kewajiban, yang memelihara shalat, yang mengeluarkan zakat, yang mencari apa yang ada di sisi-Mu, yang mengharapkan ampunan-Mu, yang berpegang teguh pada petunjuk, yang berpaling dari kebatilan..."
                </p>
            </div>
        </div>

        <div id="tabWudhu" class="tab-content">
            <h4 class="text-blue-400 font-bold mb-4">Rukun & Tata Cara Wudhu</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-slate-300">
                <ul class="list-disc pl-5 space-y-2">
                    <li><strong>Niat:</strong> Membaca Bismillah dan berniat dalam hati.</li>
                    <li><strong>Membasuh Wajah:</strong> Meratakan air ke seluruh wajah.</li>
                    <li><strong>Membasuh Tangan:</strong> Hingga siku (kanan lalu kiri).</li>
                </ul>
                <ul class="list-disc pl-5 space-y-2">
                    <li><strong>Mengusap Kepala:</strong> Sebagian atau seluruh kepala.</li>
                    <li><strong>Membasuh Kaki:</strong> Hingga mata kaki (kanan lalu kiri).</li>
                    <li><strong>Tertib:</strong> Dilakukan secara berurutan.</li>
                </ul>
            </div>
        </div>

        <div id="tabTayammum" class="tab-content">
            <h4 class="text-amber-400 font-bold mb-4">Tata Cara Tayammum</h4>
            <ol class="list-decimal pl-5 space-y-2 text-sm text-slate-300">
                <li>Berniat melakukan tayammum untuk diperbolehkan sholat.</li>
                <li>Menepukkan kedua telapak tangan ke debu yang suci.</li>
                <li>Meniup debu di tangan agar menipis.</li>
                <li>Mengusap wajah dengan debu tersebut.</li>
                <li>Mengusap kedua tangan hingga siku.</li>
            </ol>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-16">
        <div class="lg:col-span-8 pro-card p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-white"><i class="fa-solid fa-shop text-amber-400 mr-2"></i> Bazar Ramadan</h3>
                <span class="text-[10px] bg-white/10 px-2 py-1 rounded text-slate-300">Shopee Recommended</span>
            </div>
            <div class="swiper mySwiper w-full h-full pb-8">
                <div class="swiper-wrapper" id="shopeeContainer">
                    </div>
                <div class="swiper-pagination"></div>
            </div>
        </div>

        <div class="lg:col-span-4 pro-card p-6 text-center">
            <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Tasbih Digital</h4>
            <div class="text-7xl font-mono font-bold text-white mb-4 cursor-pointer select-none drop-shadow-lg" onclick="countTasbih()" id="tasbihCount">0</div>
            <p class="text-xs text-amber-400 mb-6 animate-pulse">Tap angka untuk menghitung</p>
            <button onclick="resetTasbih()" class="px-6 py-2 border border-slate-600 rounded-full text-xs text-slate-400 hover:text-white hover:border-white transition">
                <i class="fa-solid fa-rotate-left mr-2"></i> Reset Hitungan
            </button>
        </div>
    </div>

    <div class="mb-16">
        <h3 class="text-white font-bold text-lg mb-6 border-l-4 border-amber-400 pl-3 flex items-center gap-2">
            Mutiara Kehidupan & Hikmah
            <span class="text-[10px] font-normal text-slate-400 ml-2 bg-white/5 px-2 py-1 rounded-full">(Ketuk kartu)</span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="insightsGrid">
            </div>
    </div>

</div>

<script type="application/json" id="cityData">{{ daftar_kota | tojson }}</script>

<script>
    // =========================================
    // 1. SYSTEM INIT
    // =========================================
    $(document).ready(function() {
        $('#kotaSelect').select2({ placeholder: "Cari Kota...", width: '100%' });

        // Logic Auto GPS & Fallback
        const savedCity = localStorage.getItem('userCity');
        if (savedCity) {
            $('#kotaSelect').val(savedCity).trigger('change');
            fetchSchedule(savedCity);
        } else {
            $('#kotaSelect').val('Jakarta').trigger('change'); // Default
            fetchSchedule('Jakarta');
            autoGPS(); // Background Check
        }

        $('#kotaSelect').on('change', function() {
            localStorage.setItem('userCity', this.value);
            fetchSchedule(this.value);
        });

        initSwiper();
        renderShop();
        renderInsights();
        fetchQuran();
    });

    // =========================================
    // 2. AUTO GPS (IMPROVED)
    // =========================================
    function autoGPS() {
        if (navigator.geolocation) {
            $('#gpsIcon').addClass('fa-spin');
            navigator.geolocation.getCurrentPosition(pos => {
                $.getJSON(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`, function(data) {
                    let detected = data.address.city || data.address.town || data.address.county || '';
                    detected = detected.replace(/(Kota|Kabupaten)\s+/i, '').trim();
                    
                    const options = Array.from(document.querySelectorAll('#kotaSelect option')).map(o => o.value);
                    const match = options.find(o => o.toLowerCase() === detected.toLowerCase()) || 
                                  options.find(o => o.toLowerCase().includes(detected.toLowerCase()));
                    
                    if (match) {
                        $('#kotaSelect').val(match).trigger('change');
                        $('#gpsIcon').removeClass('fa-spin text-amber-400').addClass('text-emerald-400');
                    } else {
                        $('#gpsIcon').removeClass('fa-spin');
                    }
                });
            }, () => { $('#gpsIcon').removeClass('fa-spin').addClass('text-red-500'); });
        }
    }

    // =========================================
    // 3. PRAYER LOGIC & PROGRESS BAR
    // =========================================
    let timer;
    function fetchSchedule(city) {
        if(!city) return;
        const d = new Date();
        const dateStr = `${d.getDate()}-${d.getMonth() + 1}-${d.getFullYear()}`;
        
        $.get(`https://api.aladhan.com/v1/timingsByCity/${dateStr}?city=${city}&country=Indonesia&method=20`, function(res) {
            const t = res.data.timings;
            const h = res.data.date.hijri;
            
            $('#hijriDate').text(`${h.day} ${h.month.en} ${h.year} H`);
            $('#dateMasehi').text(res.data.date.readable);
            renderGrid(t);
            startCountdown(t);
        });
    }

    function renderGrid(t) {
        const list = [
            {k:'Imsak', n:'Imsak', t:t.Imsak}, {k:'Fajr', n:'Subuh', t:t.Fajr}, 
            {k:'Dhuhr', n:'Dzuhur', t:t.Dhuhr}, {k:'Asr', n:'Ashar', t:t.Asr}, 
            {k:'Maghrib', n:'Maghrib', t:t.Maghrib}, {k:'Isha', n:'Isya', t:t.Isha}
        ];
        let html = '';
        list.forEach(p => {
            html += `
            <div id="card-${p.k}" class="time-card">
                <div class="text-[10px] font-bold uppercase text-slate-400 mb-1 tracking-widest">${p.n}</div>
                <div class="text-xl font-bold text-white font-serif">${p.t}</div>
            </div>`;
        });
        $('#prayerGrid').html(html);
    }

    function startCountdown(t) {
        if(timer) clearInterval(timer);
        const list = [
            {n:'Imsak', t:t.Imsak}, {n:'Subuh', t:t.Fajr}, {n:'Dzuhur', t:t.Dhuhr},
            {n:'Ashar', t:t.Asr}, {n:'Maghrib', t:t.Maghrib}, {n:'Isya', t:t.Isha}
        ];

        timer = setInterval(() => {
            const now = new Date();
            let next = null, prev = null, minDiff = Infinity;
            
            list.forEach((p, index) => {
                const [h, m] = p.t.split(':');
                const pt = new Date(); pt.setHours(h, m, 0);
                let diff = pt - now;
                
                // Active Class
                const id = p.n === 'Subuh' ? 'Fajr' : (p.n === 'Dzuhur' ? 'Dhuhr' : (p.n === 'Ashar' ? 'Asr' : (p.n === 'Isya' ? 'Isha' : p.n)));
                const el = $(`#card-${id}`);
                if(diff <= 0 && diff > -1200000) el.addClass('active');
                else el.removeClass('active');

                if (diff > 0 && diff < minDiff) { 
                    minDiff = diff; next = p; 
                    prev = list[index - 1] || list[list.length-1]; // Simple prev logic
                }
            });

            if (!next) {
                next = list[0];
                const [h, m] = next.t.split(':');
                const tmrw = new Date(); tmrw.setDate(now.getDate() + 1); tmrw.setHours(h, m, 0);
                minDiff = tmrw - now;
            }

            $('#nextPrayerName').text(next.n);
            const hh = Math.floor(minDiff / 3600000).toString().padStart(2, '0');
            const mm = Math.floor((minDiff % 3600000) / 60000).toString().padStart(2, '0');
            const ss = Math.floor((minDiff % 60000) / 1000).toString().padStart(2, '0');
            $('#countdown').text(`${hh}:${mm}:${ss}`);

            // Update Progress Bar
            let startT = new Date(); 
            // Simple approach for progress bar: assume 2 hour range max for visual, or calculate from prev
            // To keep it robust, just loop visual 0-100 based on last hour
            // Real implementation requires precise prev prayer timestamp which varies
            // Let's use a simpler visual cue based on minutes left in current hour vs minDiff
            const total = 100; 
            const progress = 100 - Math.min(100, (minDiff / (3600000 * 3)) * 100); // Scale based on 3 hours window
            $('#timeProgressBar').css('width', `${progress}%`);
            $('#nextPrayerLabel').text(next.n);

            // Alert
            const minsLeft = Math.floor(minDiff/60000);
            if(next.n === 'Imsak' && minsLeft <= 20) {
                $('#smartAlert').removeClass('hidden').addClass('flex').html('<i class="fa-solid fa-triangle-exclamation"></i> Waktu Imsak Segera Tiba!');
            } else {
                $('#smartAlert').addClass('hidden').removeClass('flex');
            }

        }, 1000);
    }

    // =========================================
    // 4. CONTENT & DATA
    // =========================================
    function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    const messages = [
        { cat: "Kehidupan", title: "Sabar", icon: "fa-leaf", content: "Sabar itu bukan berarti diam saat disakiti, tapi menahan diri dari amarah yang merusak." },
        { cat: "Motivasi", title: "Harapan", icon: "fa-mountain", content: "Allah tidak membebani seseorang melainkan sesuai dengan kesanggupannya." },
        { cat: "Sosial", title: "Lisan", icon: "fa-comments", content: "Keselamatan manusia ada pada penjagaan lisannya. Berbicaralah yang baik atau diam." },
        { cat: "Ibadah", title: "Sholat", icon: "fa-clock", content: "Amalan yang paling dicintai Allah adalah sholat pada waktunya." }
    ];

    const products = [
        { n: "Al-Quran", p: "Rp 85rb", i: "fa-book-quran" },
        { n: "Baju Koko", p: "Rp 120rb", i: "fa-shirt" },
        { n: "Mukena", p: "Rp 150rb", i: "fa-person-dress" },
        { n: "Sarung", p: "Rp 65rb", i: "fa-layer-group" },
        { n: "Kurma", p: "Rp 90rb", i: "fa-seedling" }
    ];

    function initSwiper() {
        new Swiper(".mySwiper", { slidesPerView: 2.2, spaceBetween: 15, freeMode: true, breakpoints: { 640: { slidesPerView: 3.5 }, 1024: { slidesPerView: 4.5 } } });
    }

    function renderShop() {
        let h = '';
        products.forEach(p => {
            h += `
            <div class="swiper-slide">
                <a href="https://shopee.co.id/search?keyword=${encodeURIComponent(p.n)}" target="_blank" class="product-card group">
                    <div class="h-24 bg-slate-100 rounded mb-2 flex items-center justify-center text-3xl text-slate-300 group-hover:text-amber-500 transition">
                        <i class="fa-solid ${p.i}"></i>
                    </div>
                    <div class="text-[11px] font-bold text-slate-800 truncate">${p.n}</div>
                    <div class="text-xs font-bold text-amber-600">${p.p}</div>
                </a>
            </div>`;
        });
        $('#shopeeContainer').html(h);
    }

    function renderInsights() {
        let h = '';
        messages.forEach(m => {
            h += `
            <div class="flip-container" onclick="this.classList.toggle('flipped')">
                <div class="flip-inner">
                    <div class="flip-front">
                        <i class="fa-solid ${m.icon} text-3xl text-amber-400 mb-4"></i>
                        <h4 class="font-bold text-white font-serif text-lg">${m.cat}</h4>
                        <span class="mt-4 text-[10px] text-slate-400 border border-slate-600 px-3 py-1 rounded-full uppercase tracking-wider">Ketuk</span>
                    </div>
                    <div class="flip-back">
                        <h4 class="font-bold text-amber-400 mb-2 text-sm uppercase border-b border-amber-500/30 pb-2 w-full">${m.title}</h4>
                        <p class="text-xs text-slate-300 leading-relaxed italic">"${m.content}"</p>
                    </div>
                </div>
            </div>`;
        });
        $('#insightsGrid').html(h);
    }

    function fetchQuran() {
        const id = Math.floor(Math.random() * 6236) + 1;
        $.get(`https://api.alquran.cloud/v1/ayah/${id}/editions/quran-uthmani,id.indonesian`, function(res) {
            $('#quranContent').html(`
                <p class="text-xl font-arab leading-loose mb-3 text-white drop-shadow-sm px-2" dir="rtl">${res.data[0].text}</p>
                <p class="text-[11px] text-slate-400 italic px-4">"${res.data[1].text}"</p>
                <div class="mt-4 text-[10px] font-bold text-emerald-400 uppercase tracking-widest border border-emerald-500/30 px-3 py-1 rounded-full inline-block">QS. ${res.data[0].surah.englishName}:${res.data[0].numberInSurah}</div>
            `);
        });
    }

    let c = 0;
    function countTasbih() { c++; $('#tasbihCount').text(c); }
    function resetTasbih() { c=0; $('#tasbihCount').text(0); }
</script>
{% endblock %}
