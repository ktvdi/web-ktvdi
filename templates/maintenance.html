<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAINTENANCE - KTVDI</title>
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f0505;
            --card-bg: rgba(40, 10, 10, 0.95);
            --red-primary: #ef4444;
            --red-dark: #7f1d1d;
            --caution-yellow: #f59e0b;
            --text-main: #fef2f2;
            --text-muted: #fca5a5;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #450a0a 0%, #000000 80%);
            min-height: 100vh;
            display: flex; flex-direction: column;
            color: var(--text-main); overflow-x: hidden;
        }

        /* --- TICKER --- */
        .ticker-wrapper { width: 100%; display: flex; flex-direction: column; position: relative; z-index: 50; }
        .ticker-bar {
            width: 100%; min-height: 35px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: 600; letter-spacing: 0.5px;
            padding: 5px 10px;
        }
        .bar-muslim { background: #280505; color: #fecaca; border-bottom: 1px solid #7f1d1d; }
        .bar-christian { background: #450a0a; color: var(--caution-yellow); border-bottom: 1px solid #7f1d1d; }
        .flip-content { animation: fadeIn 0.5s ease; text-align: center; }

        /* --- CONTAINER --- */
        .container {
            flex: 1; width: 100%; max-width: 850px; margin: 0 auto;
            display: flex; flex-direction: column; justify-content: center;
            padding: 20px; gap: 20px;
        }

        /* --- CARD --- */
        .card {
            background: var(--card-bg);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px; padding: 25px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            position: relative; overflow: hidden;
        }
        .card-top-accent {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: repeating-linear-gradient(45deg, var(--red-primary), var(--red-primary) 10px, #000 10px, #000 20px);
            border-bottom: 1px solid #000;
        }

        .logo { width: 100px; margin-bottom: 15px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }
        
        h1 { 
            font-size: 1.8rem; font-weight: 800; margin-bottom: 5px; 
            text-transform: uppercase; color: var(--red-primary); 
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }
        
        .subtitle { 
            color: var(--caution-yellow); font-size: 0.85rem; font-weight: 700; 
            letter-spacing: 2px; text-transform: uppercase; margin-bottom: 25px; 
            background: rgba(0,0,0,0.3); display: inline-block; padding: 5px 15px; border-radius: 50px;
        }

        /* ALERT BOX */
        .notice-box {
            background: rgba(127, 29, 29, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4); border-left: 4px solid var(--red-primary);
            border-radius: 8px; padding: 15px;
            display: flex; align-items: flex-start; gap: 15px; text-align: left;
        }
        .notice-icon { font-size: 1.5rem; color: var(--red-primary); margin-top: 2px; flex-shrink: 0; animation: blink 2s infinite; }
        .notice-title { color: var(--red-primary); font-size: 0.95rem; font-weight: 800; margin-bottom: 4px; text-transform: uppercase; }
        .notice-desc { font-size: 0.85rem; color: #fecaca; line-height: 1.5; }

        /* --- BIG CLOCK (PENGGANTI COUNTDOWN) --- */
        .main-clock-area {
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(239, 68, 68, 0.2);
            padding-bottom: 20px;
        }
        .realtime-clock {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3rem; font-weight: 800;
            color: #fef2f2; text-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
            line-height: 1; margin-bottom: 5px;
        }
        .realtime-date {
            font-size: 0.9rem; font-weight: 600; color: var(--caution-yellow);
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- GRID --- */
        .grid-4 { 
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 10px; width: 100%;
        }
        
        .stat-box {
            background: rgba(0,0,0,0.2); border: 1px solid rgba(239, 68, 68, 0.15);
            border-radius: 8px; padding: 10px 5px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 75px; position: relative;
        }
        .stat-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700; color: white; word-break: break-word; }
        .text-accent { color: var(--caution-yellow); }

        /* PRAYER COUNTDOWN BOX SPECIFIC */
        .prayer-box { background: rgba(127, 29, 29, 0.3); border-color: var(--caution-yellow); }
        .prayer-city { font-size: 0.6rem; font-weight: 800; color: var(--caution-yellow); margin-bottom: 2px; }
        .prayer-name { font-size: 0.7rem; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .prayer-time { font-size: 1.1rem; color: var(--red-primary); font-weight: 800; }

        /* BATTERY */
        .bat-container { 
            grid-column: span 4; 
            position: relative; overflow: hidden; background: rgba(0,0,0,0.4); padding: 0 !important; height: 40px; 
            display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.2);
        }
        .bat-fill {
            position: absolute; top:0; left:0; height: 100%; width: 0%; z-index: 0;
            background: repeating-linear-gradient(45deg, rgba(220, 38, 38, 0.4), rgba(220, 38, 38, 0.4) 10px, rgba(185, 28, 28, 0.5) 10px, rgba(185, 28, 28, 0.5) 20px);
            border-right: 2px solid var(--red-primary); transition: width 1s ease;
        }
        .bat-text { position: relative; z-index: 1; font-size: 0.8rem; font-weight: 700; display: flex; gap: 8px; align-items: center; color: white; }

        /* --- NEWS --- */
        .news-wrapper {
            width: 100%; max-width: 800px; margin: 0 auto 30px auto;
            background: #200505; border: 1px solid #7f1d1d; border-radius: 8px;
            display: flex; overflow: hidden; position: relative; min-height: 100px;
        }
        .news-badge {
            width: 90px; background: var(--red-dark); color: white; border-right: 1px solid #991b1b;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 800; text-align: center; flex-shrink: 0; position: absolute; top: 0; left: 0; bottom: 0; z-index: 2;
        }
        .news-content-area { flex: 1; margin-left: 90px; position: relative; }
        .news-slide {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px 20px;
            display: flex; flex-direction: column; align-items: flex-start;
            opacity: 0; transform: translateY(20px); transition: all 0.5s; visibility: hidden;
        }
        .news-slide.active { opacity: 1; transform: translateY(0); visibility: visible; }
        
        .news-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; color: white; font-weight: 700; text-transform: uppercase; }
        .time-badge { 
            font-size: 0.7rem; color: var(--caution-yellow); border: 1px solid var(--caution-yellow); 
            padding: 1px 6px; border-radius: 4px; font-weight: 600; display: flex; align-items: center; gap: 4px;
        }
        .headline { font-size: 0.95rem; font-weight: 600; color: #fef2f2; margin-bottom: 8px; }
        .source { font-size: 0.75rem; color: #fca5a5; display: flex; align-items: center; gap: 6px; }

        /* COLORS */
        .bg-INFO { background: #b91c1c; } .bg-NASIONAL { background: #991b1b; } .bg-DAERAH { background: #d97706; }
        .bg-TEKNOLOGI { background: #be123c; } .bg-LALU { background: #dc2626; } .bg-HIMBAUAN { background: #ea580c; animation: pulse 2s infinite; }

        .footer { text-align: center; font-size: 0.75rem; color: #7f1d1d; padding-bottom: 20px; font-weight: bold; }

        /* OVERLAY */
        #anthem-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999; display: none;
            justify-content: center; align-items: center; animation: fadeIn 1s;
        }
        .anthem-content { text-align: center; color: white; padding: 20px; border: 2px solid var(--red-primary); border-radius: 10px; max-width: 90%; background: #200505; }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* MOBILE */
        @media (max-width: 480px) {
            .container { padding: 15px; }
            .realtime-clock { font-size: 2.2rem; }
            .grid-4 { grid-template-columns: 1fr 1fr; }
            .bat-container { grid-column: span 2; }
            .news-wrapper { min-height: 120px; }
            .news-badge { width: 60px; font-size: 0.6rem; }
            .news-content-area { margin-left: 60px; }
            .headline { font-size: 0.85rem; }
        }
    </style>
</head>
<body>

    <div id="anthem-overlay">
        <div class="anthem-content">
            <h1 style="color: var(--red-primary); margin-bottom: 20px;">ðŸ‡®ðŸ‡© PUKUL 10.00 WIB</h1>
            <p>Mohon berdiri sejenak dan menyanyikan<br>Lagu Kebangsaan <b>Indonesia Raya</b>.</p>
            <i class="fas fa-music" style="font-size: 3rem; margin-top: 20px; color: var(--red-primary);"></i>
        </div>
    </div>

    <div class="ticker-wrapper">
        <div class="ticker-bar bar-muslim">
            <div class="flip-content" id="ticker-prayer">
                <i class="fas fa-mosque" style="color:var(--caution-yellow); margin-right:5px;"></i> MEMUAT DATA TICKER...
            </div>
        </div>
        <div class="ticker-bar bar-christian">
            <div class="flip-content" id="misa-display">
                <i class="fas fa-church" style="margin-right:5px;"></i> MEMUAT JADWAL MISA...
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-top-accent"></div>
            <img src="{{ url_for('static', filename='icons/icon-192.png') }}" alt="Logo" class="logo">
            <h1>SISTEM DALAM PERBAIKAN</h1>
            <div class="subtitle"><i class="fas fa-triangle-exclamation"></i> MAINTENANCE MODE <i class="fas fa-triangle-exclamation"></i></div>

            <div class="notice-box">
                <i class="fas fa-triangle-exclamation notice-icon"></i>
                <div>
                    <div class="notice-title">STATUS: MAINTENANCE DARURAT</div>
                    <div class="notice-desc">
                        Mohon maaf, akses ditutup sementara. Saat ini sedang dilakukan perbaikan menyeluruh pada database dan jaringan. Tim NOC sedang berupaya memulihkan layanan secepatnya.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="padding: 20px;">
            <div class="main-clock-area">
                <div class="realtime-clock" id="big-clock">00:00:00</div>
                <div class="realtime-date" id="big-date">SENIN, 1 JANUARI</div>
            </div>

            <div class="grid-4">
                <div class="stat-box prayer-box" id="prayer-flip-box">
                    <div class="prayer-city" id="pf-city">MEMUAT...</div>
                    <div class="prayer-name" id="pf-name">MENGHITUNG</div>
                    <div class="prayer-time" id="pf-time">--:--:--</div>
                </div>

                <div class="stat-box"><span class="stat-lbl">LOKASI</span><span class="stat-val text-accent" id="loc">...</span></div>
                <div class="stat-box"><span class="stat-lbl">PROVIDER</span><span class="stat-val text-accent" id="isp">...</span></div>
                <div class="stat-box"><span class="stat-lbl">DEVICE</span><span class="stat-val" id="dev">...</span></div>
                
                <div class="stat-box bat-container">
                    <div class="bat-fill" id="bat-bar"></div>
                    <div class="bat-text">
                        <span id="bat-txt">--%</span> <i class="fas fa-bolt" id="bat-icon" style="display:none; color:var(--caution-yellow);"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="news-wrapper" id="news-container">
        <div class="news-badge">
            <i class="fas fa-circle-exclamation" style="font-size: 1.2rem; margin-bottom: 5px;"></i>
            URGENT
        </div>
        <div class="news-content-area" id="news-viewport">
            <div class="news-slide active">
                <div class="news-header"><span class="tag bg-INFO">INFO</span></div>
                <div class="headline">MENGHUBUNGKAN KE SERVER BERITA DARURAT...</div>
                <div class="source"><i class="fas fa-circle-notch fa-spin"></i> SYSTEM ALERT</div>
            </div>
        </div>
    </div>

    <div class="footer">&copy; 2025 Komunitas TV Digital Indonesia.</div>

    <script id="news-data" type="application/json">{{ news_list | tojson }}</script>

    <script>
        // --- 1. POPUP 10.00 WIB ---
        setInterval(() => {
            const now = new Date();
            const h = parseInt(now.toLocaleTimeString('en-US', {timeZone: 'Asia/Jakarta', hour12: false}).split(':')[0]);
            const m = parseInt(now.toLocaleTimeString('en-US', {timeZone: 'Asia/Jakarta', hour12: false}).split(':')[1]);
            document.getElementById('anthem-overlay').style.display = (h === 10 && m < 2) ? 'flex' : 'none';
        }, 10000);

        // --- 2. JAM UTAMA (BIG REALTIME CLOCK) ---
        function updateBigClock() {
            const now = new Date();
            const optionsDate = { weekday: 'long', day: 'numeric', month: 'long', timeZone: 'Asia/Jakarta' };
            const optionsTime = { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Jakarta' };
            
            document.getElementById('big-clock').innerText = now.toLocaleTimeString('id-ID', optionsTime).replace(/\./g, ':');
            document.getElementById('big-date').innerText = now.toLocaleDateString('id-ID', optionsDate).toUpperCase();
        }
        setInterval(updateBigClock, 1000);
        updateBigClock();

        // --- 3. LOGIKA FLIP KOTA & COUNTDOWN SHOLAT (COMPLEX) ---
        const prayerCities = ["JAKARTA", "BANDUNG", "SEMARANG", "SURABAYA", "YOGYAKARTA", "MEDAN", "MAKASSAR", "DENPASAR", "JAYAPURA", "ACEH"];
        let currentCityIndex = 0;
        let activeCitySchedule = null; // Menyimpan jadwal kota yang sedang tampil
        let activeCityName = "";

        // Fungsi fetch jadwal kota tertentu
        function fetchPrayerForCity(city) {
            const dateStr = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
            // Menampilkan status loading
            document.getElementById('pf-city').innerText = city;
            document.getElementById('pf-name').innerText = "MEMUAT DATA...";
            document.getElementById('pf-time').innerText = "--:--:--";
            
            activeCityName = city;

            fetch(`https://api.aladhan.com/v1/timingsByCity/${dateStr}?city=${city}&country=Indonesia&method=20`)
            .then(r => r.json())
            .then(d => {
                activeCitySchedule = d.data.timings;
                // Update Ticker Atas Sekalian (agar sinkron)
                const t = d.data.timings;
                document.getElementById('ticker-prayer').innerHTML = `<i class="fas fa-mosque" style="color:#fbbf24"></i> ${city}: SUBUH ${t.Fajr} | DZUHUR ${t.Dhuhr} | ASHAR ${t.Asr} | MAGHRIB ${t.Maghrib} | ISYA ${t.Isha}`;
            })
            .catch(err => {
                activeCitySchedule = null;
                document.getElementById('pf-name').innerText = "GAGAL MEMUAT";
            });
        }

        // Fungsi menghitung mundur ke sholat berikutnya
        function updatePrayerCountdown() {
            if(!activeCitySchedule) return;

            const now = new Date(); // Waktu device (asumsi sinkron WIB/local)
            const prayerNames = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
            const displayNames = {'Fajr':'SUBUH', 'Dhuhr':'DZUHUR', 'Asr':'ASHAR', 'Maghrib':'MAGHRIB', 'Isha':'ISYA'};
            
            let nextPrayerTime = null;
            let nextPrayerName = "";

            // Cari sholat berikutnya hari ini
            for(let name of prayerNames) {
                let timeStr = activeCitySchedule[name];
                let [h, m] = timeStr.split(':');
                let pTime = new Date();
                pTime.setHours(h, m, 0, 0);

                if(pTime > now) {
                    nextPrayerTime = pTime;
                    nextPrayerName = name;
                    break;
                }
            }

            // Jika semua sholat hari ini lewat, targetnya Subuh besok
            if(!nextPrayerTime) {
                let timeStr = activeCitySchedule['Fajr'];
                let [h, m] = timeStr.split(':');
                nextPrayerTime = new Date();
                nextPrayerTime.setDate(nextPrayerTime.getDate() + 1);
                nextPrayerTime.setHours(h, m, 0, 0);
                nextPrayerName = 'Fajr';
            }

            // Hitung selisih
            const diff = nextPrayerTime - now;
            
            if(diff < 0) {
                // Edge case saat detik pas berganti
                document.getElementById('pf-time').innerText = "00:00:00";
                return;
            }

            const hh = Math.floor(diff / (1000 * 60 * 60));
            const mm = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const ss = Math.floor((diff % (1000 * 60)) / 1000);

            // Tampilkan
            const pad = (n) => n.toString().padStart(2, '0');
            document.getElementById('pf-city').innerText = activeCityName; // Pastikan nama kota tetap
            document.getElementById('pf-name').innerText = `MENUJU ${displayNames[nextPrayerName]}`;
            document.getElementById('pf-time').innerText = `-${pad(hh)}:${pad(mm)}:${pad(ss)}`;
            document.getElementById('pf-time').style.color = (diff < 600000) ? '#f59e0b' : '#ef4444'; // Kuning jika < 10 menit
        }

        // Loop Ganti Kota (Setiap 15 Detik)
        fetchPrayerForCity(prayerCities[0]); // First run
        setInterval(() => {
            currentCityIndex = (currentCityIndex + 1) % prayerCities.length;
            
            // Efek Blink saat ganti kota
            const box = document.getElementById('prayer-flip-box');
            box.style.opacity = 0;
            setTimeout(() => {
                fetchPrayerForCity(prayerCities[currentCityIndex]);
                box.style.opacity = 1;
            }, 500);

        }, 15000);

        // Loop Hitung Mundur (Setiap 1 Detik)
        setInterval(updatePrayerCountdown, 1000);


        // --- 4. DATA LAIN (Misa, ISP, Batere, News) ---
        const misaData = [
            {loc:"KATEDRAL JAKARTA", t:"06.00, 08.30, 16.30"}, {loc:"KATEDRAL SEMARANG", t:"05.30, 07.00, 16.30"},
            {loc:"KATEDRAL SURABAYA", t:"07.00, 09.00, 18.30"}, {loc:"KATEDRAL MEDAN", t:"07.00, 09.00, 17.00"}
        ];
        let misaIdx = 0;
        function updateMisa() {
            const m = misaData[misaIdx];
            const elMisa = document.getElementById('misa-display');
            elMisa.style.opacity = 0;
            setTimeout(() => {
                elMisa.innerHTML = `<i class="fas fa-church"></i> ${m.loc} : ${m.t} WIB`;
                elMisa.style.opacity = 1;
            }, 500);
            misaIdx = (misaIdx + 1) % misaData.length;
        }
        setInterval(updateMisa, 8000);
        updateMisa();

        // ISP & Device
        fetch('https://ipapi.co/json/').then(r=>r.json()).then(d=>{
            document.getElementById("loc").innerText = (d.city||"INDONESIA").toUpperCase();
            document.getElementById("isp").innerText = (d.org||"ONLINE").toUpperCase();
        }).catch(()=>{ document.getElementById("loc").innerText="LOKASI"; document.getElementById("isp").innerText="ONLINE"; });

        const ua = navigator.userAgent;
        document.getElementById("dev").innerText = /Android/i.test(ua) ? "ANDROID" : /iPhone/i.test(ua) ? "IPHONE" : "PC/LAPTOP";

        // Battery
        if(navigator.getBattery) {
            navigator.getBattery().then(b => {
                function up() {
                    const l = Math.round(b.level*100);
                    document.getElementById("bat-txt").innerText = `${l}%`;
                    document.getElementById("bat-bar").style.width = `${l}%`;
                    document.getElementById("bat-icon").style.display = b.charging ? 'inline' : 'none';
                }
                up(); b.addEventListener('levelchange', up); b.addEventListener('chargingchange', up);
            });
        }

        // News Engine
        let newsData = [];
        try { newsData = JSON.parse(document.getElementById('news-data').textContent); } catch(e){}

        setInterval(async () => {
            try {
                const res = await fetch('/api/news-live');
                const newData = await res.json();
                if(newData.length > 0) newsData = newData;
            } catch(e){}
        }, 60000);

        if(newsData.length > 0) {
            const vp = document.getElementById('news-viewport');
            const container = document.getElementById('news-container');
            let cIdx = 0;

            function showSlide(idx) {
                const item = newsData[idx];
                const div = document.createElement('div');
                div.className = 'news-slide active'; 
                
                let bg = 'bg-INFO';
                if(item.category=='NASIONAL') bg='bg-NASIONAL';
                if(item.category=='KEPOLISIAN') bg='bg-KEPOLISIAN';
                if(item.category=='DAERAH') bg='bg-DAERAH';
                if(item.category=='TEKNOLOGI') bg='bg-TEKNOLOGI';
                if(item.category=='LALU LINTAS') bg='bg-LALU';
                if(item.category=='HIMBAUAN') bg='bg-HIMBAUAN';
                if(item.category=='OLAHRAGA') bg='bg-OLAHRAGA';

                div.innerHTML = `
                    <div class="news-header">
                        <span class="tag ${bg}">${item.category}</span>
                        <span class="time-badge"><i class="far fa-clock"></i> ${item.date}</span>
                    </div>
                    <div class="headline">${item.headline}</div>
                    <div class="source"><i class="fas fa-rss"></i> ${item.source}</div>
                `;
                
                vp.innerHTML = '';
                vp.appendChild(div);

                setTimeout(() => {
                    const h = div.scrollHeight + 30; 
                    const minH = window.innerWidth < 480 ? 120 : 100;
                    container.style.height = `${Math.max(minH, h)}px`;
                }, 20);
            }
            
            showSlide(0);
            setInterval(() => {
                const current = vp.querySelector('.news-slide');
                if(current) { current.classList.remove('active'); current.classList.add('exit'); }
                cIdx = (cIdx + 1) % newsData.length;
                setTimeout(() => { showSlide(cIdx); }, 500); 
            }, 8000); 
        }
    </script>
</body>
</html>
