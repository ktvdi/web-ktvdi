<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SEDANG PERBAIKAN - KTVDI</title>
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0b1120;
            --card-bg: rgba(30, 41, 59, 0.98); /* Lebih solid agar tulisan jelas */
            --blue-primary: #2563eb;
            --blue-dark: #1e40af;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-gold: #fbbf24;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0b1120 70%);
            min-height: 100vh;
            display: flex; flex-direction: column;
            color: var(--text-main); overflow-x: hidden;
        }

        /* --- TOP TICKER (ADAPTIF) --- */
        .ticker-wrapper { width: 100%; display: flex; flex-direction: column; position: relative; z-index: 50; }
        
        .ticker-bar {
            width: 100%; 
            min-height: 35px; /* Pakai Min-Height agar bisa membesar di HP */
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: 600; letter-spacing: 0.5px;
            padding: 5px 10px; /* Tambah padding */
        }
        
        .bar-muslim { background: #0f172a; color: #e2e8f0; border-bottom: 1px solid #334155; }
        .bar-christian { background: #1e293b; color: var(--accent-gold); border-bottom: 1px solid #334155; }
        
        .flip-text { 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            animation: fadeIn 0.5s ease; width: 100%;
            text-align: center;
        }
        
        /* --- MAIN CONTENT --- */
        .container {
            flex: 1; width: 100%; max-width: 850px; margin: 0 auto;
            display: flex; flex-direction: column; justify-content: center;
            padding: 20px; gap: 20px;
        }

        /* --- CARD STYLE --- */
        .card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 25px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative; overflow: hidden;
        }
        .card-top-accent {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--blue-primary), var(--blue-dark));
        }

        .logo { width: 100px; margin-bottom: 15px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        
        h1 { font-size: 1.8rem; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; line-height: 1.2; }
        .subtitle { color: var(--blue-primary); font-size: 0.85rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 25px; }

        /* ALERT BOX - FORMAL */
        .notice-box {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 8px; padding: 15px;
            display: flex; align-items: flex-start; gap: 15px; text-align: left;
        }
        .notice-icon { font-size: 1.2rem; color: var(--blue-primary); margin-top: 3px; flex-shrink: 0; }
        .notice-title { color: var(--blue-primary); font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
        .notice-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }

        /* --- GRID SYSTEM (RESPONSIVE FIX) --- */
        .grid-4 { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); /* Default PC: 4 Kolom */
            gap: 10px; width: 100%; margin-top: 20px; 
        }
        
        .stat-box {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px; padding: 12px 5px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 70px; /* Minimal height agar tidak gepeng */
        }
        .stat-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: white; word-break: break-word; }
        .text-green { color: #4ade80; }

        /* BATTERY BAR */
        .bat-container { 
            grid-column: span 4; /* Default PC: Full Width */
            position: relative; overflow: hidden; background: rgba(0,0,0,0.3); padding: 0 !important; height: 40px; display: flex; align-items: center; justify-content: center; 
        }
        .bat-fill {
            position: absolute; top:0; left:0; height: 100%; width: 0%; z-index: 0;
            background: repeating-linear-gradient(45deg, rgba(37,99,235,0.2), rgba(37,99,235,0.2) 10px, rgba(37,99,235,0.3) 10px, rgba(37,99,235,0.3) 20px);
            transition: width 1s ease; border-right: 2px solid var(--blue-primary);
        }
        .bat-text { position: relative; z-index: 1; font-size: 0.8rem; font-weight: 700; display: flex; gap: 8px; align-items: center; }

        /* --- NEWS FLIP (RE-DESIGNED FOR SPACE) --- */
        .news-wrapper {
            width: 100%; max-width: 800px; margin: 0 auto 30px auto;
            background: #0f172a; border: 1px solid #334155; border-radius: 8px;
            display: flex; overflow: hidden; position: relative;
            min-height: 100px; transition: height 0.3s ease; 
        }
        
        .news-badge {
            width: 90px; background: var(--blue-primary); color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 800; text-align: center; flex-shrink: 0;
            position: absolute; top: 0; left: 0; bottom: 0; z-index: 2;
        }
        
        .news-content-area {
            flex: 1; margin-left: 90px; position: relative;
        }

        .news-slide {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 20px;
            display: flex; flex-direction: column; align-items: flex-start;
            opacity: 0; transform: translateY(20px); transition: all 0.5s cubic-bezier(0.22, 1, 0.36, 1);
            visibility: hidden;
        }
        .news-slide.active { opacity: 1; transform: translateY(0); visibility: visible; }
        
        /* HEADER BERITA (TAG & WAKTU) */
        .news-header { 
            display: flex; align-items: center; gap: 12px; /* GAP TEGAS AGAR TIDAK NEMPEL */
            margin-bottom: 8px; flex-wrap: wrap; 
        }
        .tag { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; color: white; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
        .time-badge { 
            font-size: 0.7rem; color: #4ade80; border: 1px solid #4ade80; 
            padding: 1px 6px; border-radius: 4px; font-weight: 600; 
            display: flex; align-items: center; gap: 4px; white-space: nowrap;
        }
        
        /* Colors */
        .bg-NASIONAL { background: #0284c7; } .bg-DAERAH { background: #d97706; }
        .bg-TEKNOLOGI { background: #7c3aed; } .bg-OLAHRAGA { background: #16a34a; }
        .bg-LALU { background: #dc2626; } .bg-KEPOLISIAN { background: #475569; }
        .bg-HIMBAUAN { background: #ea580c; animation: pulse 2s infinite; }

        .headline { 
            font-size: 0.95rem; font-weight: 600; line-height: 1.5; color: #f1f5f9; 
            margin-bottom: 8px; width: 100%;
        }
        .source { font-size: 0.75rem; color: #94a3b8; display: flex; align-items: center; gap: 6px; }

        .footer { text-align: center; font-size: 0.75rem; color: #64748b; padding-bottom: 20px; }

        /* OVERLAY 10.00 */
        #anthem-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999; display: none;
            justify-content: center; align-items: center; animation: fadeIn 1s;
        }
        .anthem-content { text-align: center; color: white; padding: 20px; border: 2px solid #ffd700; border-radius: 10px; max-width: 90%; }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- MOBILE RESPONSIVE (CRITICAL FIX) --- */
        @media (max-width: 480px) {
            .container { padding: 15px; gap: 15px; }
            h1 { font-size: 1.4rem; }
            
            /* Notice Box Stack */
            .notice-box { flex-direction: column; gap: 10px; }
            
            /* Grid jadi 2 kolom di HP agar tidak gepeng */
            .grid-4 { grid-template-columns: 1fr 1fr; }
            .bat-container { grid-column: span 2; } /* Baterai tetap lebar penuh di grid 2 kolom */

            /* Ticker Mobile Adjustments */
            .news-wrapper { min-height: 120px; } /* Min Height lebih besar di HP */
            .news-badge { width: 60px; font-size: 0.6rem; }
            .news-content-area { margin-left: 60px; }
            .news-slide { padding: 12px 10px; }
            .headline { font-size: 0.85rem; }
            .news-header { gap: 8px; } /* Jarak antar tag di HP */
            
            /* Top Bar Wrapping */
            .ticker-bar { height: auto; padding: 8px; }
            .flip-content { white-space: normal; flex-wrap: wrap; justify-content: center; line-height: 1.3; }
        }
    </style>
</head>
<body>

    <div id="anthem-overlay">
        <div class="anthem-content">
            <h1 style="color: #ffd700; margin-bottom: 20px;">ðŸ‡®ðŸ‡© PUKUL 10.00 WIB</h1>
            <p>Mohon berdiri sejenak dan menyanyikan<br>Lagu Kebangsaan <b>Indonesia Raya</b>.</p>
            <i class="fas fa-music" style="font-size: 3rem; margin-top: 20px; color: #ffd700;"></i>
        </div>
    </div>

    <div class="ticker-wrapper">
        <div class="ticker-bar bar-muslim">
            <div class="flip-content" id="prayer-display">
                <i class="fas fa-mosque" style="color:#fbbf24; margin-right:5px;"></i> MEMUAT JADWAL SHOLAT...
            </div>
        </div>
        <div class="ticker-bar bar-christian">
            <div class="flip-content" id="misa-display">
                <i class="fas fa-church" style="margin-right:5px;"></i> MEMUAT JADWAL MISA...
            </div>
        </div>
    </div>

    <div class="container">
        
        <div class="card">
            <div class="card-top-accent"></div>
            <img src="{{ url_for('static', filename='icons/icon-192.png') }}" alt="Logo" class="logo">
            <h1>PEMELIHARAAN SISTEM</h1>
            <div class="subtitle">JARINGAN & KEAMANAN TERPADU</div>

            <div class="notice-box">
                <i class="fas fa-server notice-icon"></i>
                <div>
                    <div class="notice-title">STATUS: PEMELIHARAAN TERJADWAL</div>
                    <div class="notice-desc">
                        Mohon maaf atas ketidaknyamanan ini. Saat ini sedang terjadi kendala jaringan pada ISP terkait serta proses penyempurnaan database internal. Penanganan membutuhkan waktu karena Tim NOC Komunitas sedang cuti libur Natal & Tahun Baru. Kami memohon kesabaran rekan-rekan semua hingga layanan kembali normal. Terima kasih.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="padding: 20px;">
            <div style="font-size: 0.7rem; color: var(--text-muted); letter-spacing: 2px; margin-bottom: 15px;">MENUJU 2026</div>
            <div class="grid-4">
                <div class="stat-box"><span class="stat-val" id="d">00</span><span class="stat-lbl">HARI</span></div>
                <div class="stat-box"><span class="stat-val" id="h">00</span><span class="stat-lbl">JAM</span></div>
                <div class="stat-box"><span class="stat-val" id="m">00</span><span class="stat-lbl">MENIT</span></div>
                <div class="stat-box"><span class="stat-val" id="s">00</span><span class="stat-lbl">DETIK</span></div>
            </div>

            <div class="grid-4" style="margin-top: 15px;">
                <div class="stat-box"><span class="stat-lbl">WAKTU</span><span class="stat-val" id="clock">00:00:00</span></div>
                <div class="stat-box"><span class="stat-lbl">LOKASI</span><span class="stat-val text-green" id="loc">...</span></div>
                <div class="stat-box"><span class="stat-lbl">PROVIDER</span><span class="stat-val text-green" id="isp">...</span></div>
                <div class="stat-box"><span class="stat-lbl">DEVICE</span><span class="stat-val" id="dev">...</span></div>
                
                <div class="stat-box bat-container">
                    <div class="bat-fill" id="bat-bar"></div>
                    <div class="bat-text">
                        <span id="bat-txt">--%</span> <i class="fas fa-bolt" id="bat-icon" style="display:none; color:#fbbf24;"></i>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="news-wrapper" id="news-container">
        <div class="news-badge">
            <i class="fas fa-newspaper" style="font-size: 1.2rem; margin-bottom: 5px;"></i>
            NEWS
        </div>
        <div class="news-content-area" id="news-viewport">
            <div class="news-slide active">
                <div class="news-header"><span class="tag bg-INFO">INFO</span></div>
                <div class="headline">MENGHUBUNGKAN KE SERVER BERITA NASIONAL...</div>
                <div class="source"><i class="fas fa-circle-notch fa-spin"></i> SYSTEM</div>
            </div>
        </div>
    </div>

    <div class="footer">&copy; 2025 Komunitas TV Digital Indonesia.</div>

    <script id="news-data" type="application/json">{{ news_list | tojson }}</script>

    <script>
        // --- 1. POPUP 10.00 WIB ---
        setInterval(() => {
            const now = new Date();
            const h = parseInt(now.toLocaleTimeString('en-US', {timeZone: 'Asia/Jakarta', hour12: false}).split(':')[0]);
            const m = parseInt(now.toLocaleTimeString('en-US', {timeZone: 'Asia/Jakarta', hour12: false}).split(':')[1]);
            document.getElementById('anthem-overlay').style.display = (h === 10 && m < 2) ? 'flex' : 'none';
        }, 10000);

        // --- 2. JADWAL SHOLAT & MISA ---
        const cities = ["PEKALONGAN", "PURWODADI", "JAKARTA", "SURABAYA", "BANDUNG", "SEMARANG", "MEDAN", "MAKASSAR", "DENPASAR", "JAYAPURA"];
        const misaData = [
            {loc:"KATEDRAL JAKARTA", t:"06.00, 08.30, 16.30"}, {loc:"KATEDRAL SEMARANG", t:"05.30, 07.00, 16.30"},
            {loc:"KATEDRAL SURABAYA", t:"07.00, 09.00, 18.30"}, {loc:"KATEDRAL MEDAN", t:"07.00, 09.00, 17.00"}
        ];

        let cityIdx = 0;
        let misaIdx = 0;

        function updateTickers() {
            // Sholat
            const city = cities[cityIdx];
            const dateStr = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
            fetch(`https://api.aladhan.com/v1/timingsByCity/${dateStr}?city=${city}&country=Indonesia&method=20`)
                .then(r => r.json()).then(d => {
                    const t = d.data.timings;
                    const el = document.getElementById('prayer-display');
                    el.style.opacity = 0;
                    setTimeout(() => {
                        el.innerHTML = `<i class="fas fa-mosque icon-gold"></i> ${city} : IMSAK ${t.Imsak} | SUBUH ${t.Fajr} | MAGHRIB ${t.Maghrib}`;
                        el.style.opacity = 1;
                    }, 500);
                }).catch(() => {});
            cityIdx = (cityIdx + 1) % cities.length;

            // Misa
            const m = misaData[misaIdx];
            const elMisa = document.getElementById('misa-display');
            elMisa.style.opacity = 0;
            setTimeout(() => {
                elMisa.innerHTML = `<i class="fas fa-church icon-gold"></i> ${m.loc} : ${m.t} WIB`;
                elMisa.style.opacity = 1;
            }, 500);
            misaIdx = (misaIdx + 1) % misaData.length;
        }
        updateTickers();
        setInterval(updateTickers, 8000);

        // --- 3. SYSTEM INFO ---
        setInterval(() => {
            const now = new Date();
            document.getElementById("clock").innerText = now.toLocaleTimeString('id-ID', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
            
            // Countdown
            const diff = new Date("Jan 1, 2026 00:00:00").getTime() - now.getTime();
            if(diff>0) {
                document.getElementById("d").innerText = Math.floor(diff/864e5);
                document.getElementById("h").innerText = Math.floor((diff%864e5)/36e5);
                document.getElementById("m").innerText = Math.floor((diff%36e5)/6e4);
                document.getElementById("s").innerText = Math.floor((diff%6e4)/1e3);
            }
        }, 1000);

        // ISP & Device
        fetch('https://ipapi.co/json/').then(r=>r.json()).then(d=>{
            document.getElementById("loc").innerText = (d.city||"INDONESIA").toUpperCase();
            document.getElementById("isp").innerText = (d.org||"ONLINE").toUpperCase();
        }).catch(()=>{ document.getElementById("loc").innerText="LOKASI"; document.getElementById("isp").innerText="ONLINE"; });

        const ua = navigator.userAgent;
        document.getElementById("dev").innerText = /Android/i.test(ua) ? "ANDROID" : /iPhone/i.test(ua) ? "IPHONE" : "PC/LAPTOP";

        // Battery
        if(navigator.getBattery) {
            navigator.getBattery().then(b => {
                function up() {
                    const l = Math.round(b.level*100);
                    document.getElementById("bat-txt").innerText = `${l}%`;
                    document.getElementById("bat-bar").style.width = `${l}%`;
                    document.getElementById("bat-icon").style.display = b.charging ? 'inline' : 'none';
                }
                up(); b.addEventListener('levelchange', up); b.addEventListener('chargingchange', up);
            });
        }

        // --- 4. NEWS ENGINE (AUTO UPDATE + AUTO HEIGHT) ---
        let newsData = [];
        try { newsData = JSON.parse(document.getElementById('news-data').textContent); } catch(e){}

        // Auto Fetch every 60s
        setInterval(async () => {
            try {
                const res = await fetch('/api/news-live');
                const newData = await res.json();
                if(newData.length > 0) newsData = newData;
            } catch(e){}
        }, 60000);

        if(newsData.length > 0) {
            const vp = document.getElementById('news-viewport');
            const container = document.getElementById('news-container');
            let cIdx = 0;

            function showSlide(idx) {
                const item = newsData[idx];
                const div = document.createElement('div');
                div.className = 'news-slide active'; 
                
                let bg = 'bg-INFO';
                if(item.category=='NASIONAL') bg='bg-NASIONAL';
                if(item.category=='KEPOLISIAN') bg='bg-KEPOLISIAN';
                if(item.category=='DAERAH') bg='bg-DAERAH';
                if(item.category=='TEKNOLOGI') bg='bg-TEKNOLOGI';
                if(item.category=='LALU LINTAS') bg='bg-LALU';
                if(item.category=='HIMBAUAN') bg='bg-HIMBAUAN';
                if(item.category=='OLAHRAGA') bg='bg-OLAHRAGA';

                div.innerHTML = `
                    <div class="news-header">
                        <span class="tag ${bg}">${item.category}</span>
                        <span class="time-badge"><i class="far fa-clock"></i> ${item.date}</span>
                    </div>
                    <div class="headline">${item.headline}</div>
                    <div class="source"><i class="fas fa-rss"></i> ${item.source}</div>
                `;
                
                vp.innerHTML = '';
                vp.appendChild(div);

                // Auto Height Logic (Delay for rendering)
                setTimeout(() => {
                    const h = div.scrollHeight + 30; // +Padding
                    // Min Height: HP = 120px, PC = 100px
                    const minH = window.innerWidth < 480 ? 120 : 100;
                    container.style.height = `${Math.max(minH, h)}px`;
                }, 20);
            }
            
            showSlide(0);
            setInterval(() => {
                const current = vp.querySelector('.news-slide');
                if(current) { current.classList.remove('active'); current.classList.add('exit'); }
                cIdx = (cIdx + 1) % newsData.length;
                setTimeout(() => { showSlide(cIdx); }, 500); 
            }, 8000); 
        }
    </script>
</body>
</html>
