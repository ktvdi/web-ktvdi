<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAINTENANCE - KTVDI</title>
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0b1120;
            --card-bg: rgba(30, 41, 59, 0.96);
            --blue-primary: #2563eb;
            --blue-accent: #3b82f6;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --gold: #fbbf24;
            --red-alert: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0b1120 80%);
            min-height: 100vh;
            display: flex; flex-direction: column;
            color: var(--text-main); overflow-x: hidden;
        }

        /* --- TICKER HEADER (SLIM) --- */
        .ticker-wrapper { width: 100%; display: flex; flex-direction: column; }
        .ticker-bar {
            width: 100%; height: 32px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: 600; letter-spacing: 0.5px;
            white-space: nowrap; overflow: hidden;
        }
        .bar-muslim { background: #0f172a; color: #e2e8f0; border-bottom: 1px solid #334155; }
        .bar-christian { background: #1e293b; color: var(--gold); border-bottom: 1px solid #334155; }
        .flip-text { display: flex; align-items: center; gap: 8px; animation: fadeIn 0.5s ease; }

        /* --- CONTAINER --- */
        .container {
            flex: 1; width: 100%; max-width: 800px; margin: 0 auto;
            display: flex; flex-direction: column; justify-content: center;
            padding: 20px; gap: 20px;
        }

        /* --- CARD STYLE --- */
        .card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 30px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            position: relative; overflow: hidden;
        }
        .card-top-accent {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--blue-primary), var(--blue-accent));
        }

        .logo { width: 110px; margin-bottom: 15px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        
        h1 { font-size: 1.8rem; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; color: white; }
        .subtitle { color: var(--blue-primary); font-size: 0.85rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 25px; }

        /* MAINTENANCE NOTICE (BAHASA KOMUNITAS) */
        .notice-box {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.25);
            border-radius: 8px; padding: 20px;
            display: flex; align-items: flex-start; gap: 15px; text-align: left;
        }
        .notice-icon { font-size: 1.5rem; color: var(--blue-accent); margin-top: 2px; }
        .notice-content h3 { color: var(--blue-accent); font-size: 0.95rem; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; }
        .notice-content p { font-size: 0.85rem; color: #cbd5e1; line-height: 1.6; margin-bottom: 8px; }
        .notice-sub { font-size: 0.8rem; color: #94a3b8; font-style: italic; }

        /* INFO GRID */
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; margin-top: 20px; }
        .stat-box {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .stat-lbl { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: white; }
        .text-green { color: #4ade80; }

        /* BATTERY */
        .bat-container { grid-column: span 4; position: relative; overflow: hidden; background: rgba(0,0,0,0.3); padding: 0 !important; height: 40px; display: flex; align-items: center; justify-content: center; }
        .bat-fill {
            position: absolute; top:0; left:0; height: 100%; width: 0%; z-index: 0;
            background: repeating-linear-gradient(45deg, rgba(37,99,235,0.2), rgba(37,99,235,0.2) 10px, rgba(37,99,235,0.3) 10px, rgba(37,99,235,0.3) 20px);
            transition: width 1s ease; border-right: 2px solid var(--blue-primary);
        }
        .bat-text { position: relative; z-index: 1; font-size: 0.8rem; font-weight: 700; display: flex; gap: 8px; align-items: center; }

        /* NEWS FLIP */
        .news-wrapper {
            width: 100%; max-width: 800px; margin: 0 auto 30px auto;
            background: #0f172a; border: 1px solid #334155; border-radius: 8px;
            display: flex; overflow: hidden; position: relative;
            min-height: 100px; transition: height 0.3s ease;
        }
        .news-badge {
            width: 90px; background: var(--blue-primary); color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 800; flex-shrink: 0; position: absolute; top: 0; left: 0; bottom: 0;
        }
        .news-content-area { flex: 1; margin-left: 90px; position: relative; }
        .news-slide {
            position: absolute; top: 0; left: 0; width: 100%; padding: 15px 20px;
            display: flex; flex-direction: column; align-items: flex-start;
            opacity: 0; transform: translateY(20px); transition: all 0.5s ease; visibility: hidden;
        }
        .news-slide.active { opacity: 1; transform: translateY(0); visibility: visible; }
        
        .tag { font-size: 0.65rem; padding: 2px 8px; border-radius: 4px; color: white; font-weight: 700; text-transform: uppercase; margin-right: 8px; }
        .bg-NASIONAL { background: #0284c7; } .bg-DAERAH { background: #d97706; }
        .bg-TEKNOLOGI { background: #7c3aed; } .bg-OLAHRAGA { background: #16a34a; }
        .bg-LALU { background: #dc2626; } .bg-HIMBAUAN { background: #ea580c; animation: pulse 2s infinite; }
        .bg-INFO { background: #334155; } .bg-KEPOLISIAN { background: #475569; }

        .headline { font-size: 0.95rem; font-weight: 600; line-height: 1.4; color: #f1f5f9; margin: 6px 0; width: 100%; }
        .meta { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: #94a3b8; }
        .time-badge { color: #4ade80; border: 1px solid #4ade80; padding: 0 5px; border-radius: 3px; font-size: 0.7rem; font-weight: 600; }

        /* PRAYER ALERT OVERLAY */
        #prayer-alert {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 15px 30px; border-radius: 50px;
            z-index: 1000; display: none; box-shadow: 0 10px 30px rgba(239, 68, 68, 0.6);
            align-items: center; gap: 15px; border: 2px solid white; animation: slideDown 0.5s ease, pulse-red 1s infinite;
        }
        .pa-icon { font-size: 1.5rem; }
        .pa-text { font-weight: 700; font-size: 1rem; text-transform: uppercase; }

        /* ANTHEM OVERLAY */
        #anthem-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.98); z-index: 9999; display: none;
            justify-content: center; align-items: center; animation: fadeIn 1s;
        }

        .footer { text-align: center; font-size: 0.75rem; color: #64748b; padding-bottom: 20px; }

        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        @keyframes slideDown { from { transform: translate(-50%, -100px); } to { transform: translate(-50%, 0); } }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* MOBILE */
        @media (max-width: 480px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5rem; }
            .notice-box { flex-direction: column; gap: 10px; }
            .news-wrapper { min-height: 120px; }
            .news-badge { width: 60px; font-size: 0.6rem; }
            .news-content-area { margin-left: 60px; }
            .news-slide { padding: 12px 15px; }
            .headline { font-size: 0.85rem; }
            .meta { flex-wrap: wrap; }
            #prayer-alert { width: 90%; flex-direction: column; gap: 5px; text-align: center; border-radius: 15px; }
        }
    </style>
</head>
<body>

    <div id="prayer-alert">
        <i class="fas fa-mosque pa-icon"></i>
        <div class="pa-text" id="pa-message">SAAT WAKTU MAGHRIB UNTUK WILAYAH PEKALONGAN</div>
    </div>

    <div id="anthem-overlay">
        <div style="text-align: center; color: white;">
            <h1 style="color: #ffd700; margin-bottom: 20px;">ðŸ‡®ðŸ‡© PUKUL 10.00 WIB</h1>
            <p>Mohon berdiri sejenak dan menyanyikan<br>Lagu Kebangsaan <b>Indonesia Raya</b>.</p>
            <i class="fas fa-music" style="font-size: 3rem; margin-top: 20px; color: gold;"></i>
        </div>
    </div>

    <div class="ticker-wrapper">
        <div class="ticker-bar bar-muslim">
            <div class="flip-content" id="prayer-display"><i class="fas fa-mosque" style="color:#fbbf24; margin-right:5px;"></i> MEMUAT...</div>
        </div>
        <div class="ticker-bar bar-christian">
            <div class="flip-content" id="misa-display"><i class="fas fa-church" style="margin-right:5px;"></i> MEMUAT...</div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-top-accent"></div>
            <img src="{{ url_for('static', filename='icons/icon-192.png') }}" alt="Logo" class="logo">
            <h1>PEMELIHARAAN SISTEM</h1>
            <div class="subtitle">PEMBARUAN DATABASE & JARINGAN</div>

            <div class="notice-box">
                <i class="fas fa-tools notice-icon"></i>
                <div class="notice-content">
                    <h3>STATUS: MAINTENANCE</h3>
                    <p>Mohon maaf atas ketidaknyamanan ini. Saat ini sedang terjadi kendala jaringan pada ISP terkait serta proses penyempurnaan database internal. Penanganan membutuhkan waktu karena Tim NOC Komunitas sedang cuti libur Natal & Tahun Baru.</p>
                    <div class="notice-sub">Kami memohon kesabaran rekan-rekan semua hingga layanan kembali normal. Terima kasih.</div>
                </div>
            </div>
        </div>

        <div class="card" style="padding: 20px;">
            <div style="font-size: 0.7rem; color: var(--text-muted); letter-spacing: 2px; margin-bottom: 15px;">MENUJU 2026</div>
            <div class="grid-4">
                <div class="stat-box"><span class="stat-val" id="d">00</span><span class="stat-lbl">HARI</span></div>
                <div class="stat-box"><span class="stat-val" id="h">00</span><span class="stat-lbl">JAM</span></div>
                <div class="stat-box"><span class="stat-val" id="m">00</span><span class="stat-lbl">MENIT</span></div>
                <div class="stat-box"><span class="stat-val" id="s">00</span><span class="stat-lbl">DETIK</span></div>
            </div>
            <div class="grid-4" style="margin-top: 15px;">
                <div class="stat-box"><span class="stat-lbl">WAKTU (WIB)</span><span class="stat-val" id="clock">00:00:00</span></div>
                <div class="stat-box"><span class="stat-lbl">LOKASI</span><span class="stat-val text-green" id="loc">...</span></div>
                <div class="stat-box"><span class="stat-lbl">PROVIDER</span><span class="stat-val text-green" id="isp">...</span></div>
                <div class="stat-box"><span class="stat-lbl">DEVICE</span><span class="stat-val" id="dev">...</span></div>
                <div class="stat-box bat-container">
                    <div class="bat-fill" id="bat-bar"></div>
                    <div class="bat-text"><span id="bat-txt">--%</span> <i class="fas fa-bolt" id="bat-icon" style="display:none; color:#fbbf24;"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="news-wrapper" id="news-container">
        <div class="news-badge">NEWS</div>
        <div class="news-content-area" id="news-viewport">
            <div class="news-slide active">
                <div class="headline">MENGHUBUNGKAN KE SERVER BERITA...</div>
            </div>
        </div>
    </div>

    <div class="footer">&copy; 2025 Komunitas TV Digital Indonesia.</div>

    <script id="news-data" type="application/json">{{ news_list | tojson }}</script>

    <script>
        // --- 1. CEK JAM 10.00 ---
        setInterval(() => {
            const now = new Date();
            const h = now.getHours();
            const m = now.getMinutes();
            document.getElementById('anthem-overlay').style.display = (h === 10 && m < 2) ? 'flex' : 'none';
        }, 10000);

        // --- 2. DATA KOTA (PRIORITAS & LAINNYA) ---
        const cities = ["PEKALONGAN", "PURWODADI", "JAKARTA", "SURABAYA", "BANDUNG", "SEMARANG", "MEDAN", "MAKASSAR", "DENPASAR", "JAYAPURA", "BALIKPAPAN", "PONTIANAK", "BANJARMASIN", "MANADO", "AMBON", "MATARAM", "KUPANG", "ACEH", "PADANG"];
        let prayerDataMap = {}; // Menyimpan jadwal sholat semua kota untuk dicek notifikasinya

        // Fungsi fetch data sholat
        async function fetchAllPrayerTimes() {
            const dateStr = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');
            
            // Loop fetch (bertahap agar tidak lag)
            for (const city of cities) {
                try {
                    const res = await fetch(`https://api.aladhan.com/v1/timingsByCity/${dateStr}?city=${city}&country=Indonesia&method=20`);
                    const json = await res.json();
                    prayerDataMap[city] = json.data.timings;
                } catch(e) {}
            }
        }
        // Jalankan sekali di awal
        fetchAllPrayerTimes();

        // Ticker Sholat (Bergantian)
        let sholatIdx = 0;
        function updatePrayerTicker() {
            const city = cities[sholatIdx];
            const data = prayerDataMap[city];
            const el = document.getElementById('prayer-display');
            if(data) {
                el.style.opacity = 0;
                setTimeout(() => {
                    el.innerHTML = `<i class="fas fa-mosque icon-gold"></i> ${city} : IMSAK ${data.Imsak} | SUBUH ${data.Fajr} | MAGHRIB ${data.Maghrib}`;
                    el.style.opacity = 1;
                }, 500);
            }
            sholatIdx = (sholatIdx + 1) % cities.length;
        }
        setInterval(updatePrayerTicker, 5000);

        // --- 3. FITUR ALERT SHOLAT (CHECK EVERY SECOND) ---
        setInterval(() => {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${h}:${m}`; // Format HH:MM
            
            let alertMsg = "";
            let showAlert = false;

            // Cek semua kota
            for (const city in prayerDataMap) {
                const times = prayerDataMap[city];
                if (times.Imsak === currentTime) { alertMsg = `SAAT WAKTU IMSAK UNTUK WILAYAH ${city}`; showAlert = true; break; }
                if (times.Fajr === currentTime) { alertMsg = `SAAT WAKTU SUBUH UNTUK WILAYAH ${city}`; showAlert = true; break; }
                if (times.Maghrib === currentTime) { alertMsg = `SAAT WAKTU MAGHRIB UNTUK WILAYAH ${city}`; showAlert = true; break; }
            }

            const alertBox = document.getElementById('prayer-alert');
            const alertText = document.getElementById('pa-message');
            
            if (showAlert) {
                alertText.innerText = alertMsg;
                alertBox.style.display = 'flex';
                // Sembunyikan otomatis setelah 59 detik (lewat menit)
            } else {
                alertBox.style.display = 'none';
            }
        }, 1000);

        // --- 4. MISA, CLOCK (DETIK), ISP, DEVICE, BATTERY, COUNTDOWN ---
        const misaData = [ {loc:"KATEDRAL JAKARTA", t:"06.00, 08.30, 16.30"}, {loc:"KATEDRAL SEMARANG", t:"05.30, 07.00, 16.30"}, {loc:"KATEDRAL SURABAYA", t:"07.00, 09.00, 18.30"} ];
        let misaIdx = 0;
        setInterval(() => {
            const item = misaData[misaIdx];
            const el = document.getElementById('misa-display');
            el.style.opacity = 0;
            setTimeout(() => { el.innerHTML = `<i class="fas fa-church icon-gold"></i> ${item.loc} : ${item.t} WIB`; el.style.opacity = 1; }, 500);
            misaIdx = (misaIdx + 1) % misaData.length;
        }, 5000);

        setInterval(() => { document.getElementById("clock").innerText = new Date().toLocaleTimeString('id-ID', {hour12:false}); }, 1000);
        
        fetch('https://ipapi.co/json/').then(r=>r.json()).then(d=>{ document.getElementById("loc").innerText = d.city.toUpperCase(); document.getElementById("isp").innerText = d.org.toUpperCase(); }).catch(()=>{ document.getElementById("loc").innerText="INDONESIA"; document.getElementById("isp").innerText="ONLINE"; });
        
        const ua = navigator.userAgent;
        document.getElementById("dev").innerText = /Android/i.test(ua) ? "ANDROID" : /iPhone/i.test(ua) ? "IPHONE" : "PC/LAPTOP";

        if(navigator.getBattery) navigator.getBattery().then(b => {
            function up() {
                const l = Math.round(b.level*100);
                document.getElementById("bat-txt").innerText = `${l}%`;
                document.getElementById("bat-bar").style.width = `${l}%`;
                document.getElementById("bat-icon").style.display = b.charging ? 'inline' : 'none';
            }
            up(); b.addEventListener('levelchange', up); b.addEventListener('chargingchange', up);
        });

        setInterval(() => {
            const diff = new Date("Jan 1, 2026 00:00:00").getTime() - new Date().getTime();
            if(diff>0) {
                document.getElementById("d").innerText = Math.floor(diff/864e5);
                document.getElementById("h").innerText = Math.floor((diff%864e5)/36e5);
                document.getElementById("m").innerText = Math.floor((diff%36e5)/6e4);
                document.getElementById("s").innerText = Math.floor((diff%6e4)/1e3);
            }
        }, 1000);

        // --- 5. NEWS FLIP ---
        let newsData = [];
        try { newsData = JSON.parse(document.getElementById('news-data').textContent); } catch(e){}

        setInterval(async () => {
            try { const res = await fetch('/api/news-live'); const newData = await res.json(); if(newData.length > 0) newsData = newData; } catch(e){}
        }, 60000);

        if(newsData.length > 0) {
            const vp = document.getElementById('news-viewport');
            const container = document.getElementById('news-container');
            let cIdx = 0;

            function showSlide(idx) {
                const item = newsData[idx];
                const div = document.createElement('div');
                div.className = 'news-slide active'; 
                
                let bg = 'bg-INFO';
                if(item.category=='NASIONAL') bg='bg-NASIONAL'; if(item.category=='KEPOLISIAN') bg='bg-KEPOLISIAN';
                if(item.category=='DAERAH') bg='bg-DAERAH'; if(item.category=='TEKNOLOGI') bg='bg-TEKNOLOGI';
                if(item.category=='LALU LINTAS') bg='bg-LALU'; if(item.category=='HIMBAUAN') bg='bg-HIMBAUAN';
                if(item.category=='OLAHRAGA') bg='bg-OLAHRAGA';

                div.innerHTML = `
                    <div class="news-header"><span class="tag ${bg}">${item.category}</span><div class="time-badge"><i class="far fa-clock"></i> ${item.date}</div></div>
                    <div class="headline">${item.headline}</div>
                    <div class="source"><i class="fas fa-rss"></i> ${item.source}</div>
                `;
                vp.innerHTML = ''; vp.appendChild(div);

                setTimeout(() => {
                    const h = div.scrollHeight + 30;
                    const minH = window.innerWidth < 480 ? 120 : 100;
                    container.style.height = `${Math.max(minH, h)}px`;
                }, 10);
            }
            showSlide(0);
            setInterval(() => {
                const current = vp.querySelector('.news-slide');
                if(current) { current.classList.remove('active'); current.classList.add('exit'); }
                cIdx = (cIdx + 1) % newsData.length;
                setTimeout(() => { showSlide(cIdx); }, 500); 
            }, 8000); 
        }
    </script>
</body>
</html>
