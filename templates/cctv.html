{% extends 'base.html' %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<div class="bg-gray-900 min-h-screen w-full flex flex-col font-['Inter'] text-gray-200 overflow-hidden select-none" oncontextmenu="return false;">

    <nav class="bg-gray-800 border-b border-gray-700 h-14 flex items-center justify-between px-4 lg:px-6 shrink-0 z-30 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                <i class="fa-solid fa-shield-halved text-sm"></i>
            </div>
            <div>
                <h1 class="text-white font-bold text-sm leading-tight tracking-wide">MONITORING KOTA</h1>
                <p class="text-[10px] text-gray-400">Pemerintah Kota Pekalongan</p>
            </div>
        </div>
        
        <div class="hidden md:block bg-gray-900 px-3 py-1 rounded-md border border-gray-700">
            <span id="clock" class="text-sm font-semibold text-gray-300">00:00:00</span>
        </div>
    </nav>

    <div class="flex flex-col lg:flex-row flex-1 overflow-hidden">

        <main class="flex-1 bg-black relative flex flex-col order-1 h-auto lg:h-full justify-center">
            
            <div class="w-full aspect-video bg-black relative group">
                
                <video id="main-video" class="w-full h-full object-contain bg-black" playsinline></video>

                <div id="play-overlay" class="absolute inset-0 bg-black/40 flex items-center justify-center z-40 cursor-pointer" onclick="forcePlay()">
                    <div class="w-16 h-16 bg-blue-600/90 hover:bg-blue-500 rounded-full flex items-center justify-center shadow-2xl backdrop-blur-sm transition-transform transform hover:scale-110">
                        <i class="fa-solid fa-play text-white text-2xl ml-1"></i>
                    </div>
                </div>

                <div class="absolute top-4 left-4 z-20 pointer-events-none">
                    <span class="px-2 py-1 bg-red-600 text-white text-[10px] font-bold rounded shadow-sm">LIVE</span>
                    <h2 id="cam-title" class="text-white font-bold text-base mt-1 drop-shadow-md">Memuat Kamera...</h2>
                    <p class="text-xs text-gray-300 drop-shadow-md"><i class="fa-solid fa-location-dot text-blue-400 mr-1"></i><span id="cam-location">-</span></p>
                </div>

                <div id="loading-overlay" class="absolute inset-0 bg-gray-900 flex flex-col items-center justify-center z-30">
                    <i class="fa-solid fa-circle-notch fa-spin text-blue-500 text-3xl mb-3"></i>
                    <span class="text-gray-400 text-xs font-medium">Menghubungkan...</span>
                </div>

                <div id="error-overlay" class="absolute inset-0 bg-gray-900 z-30 hidden flex flex-col items-center justify-center text-center px-4">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500 text-3xl mb-2"></i>
                    <p class="text-white text-sm font-medium">Koneksi Terputus</p>
                    <button onclick="reloadStream()" class="mt-3 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded transition">
                        Muat Ulang
                    </button>
                </div>
            </div>

            <div class="bg-blue-900 border-t border-blue-800 h-8 flex items-center overflow-hidden relative shrink-0">
                <div class="absolute left-0 top-0 bottom-0 bg-blue-800 z-10 px-3 flex items-center shadow-lg">
                    <span class="text-[10px] font-bold text-white tracking-wider">INFO</span>
                </div>
                <div class="marquee-container w-full">
                    <div class="marquee-content text-xs text-blue-100 font-medium whitespace-nowrap">
                        Kamera ini aset milik Pemerintah Kota Pekalongan bekerja sama dengan beberapa OPD di Kota Pekalongan.
                    </div>
                </div>
            </div>

            <div class="flex lg:hidden justify-between items-center bg-gray-800 p-3 border-b border-gray-700">
                <div class="flex items-center gap-2">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span class="text-xs text-green-400 font-medium">Server Online</span>
                </div>
                <span class="text-xs text-gray-400" id="clock-mobile">00:00</span>
            </div>

        </main>

        <aside class="w-full lg:w-80 bg-gray-800 border-l border-gray-700 flex flex-col order-2 h-[50vh] lg:h-full z-10">
            
            <div class="p-3 border-b border-gray-700 bg-gray-800 sticky top-0 z-10">
                <div class="relative">
                    <input type="text" id="search-cctv" onkeyup="filterCCTV()" 
                        class="w-full bg-gray-900 border border-gray-600 text-gray-200 text-sm rounded-lg py-2 pl-9 pr-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 placeholder-gray-500 transition-all"
                        placeholder="Cari lokasi...">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-500 text-xs"></i>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1" id="cctv-list">
                </div>
            
            <div class="hidden lg:flex justify-between items-center p-3 border-t border-gray-700 bg-gray-900 text-[10px] text-gray-500">
                <span>V 2.5 Stable</span>
                <span class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Server Online
                </span>
            </div>
        </aside>

    </div>
</div>

<script>
    const streams = [
        {name: "Ponolawen", loc: "Jalur Pantura", url: "https://rtsp.pekalongankota.go.id/stream/a23d134a-18c6-4629-8df4-fe9b9777bac5/channel/0/hls/live/index.m3u8"},
        {name: "Alun-Alun Barat", loc: "Pusat Kota", url: "https://rtsp.pekalongankota.go.id/stream/065624f3-dd71-4b40-9106-9b59c81d51c6/channel/3/hls/live/index.m3u8"},
        {name: "Depan Taspen 2", loc: "Mataram", url: "https://rtsp.pekalongankota.go.id/stream/d794f4f7-1b4e-4d1f-a92d-f0920c5f387c/channel/1/hls/live/index.m3u8"},
        {name: "Dr Cipto", loc: "RSUD Kraton", url: "https://rtsp.pekalongankota.go.id/stream/065624f3-dd71-4b40-9106-9b59c81d51c6/channel/0/hls/live/index.m3u8"},
        {name: "Ruang Amarta", loc: "Setda", url: "https://rtsp.pekalongankota.go.id/stream/203ede86-a503-4350-816c-9d92643ff605/channel/0/hls/live/index.m3u8"},
        {name: "Grosir Setono", loc: "Exit Tol", url: "https://rtsp.pekalongankota.go.id/stream/204f7718-e20c-4229-8ebc-3c5b7470febb/channel/0/hls/live/index.m3u8"},
        {name: "Grogolan PTZ", loc: "Simpang Lima", url: "https://rtsp.pekalongankota.go.id/stream/442c3e59-0bcc-4651-a6b9-700b7b4f7218/channel/0/hls/live/index.m3u8"},
        {name: "Depan Balaikota", loc: "Mataram", url: "https://rtsp.pekalongankota.go.id/stream/3cf3168a-784e-4f9d-9d1e-15809887e87f/channel/0/hls/live/index.m3u8"},
        {name: "Gambaran", loc: "Pekalongan Timur", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/0/hls/live/index.m3u8"},
        {name: "Polsek Timur", loc: "Kantor Polisi", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/1/hls/live/index.m3u8"},
        {name: "Alun-Alun", loc: "Pusat Kota", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/2/hls/live/index.m3u8"},
        {name: "THR Monumen", loc: "Monumen", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/3/hls/live/index.m3u8"},
        {name: "Stasiun", loc: "Stasiun Besar", url: "https://rtsp.pekalongankota.go.id/stream/fa9357ae-1dbc-4f50-a6d1-88649a49a8ae/channel/0/hls/live/index.m3u8"},
        {name: "Kec Pkl Selatan", loc: "Kecamatan", url: "https://rtsp.pekalongankota.go.id/stream/ec93a215-5852-4ae5-944e-8a6ec558e5e9/channel/0/hls/live/index.m3u8"},
        {name: "Depan Taspen 1", loc: "Protokol", url: "https://rtsp.pekalongankota.go.id/stream/d794f4f7-1b4e-4d1f-a92d-f0920c5f387c/channel/0/hls/live/index.m3u8"},
        {name: "Perempatan Kominfo", loc: "Mataram", url: "https://rtsp.pekalongankota.go.id/stream/c285d807-d19f-4dc0-83dc-b1932677fded/channel/0/hls/live/index.m3u8"},
        {name: "Pusri Timur", loc: "Pantura", url: "https://rtsp.pekalongankota.go.id/stream/b05ef4db-a7a7-4622-8b64-fd0085dabe4a/channel/0/hls/live/index.m3u8"},
        {name: "Ahmad Yani", loc: "Pusat Kota", url: "https://rtsp.pekalongankota.go.id/stream/aae9126d-8149-40e7-9cf2-df7d1a2cbfab/channel/0/hls/live/index.m3u8"},
        {name: "Tirto Timur", loc: "Jalan Raya", url: "https://rtsp.pekalongankota.go.id/stream/723919ec-c0ae-43a9-90f8-a513d5823b27/channel/1/hls/live/index.m3u8"},
        {name: "Terminal Bus", loc: "Terminal", url: "https://rtsp.pekalongankota.go.id/stream/0b2a0c4c-fb26-4318-bbeb-86d6bcdf2fa3/channel/0/hls/live/index.m3u8"},
        {name: "Sorogenen", loc: "Jalan Raya", url: "https://rtsp.pekalongankota.go.id/stream/065624f3-dd71-4b40-9106-9b59c81d51c6/channel/2/hls/live/index.m3u8"}
    ];

    let hls;
    let activeIndex = 0;
    const video = document.getElementById('main-video');
    const playOverlay = document.getElementById('play-overlay');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorOverlay = document.getElementById('error-overlay');
    
    function init() {
        renderList();
        loadStream(0);
        startClock();
    }

    function loadStream(index) {
        activeIndex = index;
        const s = streams[index];
        
        document.getElementById('cam-title').innerText = s.name;
        document.getElementById('cam-location').innerText = s.loc;
        
        // Reset States
        loadingOverlay.classList.remove('hidden');
        errorOverlay.classList.add('hidden');
        playOverlay.classList.add('hidden');
        renderList(document.getElementById('search-cctv').value);

        if (Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls({ enableWorker: true });
            hls.loadSource(s.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        loadingOverlay.classList.add('hidden');
                    }).catch(error => {
                        // Autoplay blocked
                        loadingOverlay.classList.add('hidden');
                        playOverlay.classList.remove('hidden');
                    });
                }
            });
            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    loadingOverlay.classList.add('hidden');
                    errorOverlay.classList.remove('hidden');
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = s.url;
            video.addEventListener('loadedmetadata', () => {
                video.play().catch(() => {
                    loadingOverlay.classList.add('hidden');
                    playOverlay.classList.remove('hidden');
                });
                loadingOverlay.classList.add('hidden');
            });
            video.addEventListener('error', () => {
                loadingOverlay.classList.add('hidden');
                errorOverlay.classList.remove('hidden');
            });
        }
    }

    function forcePlay() {
        video.muted = false; // Unmute jika user klik manual
        video.play();
        playOverlay.classList.add('hidden');
    }

    function renderList(filterText = "") {
        const listContainer = document.getElementById('cctv-list');
        listContainer.innerHTML = "";
        
        streams.forEach((s, i) => {
            if (s.name.toLowerCase().includes(filterText.toLowerCase())) {
                const isActive = i === activeIndex;
                const item = document.createElement('div');
                
                // Desain List tombol yang lebih 'clickable'
                item.className = `
                    flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all mb-1
                    ${isActive 
                        ? 'bg-blue-600 text-white shadow-md transform scale-[1.01]' 
                        : 'bg-gray-700/50 text-gray-300 hover:bg-gray-700 hover:text-white'
                    }
                `;
                
                item.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fa-solid fa-video ${isActive ? 'text-white' : 'text-gray-500'}"></i>
                        <div class="flex flex-col truncate">
                            <span class="text-sm font-semibold truncate">${s.name}</span>
                            <span class="text-[10px] ${isActive ? 'text-blue-200' : 'text-gray-500'} truncate">${s.loc}</span>
                        </div>
                    </div>
                    ${isActive ? '<i class="fa-solid fa-circle-play animate-pulse"></i>' : ''}
                `;
                item.onclick = () => loadStream(i);
                listContainer.appendChild(item);
            }
        });
    }

    function reloadStream() { loadStream(activeIndex); }
    function filterCCTV() { renderList(document.getElementById('search-cctv').value); }
    
    function startClock() {
        setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', {hour12: false});
            if(document.getElementById('clock')) document.getElementById('clock').innerText = timeString;
            if(document.getElementById('clock-mobile')) document.getElementById('clock-mobile').innerText = timeString;
        }, 1000);
    }

    // Disable Right Click (Deterrent)
    document.addEventListener('contextmenu', event => event.preventDefault());

    init();
</script>

<style>
    /* Styling untuk Marquee (Running Text) yang smooth */
    .marquee-container {
        display: flex;
        overflow: hidden;
    }
    .marquee-content {
        padding-left: 100%;
        animation: marquee 25s linear infinite; /* Kecepatan Pelan */
    }
    @keyframes marquee {
        0% { transform: translate(0, 0); }
        100% { transform: translate(-100%, 0); }
    }

    /* Scrollbar minimalis */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    
    /* Mencegah seleksi teks (bagian dari anti-capture) */
    body {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
</style>
{% endblock %}
