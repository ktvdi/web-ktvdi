{% extends 'base.html' %}

{% block content %}
<div class="bg-slate-950 min-h-screen pt-24 pb-12 relative overflow-hidden font-sans">
    
    <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-blue-600/10 rounded-full blur-[120px] pointer-events-none"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-indigo-600/10 rounded-full blur-[120px] pointer-events-none"></div>

    <div class="max-w-[1600px] mx-auto px-4 relative z-10">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-white/5 pb-6">
            <div>
                <h1 class="text-3xl font-extrabold text-white flex items-center gap-3 tracking-tight">
                    <i class="fa-solid fa-map-location-dot text-brand-blue"></i>
                    Pekalongan Traffic Center
                </h1>
                <p class="text-slate-400 text-sm mt-1">Pemantauan visual real-time jaringan lalu lintas kota.</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center gap-3">
                <div class="px-4 py-2 bg-slate-900/50 border border-white/10 rounded-full flex items-center gap-2 backdrop-blur-md">
                    <span class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-500 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-red-600"></span>
                    </span>
                    <span class="text-xs font-bold text-white tracking-wider">SYSTEM ONLINE</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-auto lg:h-[75vh]">
            
            <div class="lg:col-span-9 flex flex-col h-full">
                <div class="relative group rounded-2xl overflow-hidden bg-black border border-white/10 shadow-2xl flex-1 flex flex-col">
                    
                    <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-20 pointer-events-none bg-gradient-to-b from-black/80 to-transparent">
                        <div>
                            <h2 id="cam-title" class="text-xl font-bold text-white drop-shadow-md">Pilih Kamera</h2>
                            <div class="flex items-center gap-2 text-xs text-slate-300 mt-1">
                                <i class="fa-solid fa-building-columns text-yellow-500"></i>
                                <span class="uppercase tracking-wide font-semibold opacity-80">Aset Pemkot Pekalongan</span>
                            </div>
                        </div>
                        <div class="px-3 py-1 bg-red-600 text-white text-[10px] font-bold rounded-md tracking-widest shadow-lg animate-pulse">
                            LIVE
                        </div>
                    </div>

                    <div class="relative flex-1 bg-slate-900 flex items-center justify-center overflow-hidden">
                        <video id="main-video" class="w-full h-full object-contain" controls autoplay muted playsinline poster="https://source.unsplash.com/1600x900/?city,night"></video>
                        
                        <div id="loading-overlay" class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm flex flex-col items-center justify-center z-30 hidden">
                            <div class="w-12 h-12 border-4 border-slate-700 border-t-brand-blue rounded-full animate-spin mb-4"></div>
                            <span class="text-sm font-medium text-slate-300 animate-pulse">Menghubungkan ke Server...</span>
                        </div>
                        
                        <div id="error-overlay" class="absolute inset-0 bg-slate-950/90 flex flex-col items-center justify-center z-30 hidden">
                            <i class="fa-solid fa-triangle-exclamation text-4xl text-yellow-500 mb-3"></i>
                            <span class="text-sm font-medium text-slate-300">Kamera Offline / Gangguan Jaringan</span>
                            <button onclick="reloadStream()" class="mt-4 px-4 py-2 bg-brand-blue text-white text-xs rounded hover:bg-blue-600 transition">Coba Lagi</button>
                        </div>
                    </div>

                    <div class="bg-slate-900 border-t border-white/5 p-4 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-4 text-xs text-slate-400">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-shield-halved text-green-500"></i> Koneksi Aman</span>
                            <span id="timestamp" class="font-mono opacity-70">00:00:00</span>
                        </div>
                        <button onclick="toggleFullscreen()" class="text-slate-400 hover:text-white transition p-2 hover:bg-white/10 rounded-lg">
                            <i class="fa-solid fa-expand text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3 flex flex-col bg-slate-900/60 backdrop-blur-xl border border-white/10 rounded-2xl overflow-hidden h-[600px] lg:h-auto shadow-xl">
                <div class="p-4 border-b border-white/5 bg-slate-900/80">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-500 text-xs"></i>
                        <input type="text" id="search-cctv" onkeyup="filterCCTV()" placeholder="Cari lokasi..." 
                            class="w-full bg-black/30 text-white text-sm pl-10 pr-4 py-3 rounded-xl border border-white/10 focus:outline-none focus:border-brand-blue focus:ring-1 focus:ring-brand-blue transition placeholder-slate-600">
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll" id="cctv-list">
                    </div>
                
                <div class="p-3 bg-black/40 border-t border-white/5 text-center">
                    <p class="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Official Government Feed</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // DATASET LENGKAP CCTV (36 KAMERA)
    const streams = [
        {name: "Ponolawen", url: "https://rtsp.pekalongankota.go.id/stream/a23d134a-18c6-4629-8df4-fe9b9777bac5/channel/0/hls/live/index.m3u8"},
        {name: "Alun-Alun Barat", url: "https://rtsp.pekalongankota.go.id/stream/065624f3-dd71-4b40-9106-9b59c81d51c6/channel/3/hls/live/index.m3u8"},
        {name: "Depan Taspen 2", url: "https://rtsp.pekalongankota.go.id/stream/d794f4f7-1b4e-4d1f-a92d-f0920c5f387c/channel/1/hls/live/index.m3u8"},
        {name: "Dr Cipto", url: "https://rtsp.pekalongankota.go.id/stream/065624f3-dd71-4b40-9106-9b59c81d51c6/channel/0/hls/live/index.m3u8"},
        {name: "Ruang Amarta", url: "https://rtsp.pekalongankota.go.id/stream/203ede86-a503-4350-816c-9d92643ff605/channel/0/hls/live/index.m3u8"},
        {name: "Grosir Setono", url: "https://rtsp.pekalongankota.go.id/stream/204f7718-e20c-4229-8ebc-3c5b7470febb/channel/0/hls/live/index.m3u8"},
        {name: "Grogolan PTZ", url: "https://rtsp.pekalongankota.go.id/stream/442c3e59-0bcc-4651-a6b9-700b7b4f7218/channel/0/hls/live/index.m3u8"},
        {name: "Depan Balaikota 1", url: "https://rtsp.pekalongankota.go.id/stream/3cf3168a-784e-4f9d-9d1e-15809887e87f/channel/0/hls/live/index.m3u8"},
        {name: "Gambaran", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/0/hls/live/index.m3u8"},
        {name: "Polsek Timur", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/1/hls/live/index.m3u8"},
        {name: "Alun-Alun", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/2/hls/live/index.m3u8"},
        {name: "THR", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/3/hls/live/index.m3u8"},
        {name: "THR Selatan", url: "https://rtsp.pekalongankota.go.id/stream/4ddb8484-2231-4450-9d91-30021a9d94e5/channel/4/hls/live/index.m3u8"},
        {name: "Stasiun", url: "https://rtsp.pekalongankota.go.id/stream/fa9357ae-1dbc-4f50-a6d1-88649a49a8ae/channel/0/hls/live/index.m3u8"},
        {name: "Kec Pekalongan Selatan", url: "https://rtsp.pekalongankota.go.id/stream/ec93a215-5852-4ae5-944e-8a6ec558e5e9/channel/0/hls/live/index.m3u8"},
        {name: "Depan Taspen 1", url: "https://rtsp.pekalongankota.go.id/stream/d794f4f7-1b4e-4d1f-a92d-f0920c5f387c/channel/0/hls/live/index.m3u8"},
        {name: "Perempatan Kominfo", url: "https://rtsp.pekalongankota.go.id/stream/c285d807-d19f-4dc0-83dc-b1932677fded/channel/0/hls/live/index.m3u8"},
        {name: "Perempatan Kominfo 2", url: "https://rtsp.pekalongankota.go.id/stream/c1657b7d-1780-4f5c-be0a-96a779cd92b9/channel/0/hls/live/index.m3u8"},
        {name: "Pusri Timur", url: "https://rtsp.pekalongankota.go.id/stream/b05ef4db-a7a7-4622-8b64-fd0085dabe4a/channel/0/hls/live/index.m3u8"},
        {name: "Pusri Barat", url: "https://rtsp.pekalongankota.go.id/stream/b05ef4db-a7a7-4622-8b64-fd0085dabe4a/channel/2/hls/live/index.m3u8"},
        {name: "Ahmad Yani", url: "https://rtsp.pekalongankota.go.id/stream/aae9126d-8149-40e7-9cf2-df7d1a2cbfab/channel/0/hls/live/index.m3u8"},
        {name: "Ponolawen Timur", url: "https://rtsp.pekalongankota.go.id/stream/a23d134a-18c6-4629-8df4-fe9b9777bac5/channel/1/hls/live/index.m3u8"},
        {name: "Ponolawen Selatan", url: "https://rtsp.pekalongankota.go.id/stream/a23d134a-18c6-4629-8df4-fe9b9777bac5/channel/2/hls/live/index.m3u8"},
        {name: "Pendopo Mataram", url: "https://rtsp.pekalongankota.go.id/stream/3cf3168a-784e-4f9d-9d1e-15809887e87f/channel/0/hls/live/index.m3u8"},
        {name: "Tirto Timur", url: "https://rtsp.pekalongankota.go.id/stream/723919ec-c0ae-43a9-90f8-a513d5823b27/channel/1/hls/live/index.m3u8"},
        {name: "Tirto Selatan", url: "https://rtsp.pekalongankota.go.id/stream/723919ec-c0ae-43a9-90f8-a513d5823b27/channel/2/hls/live/index.m3u8"},
        {name: "Ahmad Yani Timur", url: "https://rtsp.pekalongankota.go.id/stream/204f7718-e20c-4229-8ebc-3c5b7470febb/channel/3/hls/live/index.m3u8"},
        {name: "Parkir Depan Kominfo", url: "https://rtsp.pekalongankota.go.id/stream/092dc478-ba66-4939-8fd0-b8796cfd89a0/channel/0/hls/live/index.m3u8"},
        {name: "Dharma Bakti Timur", url: "https://rtsp.pekalongankota.go.id/stream/504ddc51-6bb8-4355-a6b3-e1fc4b8e3e8d/channel/0/hls/live/index.m3u8"},
        {name: "Dharma Bakti Barat", url: "https://rtsp.pekalongankota.go.id/stream/504ddc51-6bb8-4355-a6b3-e1fc4b8e3e8d/channel/1/hls/live/index.m3u8"},
        {name: "Dharma Bakti Selatan", url: "https://rtsp.pekalongankota.go.id/stream/504ddc51-6bb8-4355-a6b3-e1fc4b8e3e8d/channel/2/hls/live/index.m3u8"},
        {name: "Pertigaan Podosugih Utara", url: "https://rtsp.pekalongankota.go.id/stream/69518725-7264-4b56-a685-7dbddf7cd039/channel/0/hls/live/index.m3u8"},
        {name: "Muhammadiyah Barat", url: "https://rtsp.pekalongankota.go.id/stream/a561e384-c065-41f6-84fa-32ec581f133f/channel/0/hls/live/index.m3u8"},
        {name: "Matahari", url: "https://rtsp.pekalongankota.go.id/stream/065624f3-dd71-4b40-9106-9b59c81d51c6/channel/1/hls/live/index.m3u8"},
        {name: "Terminal Tengah", url: "https://rtsp.pekalongankota.go.id/stream/0b2a0c4c-fb26-4318-bbeb-86d6bcdf2fa3/channel/0/hls/live/index.m3u8"},
        {name: "Terminal Timur", url: "https://rtsp.pekalongankota.go.id/stream/0b2a0c4c-fb26-4318-bbeb-86d6bcdf2fa3/channel/1/hls/live/index.m3u8"},
        {name: "Pertigaan Podo Sugih Timur", url: "https://rtsp.pekalongankota.go.id/stream/20f63cfc-3f39-440f-b604-4d356da5315d/channel/0/hls/live/index.m3u8"},
        {name: "Grogolan Timur", url: "https://rtsp.pekalongankota.go.id/stream/442c3e59-0bcc-4651-a6b9-700b7b4f7218/channel/1/hls/live/index.m3u8"},
        {name: "Mataram Pojok Utara", url: "https://rtsp.pekalongankota.go.id/stream/4e2c3d4b-7cb1-40fa-9e56-3cfc9693412f/channel/0/hls/live/index.m3u8"},
        {name: "Pertigaan Kel Klego", url: "https://rtsp.pekalongankota.go.id/stream/98520500-cf21-47b5-ae30-eb767f681aba/channel/0/hlsll/live/index.m3u8"},
        {name: "Pertigaan Kel Klego 2", url: "https://rtsp.pekalongankota.go.id/stream/98520500-cf21-47b5-ae30-eb767f681aba/channel/1/hlsll/live/index.m3u8"},
        {name: "Sorogenen", url: "https://rtsp.pekalongankota.go.id/stream/065624f3-dd71-4b40-9106-9b59c81d51c6/channel/2/hls/live/index.m3u8"},
        {name: "Stasiun Timur", url: "https://rtsp.pekalongankota.go.id/stream/fa9357ae-1dbc-4f50-a6d1-88649a49a8ae/channel/1/hlsll/live/index.m3u8?_HLS_msn=30&_HLS_part=8"},
        {name: "Pusri Timur HLSLL", url: "https://rtsp.pekalongankota.go.id/stream/b05ef4db-a7a7-4622-8b64-fd0085dabe4a/channel/0/hlsll/live/index.m3u8?_HLS_msn=34&_HLS_part=2"},
        {name: "Posis Barat", url: "https://rtsp.pekalongankota.go.id/stream/390c6bc2-f6eb-46f6-be5a-a7bd6651d110/channel/0/hls/live/index.m3u8"},
        {name: "Posis Utara", url: "https://rtsp.pekalongankota.go.id/stream/390c6bc2-f6eb-46f6-be5a-a7bd6651d110/channel/1/hls/live/index.m3u8"},
        {name: "Posis Timur", url: "https://rtsp.pekalongankota.go.id/stream/390c6bc2-f6eb-46f6-be5a-a7bd6651d110/channel/2/hls/live/index.m3u8"}
    ];

    const video = document.getElementById('main-video');
    const listContainer = document.getElementById('cctv-list');
    const titleEl = document.getElementById('cam-title');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorOverlay = document.getElementById('error-overlay');
    let hls;
    let activeIndex = 0;

    function loadStream(index) {
        activeIndex = index;
        const s = streams[index];
        titleEl.innerText = s.name;
        
        loadingOverlay.classList.remove('hidden'); 
        errorOverlay.classList.add('hidden');

        if (Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls({
                manifestLoadingTimeOut: 10000,
                levelLoadingTimeOut: 10000,
                fragLoadingTimeOut: 10000
            });
            hls.loadSource(s.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play().catch(()=>{});
                loadingOverlay.classList.add('hidden');
            });
            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    loadingOverlay.classList.add('hidden');
                    errorOverlay.classList.remove('hidden');
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = s.url;
            video.addEventListener('loadedmetadata', () => {
                video.play().catch(()=>{});
                loadingOverlay.classList.add('hidden');
            });
            video.addEventListener('error', () => {
                loadingOverlay.classList.add('hidden');
                errorOverlay.classList.remove('hidden');
            });
        }
        renderList(); 
    }

    function reloadStream() {
        loadStream(activeIndex);
    }

    function renderList(filterText = "") {
        listContainer.innerHTML = "";
        streams.forEach((s, i) => {
            if (s.name.toLowerCase().includes(filterText.toLowerCase())) {
                const isActive = i === activeIndex;
                const item = document.createElement('div');
                item.className = `p-3.5 rounded-xl cursor-pointer transition flex items-center gap-4 border group ${isActive ? 'bg-brand-blue/20 border-brand-blue/50 shadow-[0_0_20px_-5px_rgba(37,99,235,0.3)]' : 'bg-slate-950/40 border-white/5 hover:bg-slate-800/60 hover:border-white/10'}`;
                
                item.innerHTML = `
                    <div class="relative w-10 h-10 bg-slate-900 rounded-lg flex items-center justify-center shrink-0 border border-white/10 ${isActive ? 'ring-2 ring-blue-500/30' : ''}">
                        <i class="fa-solid fa-video ${isActive ? 'text-blue-400' : 'text-slate-500 group-hover:text-slate-300'}"></i>
                        ${isActive ? '<span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse border-2 border-slate-900"></span>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-semibold ${isActive ? 'text-white' : 'text-slate-400 group-hover:text-slate-200'} truncate transition">${s.name}</h4>
                        <div class="flex items-center gap-1.5 mt-0.5">
                            <span class="w-1 h-1 rounded-full ${isActive ? 'bg-green-500' : 'bg-slate-600'}"></span>
                            <span class="text-[10px] text-slate-500 font-medium">Aset Pemkot Pekalongan</span>
                        </div>
                    </div>
                    ${isActive ? '<i class="fa-solid fa-play text-brand-blue text-xs animate-pulse"></i>' : ''}
                `;
                item.onclick = () => loadStream(i);
                listContainer.appendChild(item);
            }
        });
    }

    function filterCCTV() {
        renderList(document.getElementById('search-cctv').value);
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            video.requestFullscreen().catch(err => {});
        } else {
            document.exitFullscreen();
        }
    }

    setInterval(() => {
        document.getElementById('timestamp').innerText = new Date().toLocaleTimeString('id-ID');
    }, 1000);

    // Initial Load
    renderList();
    loadStream(0);
</script>

<style>
    .custom-scroll::-webkit-scrollbar { width: 5px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    .custom-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }
</style>
{% endblock %}
