{% extends "base.html" %}

{% block title %}Beranda - KTVDI{% endblock %}

{% block content %}
<style>
    /* Hero Stats */
    .hero-stats { text-align: center; padding: 50px 20px; background: white; border-bottom: 1px solid #eee; }
    .stats-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1000px; margin: 30px auto 0; }
    .stat-card { background: white; padding: 25px 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); width: 220px; border: 1px solid #f0f0f0; display:flex; gap:15px; align-items:center; text-align:left; }
    .stat-icon { width: 50px; height: 50px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; background:#e3f2fd; color:#007bff; }
    
    /* Readiness */
    #coverage-result { display: none; max-width: 800px; margin: 30px auto; padding: 30px; border-radius: 20px; text-align: center; animation: fadeIn 1s; }
    .covered-style { background: #e8f5e9; border: 1px solid #c8e6c9; }
    .not-covered-style { background: #ffebee; border: 1px solid #ffcdd2; }
    
    /* Speedometer */
    .gauge-wrapper { width: 200px; height: 100px; margin: 0 auto; position: relative; overflow: hidden; }
    .gauge-arc { width: 200px; height: 200px; border-radius: 50%; background: conic-gradient(from 180deg, #ff5252 0deg 60deg, #ffca28 60deg 120deg, #66bb6a 120deg 180deg, transparent 180deg); position: absolute; top: 0; left: 0; mask: radial-gradient(transparent 60px, black 61px); -webkit-mask: radial-gradient(transparent 60px, black 61px); }
    .gauge-needle { width: 4px; height: 90px; background: #333; position: absolute; bottom: 0; left: 50%; transform-origin: bottom center; transform: rotate(-90deg); transition: transform 1.5s ease-out; border-radius: 2px; }

    .vidio-btn { display: inline-block; background: #ce0000; color: white; padding: 12px 30px; border-radius: 50px; font-weight: bold; text-decoration: none; margin-top: 15px; box-shadow: 0 5px 15px rgba(206,0,0,0.3); transition: 0.3s; }
    .vidio-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(206,0,0,0.4); }

    /* Bottom Widgets */
    .bottom-widgets { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 90%; max-width: 1000px; margin: 40px auto; }
    .widget-card { background: white; padding: 20px; border-radius: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); border: 1px solid #eee; text-decoration: none; color: #333; transition: 0.3s; }
    .widget-card:hover { transform: translateY(-5px); }
    .w-icon { width: 55px; height: 55px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; color: white; flex-shrink: 0; }
    
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
</style>

<div class="hero-stats">
    <h1 style="color:#2d3436; font-weight:800; font-size:2rem; margin-bottom:5px;">Siaran Digital dalam Angka</h1>
    <p style="color:#777; font-size:0.9rem;"><i class="far fa-clock"></i> Update: {{ last_updated_time }}</p>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon"><i class="fas fa-map-marked-alt"></i></div>
            <div><h3 style="margin:0; font-size:1.8rem; color:#333;">{{ jumlah_wilayah_layanan }}</h3><small style="color:#777;">Wilayah Layanan</small></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#e8f5e9; color:#4caf50;"><i class="fas fa-broadcast-tower"></i></div>
            <div><h3 style="margin:0; font-size:1.8rem; color:#333;">{{ jumlah_penyelenggara_mux }}</h3><small style="color:#777;">Layanan MUX</small></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background:#fff3e0; color:#ff9800;"><i class="fas fa-tv"></i></div>
            <div><h3 style="margin:0; font-size:1.8rem; color:#333;">{{ jumlah_siaran }}</h3><small style="color:#777;">Saluran Digital</small></div>
        </div>
        {% if most_common_siaran_name %}
        <div class="stat-card">
            <div class="stat-icon" style="background:#ffebee; color:#f44336;"><i class="fas fa-globe-asia"></i></div>
            <div><h3 style="margin:0; font-size:1.4rem; color:#333;">{{ most_common_siaran_count }} MUX</h3><small style="color:#777;">{{ most_common_siaran_name }}</small></div>
        </div>
        {% endif %}
    </div>
</div>

<div id="coverage-result">
    <i class="fas fa-spinner fa-spin"></i> Mendeteksi lokasi Anda untuk cek jangkauan...
</div>

<div class="bottom-widgets">
    <div class="widget-card">
        <div class="w-icon" style="background: linear-gradient(135deg, #f6d365, #fda085);"><i class="fas fa-cloud-sun"></i></div>
        <div>
            <h5 id="weather-loc" style="margin:0; font-size:0.8rem; color:#777;">Memuat Lokasi...</h5>
            <h3 id="weather-temp" style="margin:2px 0; font-size:1.5rem;">--°C</h3>
            <small id="weather-desc" style="color:#555;">...</small>
        </div>
    </div>

    <a href="https://binamarga.pu.go.id/contents/cctv_tol" target="_blank" class="widget-card">
        <div class="w-icon" style="background: linear-gradient(135deg, #84fab0, #8fd3f4);"><i class="fas fa-road"></i></div>
        <div><h5 style="margin:0; font-size:0.9rem; font-weight:bold;">Pantau Tol</h5><small style="color:#777;">CCTV Realtime</small></div>
        <i class="fas fa-chevron-right" style="margin-left:auto; color:#ccc;"></i>
    </a>

    <a href="https://magma.esdm.go.id" target="_blank" class="widget-card">
        <div class="w-icon" style="background: linear-gradient(135deg, #a18cd1, #fbc2eb);"><i class="fas fa-mountain"></i></div>
        <div><h5 style="margin:0; font-size:0.9rem; font-weight:bold;">Info Bencana</h5><small style="color:#777;">Peta Longsor</small></div>
        <i class="fas fa-chevron-right" style="margin-left:auto; color:#ccc;"></i>
    </a>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const dbProvinces = {{ provinsi_tersedia | tojson }};
    const resultBox = document.getElementById("coverage-result");

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(res => res.json())
            .then(data => {
                let addr = data.address;
                let prov = addr.state || addr.region || ""; 
                let city = addr.city || addr.town || addr.village || prov;

                document.getElementById("weather-loc").innerHTML = `<i class="fas fa-map-marker-alt"></i> ${city}`;

                let provLower = prov.toLowerCase();
                let isCovered = false;

                if(provLower.includes("jawa") || provLower.includes("jakarta") || provLower.includes("banten") || provLower.includes("yogyakarta")) {
                    isCovered = true;
                } else {
                    isCovered = dbProvinces.some(dbP => provLower.includes(dbP.toLowerCase()));
                }

                resultBox.style.display = "block";
                if(isCovered) {
                    resultBox.className = "covered-style";
                    resultBox.innerHTML = `
                        <h3 style="color:#2e7d32; margin-top:0;"><i class="fas fa-check-circle"></i> Wilayah Anda Tercover!</h3>
                        <p>Lokasi <b>${prov}</b> sudah siap menerima siaran TV Digital.</p>
                        <div class="gauge-wrapper" style="margin-top:15px;">
                            <div class="gauge-arc"></div>
                            <div class="gauge-needle" style="transform: rotate(90deg);"></div>
                        </div>
                        <p style="font-weight:bold; margin-top:5px; color:#333;">Kualitas Sinyal: <span style="color:#00c853;">Sangat Baik</span></p>
                    `;
                } else {
                    resultBox.className = "not-covered-style";
                    resultBox.innerHTML = `
                        <h3 style="color:#c62828; margin-top:0;"><i class="fas fa-times-circle"></i> Belum Tercover Optimal</h3>
                        <p>Wilayah <b>${prov}</b> belum memiliki data siaran lengkap.</p>
                        <a href="https://www.vidio.com/live" target="_blank" class="vidio-btn">
                            <i class="fas fa-play-circle"></i> Nonton Streaming (Vidio)
                        </a>
                    `;
                }
            });

            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
            .then(res => res.json())
            .then(data => {
                let temp = data.current_weather.temperature;
                let code = data.current_weather.weathercode;
                let desc = "Cerah";
                if(code > 3) desc = "Berawan";
                if(code > 50) desc = "Hujan";
                
                document.getElementById("weather-temp").innerText = temp + "°C";
                document.getElementById("weather-desc").innerText = desc;
            });

        }, () => {
            resultBox.style.display = "none"; 
            document.getElementById("weather-loc").innerText = "Lokasi tidak aktif";
        });
    }
});
</script>
{% endblock %}
