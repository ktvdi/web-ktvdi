{% extends "base.html" %}

{% block title %}Beranda - Komunitas TV Digital Indonesia{% endblock %}

{% block content %}
<style>
    /* HERO SECTION */
    .hero-section {
        max-width: 1280px;
        margin: 0 auto;
        padding: 40px 24px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        align-items: center;
        min-height: 80vh;
    }

    .hero-text h1 {
        font-size: 3.5rem;
        line-height: 1.15;
        font-weight: 800;
        color: var(--secondary);
        margin-bottom: 24px;
        letter-spacing: -1px;
    }
    .hero-text h1 span { color: var(--primary); }
    
    .hero-text p {
        font-size: 1.125rem;
        color: var(--text-light);
        line-height: 1.7;
        margin-bottom: 32px;
        max-width: 90%;
    }

    .badge-hero {
        display: inline-block;
        background: #DBEAFE; color: var(--primary);
        padding: 8px 16px; border-radius: 50px;
        font-weight: 700; font-size: 0.85rem; margin-bottom: 24px;
    }

    .cta-buttons { display: flex; gap: 16px; }

    /* PLAYER STREAMING CARD (GLASS) */
    .player-box {
        background: white;
        padding: 12px;
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(0,0,0,0.05);
        position: relative;
    }
    
    .video-wrapper {
        position: relative;
        width: 100%; aspect-ratio: 16/9;
        background: #000; border-radius: 16px;
        overflow: hidden;
    }
    
    video { width: 100%; height: 100%; object-fit: contain; }

    /* BADGES PLAYER */
    .badge-live {
        position: absolute; top: 12px; left: 12px;
        background: var(--accent-red); color: white;
        padding: 4px 10px; border-radius: 6px;
        font-size: 0.7rem; font-weight: 800; z-index: 10;
        display: flex; align-items: center; gap: 5px;
    }
    .badge-live::before { content:''; width:6px; height:6px; background:white; border-radius:50%; animation:blink 1s infinite; }

    .badge-bitrate {
        position: absolute; top: 12px; right: 12px;
        background: rgba(0,0,0,0.7); color: var(--accent-yellow);
        padding: 4px 8px; border-radius: 6px;
        font-family: monospace; font-size: 0.7rem; font-weight: 700;
        backdrop-filter: blur(4px); z-index: 10;
        display: none; /* Show by JS */
    }

    .control-panel { margin-top: 16px; padding: 0 4px; }
    .playing-now {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
        font-weight: 600; color: var(--secondary);
    }
    .status-text { font-size: 0.8rem; color: var(--accent-green); display: flex; align-items: center; gap: 4px; }

    .channels-scroll {
        display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px;
        -ms-overflow-style: none; scrollbar-width: none;
    }
    .channels-scroll::-webkit-scrollbar { display: none; }
    
    .channel-btn {
        background: var(--bg-body); border: 1px solid #e2e8f0;
        padding: 8px 16px; border-radius: 100px;
        font-size: 0.85rem; font-weight: 600; color: var(--text-light);
        cursor: pointer; white-space: nowrap; transition: 0.2s;
    }
    .channel-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* STATS SECTION */
    .stats-section {
        background: white; padding: 80px 24px;
        border-top: 1px solid #f1f5f9;
    }
    .stats-grid {
        max-width: 1280px; margin: 0 auto;
        display: grid; grid-template-columns: 1.5fr 1fr; gap: 50px;
        align-items: center;
    }
    .chart-container {
        background: white; padding: 24px; border-radius: 24px;
        box-shadow: var(--shadow-card); border: 1px solid #f1f5f9;
        height: 380px; position: relative;
    }
    .stats-cards {
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
    }
    .stat-card {
        background: var(--bg-body); padding: 20px; border-radius: 20px; text-align: center;
    }
    .stat-card h3 { font-size: 2rem; color: var(--primary); margin: 0; font-weight: 800; }
    .stat-card p { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }

    @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.4} }

    /* RESPONSIVE MOBILE */
    @media (max-width: 900px) {
        .hero-section { grid-template-columns: 1fr; text-align: center; padding-top: 20px; }
        .hero-text h1 { font-size: 2.2rem; }
        .hero-text p { margin: 0 auto 30px; font-size: 1rem; }
        .cta-buttons { justify-content: center; }
        
        .stats-grid { grid-template-columns: 1fr; }
        .chart-container { height: 300px; } /* Chart lebih pendek di HP agar tidak makan tempat */
    }
</style>

<section class="hero-section">
    <div class="hero-text">
        <span class="badge-hero">#AyoNontonTVDigital</span>
        <h1>Platform Siaran <br><span>Digital Indonesia</span></h1>
        <p>
            Bergabunglah dengan komunitas terbesar. Pantau frekuensi MUX real-time, 
            diskusi teknis, dan nikmati siaran jernih tanpa semut.
        </p>
        <div class="cta-buttons">
            <a href="#statistik" class="btn btn-primary">Lihat Data</a>
            <a href="/daftar-siaran" class="btn btn-ghost" style="border:1px solid #cbd5e1;">Cari Siaran</a>
        </div>
    </div>

    <div class="player-box">
        <div class="video-wrapper">
            <video id="tvPlayer" controls autoplay muted playsinline></video>
            <div class="badge-live">LIVE</div>
            <div class="badge-bitrate" id="bitrate">-- Kbps</div>
        </div>
        <div class="control-panel">
            <div class="playing-now">
                <span id="channelName" style="color:var(--primary);">Nusantara TV</span>
                <span class="status-text"><i class="fa-solid fa-signal"></i> Stabil</span>
            </div>
            <div class="channels-scroll">
                <button class="channel-btn active" onclick="playChannel('Nusantara TV', 'https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8', this)">Nusantara TV</button>
                <button class="channel-btn" onclick="playChannel('RTV HD', 'https://rtvstream.rtv.co.id:4555/hls/rtv.m3u8', this)">RTV</button>
                <button class="channel-btn" onclick="playChannel('Matrix TV', 'https://stream.matrixtv.id/hls/stream.m3u8', this)">Matrix TV</button>
                <button class="channel-btn" onclick="playChannel('Berita Satu', 'https://beritasatu.secureswiftcontent.com/han/beritasatu/bsatu10008/srtoutput/manifest.m3u8', this)">Berita Satu</button>
            </div>
        </div>
    </div>
</section>

<section class="stats-section" id="statistik">
    <div class="stats-grid">
        <div class="chart-container">
            <h4 style="margin-bottom:20px; font-weight:700;">Sebaran Wilayah Layanan</h4>
            <div style="position:relative; height:300px; width:100%;">
                <canvas id="wilayahChart"></canvas>
            </div>
        </div>
        <div>
            <div style="margin-bottom:30px;">
                <h2 style="font-size:2rem; font-weight:800; color:var(--secondary); margin-bottom:10px;">Statistik Platform</h2>
                <p style="color:var(--text-light);">Update Data: <strong>{{ last_updated_time }}</strong></p>
            </div>
            <div class="stats-cards">
                <div class="stat-card"><h3>{{ jumlah_wilayah_layanan }}</h3><p>Wilayah</p></div>
                <div class="stat-card"><h3>{{ jumlah_penyelenggara_mux }}</h3><p>Layanan MUX</p></div>
                <div class="stat-card"><h3>{{ jumlah_siaran }}</h3><p>Saluran</p></div>
                <div class="stat-card"><h3>{{ most_common_siaran_count }}</h3><p>Jangkauan Luas</p></div>
            </div>
        </div>
    </div>
</section>

<script>
    // --- PLAYER & BITRATE FIX ---
    const video = document.getElementById('tvPlayer');
    const bitrateEl = document.getElementById('bitrate');
    const defaultUrl = 'https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8';
    let hls;

    function initPlayer(url) {
        if (Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            
            // Logic Bitrate: Saat level berpindah, update text
            hls.on(Hls.Events.LEVEL_SWITCHED, (event, data) => {
                const level = hls.levels[data.level];
                if (level) bitrateEl.innerText = (level.bitrate / 1000).toFixed(0) + " Kbps";
            });

            // Fallback awal saat manifest diparsing
            hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                video.play();
                bitrateEl.style.display = 'block';
                if(data.levels && data.levels.length > 0) {
                    // Ambil estimasi dari level pertama
                    bitrateEl.innerText = (data.levels[0].bitrate / 1000).toFixed(0) + " Kbps";
                } else {
                    bitrateEl.innerText = "Auto";
                }
            });

            hls.loadSource(url);
            hls.attachMedia(video);

        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.addEventListener('loadedmetadata', () => video.play());
            bitrateEl.innerText = "HLS";
            bitrateEl.style.display = 'block';
        }
    }
    
    // Init pertama kali
    initPlayer(defaultUrl);

    window.playChannel = function(name, url, btn) {
        document.getElementById('channelName').innerText = name;
        document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        initPlayer(url);
    }

    // --- CHART JS (RESPONSIVE) ---
    const ctx = document.getElementById('wilayahChart').getContext('2d');
    const labels = JSON.parse('{{ chart_labels | safe }}');
    const dataVal = JSON.parse('{{ chart_data | safe }}');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Wilayah', data: dataVal, backgroundColor: '#0066FF', borderRadius: 4
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: {display:false} },
            scales: { 
                y: {beginAtZero: true, grid:{borderDash:[4,4]}},
                x: {grid:{display:false}}
            }
        }
    });
</script>
{% endblock %}
