{% extends "base.html" %}

{% block title %}Beranda - Komunitas TV Digital Indonesia{% endblock %}

{% block content %}
<style>
    /* HERO SECTION */
    .hero {
        max-width: 1280px;
        margin: 0 auto;
        padding: 60px 24px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 60px;
        align-items: center;
        min-height: 85vh; /* Layar Penuh */
    }

    .hero-content h1 {
        font-size: 3.5rem;
        line-height: 1.1;
        background: linear-gradient(to right, var(--secondary), var(--primary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 24px;
        font-weight: 800;
    }
    
    .hero-content p {
        font-size: 1.15rem;
        color: var(--text-muted);
        line-height: 1.8;
        margin-bottom: 40px;
    }

    .tag-pill {
        display: inline-block;
        background: #e0f2fe;
        color: var(--primary);
        padding: 6px 14px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.8rem;
        margin-bottom: 20px;
        letter-spacing: 0.5px;
    }

    .btn-hero-group { display: flex; gap: 15px; }

    /* PLAYER CARD (Modern Glass) */
    .player-card {
        background: white;
        padding: 12px;
        border-radius: 24px;
        box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(0,0,0,0.05);
        position: relative;
    }

    .video-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background: black;
        border-radius: 16px;
        overflow: hidden;
    }

    video { width: 100%; height: 100%; object-fit: contain; }

    /* OVERLAYS DI VIDEO */
    .live-badge {
        position: absolute; top: 15px; left: 15px;
        background: var(--accent-red); color: white;
        padding: 4px 10px; border-radius: 4px;
        font-size: 0.75rem; font-weight: 800;
        display: flex; align-items: center; gap: 6px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .live-badge::before {
        content: ''; width: 8px; height: 8px; background: white; border-radius: 50%;
        animation: blink 1s infinite;
    }

    .bitrate-badge {
        position: absolute; top: 15px; right: 15px;
        background: rgba(0,0,0,0.7); color: #fbbf24;
        padding: 4px 8px; border-radius: 4px;
        font-family: 'Consolas', monospace; font-size: 0.75rem;
        backdrop-filter: blur(4px);
        z-index: 10;
    }

    /* PLAYER CONTROLS */
    .player-info { margin-top: 20px; padding: 0 10px; }
    .now-playing-row {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
    }
    .channel-chips {
        display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;
    }
    .chip {
        background: var(--bg-body); border: 1px solid #e2e8f0;
        padding: 8px 18px; border-radius: 50px; font-size: 0.85rem;
        cursor: pointer; transition: 0.2s; white-space: nowrap; color: var(--text-muted);
    }
    .chip:hover, .chip.active {
        background: var(--primary); color: white; border-color: var(--primary);
    }

    /* FEATURES */
    .features-section {
        padding: 80px 24px; background: white;
    }
    .grid-features {
        max-width: 1280px; margin: 0 auto;
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 40px;
    }
    .feature-card {
        padding: 30px; border-radius: 20px; background: #f8fafc;
        transition: 0.3s; border: 1px solid transparent;
    }
    .feature-card:hover { transform: translateY(-5px); border-color: var(--primary); background: white; box-shadow: var(--shadow-soft); }
    .icon-box {
        width: 50px; height: 50px; background: #e0f2fe; color: var(--primary);
        display: flex; align-items: center; justify-content: center;
        border-radius: 12px; font-size: 1.2rem; margin-bottom: 20px;
    }

    /* STATS */
    .stats-section {
        padding: 80px 24px;
        background: linear-gradient(to bottom, #f8fafc, white);
    }
    .stats-container {
        max-width: 1280px; margin: 0 auto;
        display: grid; grid-template-columns: 1.5fr 1fr; gap: 60px; align-items: center;
    }
    .chart-box {
        background: white; padding: 25px; border-radius: 20px;
        box-shadow: var(--shadow-soft); height: 400px;
    }
    .stat-items { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .stat-item {
        background: white; padding: 20px; border-radius: 15px; border: 1px solid #eee; text-align: center;
    }
    .stat-item h3 { font-size: 2.2rem; color: var(--primary); margin: 0; font-weight: 800; }
    .stat-item p { font-size: 0.85rem; color: var(--text-muted); margin-top: 5px; }

    @keyframes blink { 0%, 100% {opacity:1;} 50% {opacity:0.5;} }
    @media (max-width: 900px) {
        .hero, .stats-container, .grid-features { grid-template-columns: 1fr; text-align: center; }
        .btn-hero-group { justify-content: center; }
        .chart-box { height: 300px; }
    }
</style>

<section class="hero">
    <div class="hero-content">
        <span class="tag-pill">#AyoNontonTVDigital</span>
        <h1>Revolusi Siaran<br>Digital Indonesia</h1>
        <p>
            Bergabung dengan komunitas terbesar. Akses data frekuensi MUX real-time, 
            diskusi teknis, dan nikmati kualitas siaran HD tanpa semut.
        </p>
        <div class="btn-hero-group">
            <a href="#statistik" class="btn btn-primary" style="padding: 12px 30px;">Lihat Data</a>
            <a href="/daftar-siaran" class="btn btn-ghost" style="border:1px solid #ccc;">Cari Saluran</a>
        </div>
    </div>

    <div class="player-card">
        <div class="video-container">
            <video id="tvPlayer" controls autoplay muted playsinline></video>
            <div class="live-badge">LIVE</div>
            <div class="bitrate-badge" id="bitrate">Checking...</div>
        </div>
        <div class="player-info">
            <div class="now-playing-row">
                <div style="font-weight:700; color:var(--secondary); display:flex; align-items:center; gap:8px;">
                    <div style="width:8px; height:8px; background:var(--accent-green); border-radius:50%;"></div>
                    Sedang Memutar: <span id="channelName" style="color:var(--primary);">Nusantara TV</span>
                </div>
                <div style="font-size:0.8rem; color:var(--text-muted);"><i class="fa-solid fa-signal"></i> Stable</div>
            </div>
            <div class="channel-chips">
                <button class="chip active" onclick="playChannel('Nusantara TV', 'https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8', this)">Nusantara TV</button>
                <button class="chip" onclick="playChannel('RTV HD', 'https://rtvstream.rtv.co.id:4555/hls/rtv.m3u8', this)">RTV</button>
                <button class="chip" onclick="playChannel('Matrix TV', 'https://stream.matrixtv.id/hls/stream.m3u8', this)">Matrix TV</button>
            </div>
        </div>
    </div>
</section>

<section class="features-section">
    <div class="grid-features">
        <div class="feature-card">
            <div class="icon-box"><i class="fa-solid fa-users"></i></div>
            <h3>Komunitas Solid</h3>
            <p style="color:var(--text-muted); line-height:1.6;">Ribuan anggota aktif berbagi info teknis antena dan STB di seluruh Indonesia.</p>
        </div>
        <div class="feature-card">
            <div class="icon-box"><i class="fa-solid fa-chart-pie"></i></div>
            <h3>Data Akurat</h3>
            <p style="color:var(--text-muted); line-height:1.6;">Database frekuensi MUX selalu diperbarui oleh kontributor terpercaya.</p>
        </div>
        <div class="feature-card">
            <div class="icon-box"><i class="fa-solid fa-newspaper"></i></div>
            <h3>Berita Terkini</h3>
            <p style="color:var(--text-muted); line-height:1.6;">Informasi ASO (Analog Switch Off) dan update regulasi penyiaran.</p>
        </div>
    </div>
</section>

<section class="stats-section" id="statistik">
    <div class="stats-container">
        <div class="chart-box">
            <h3 style="margin-bottom:20px;">Sebaran Wilayah Layanan</h3>
            <div style="position:relative; height:320px;">
                <canvas id="wilayahChart"></canvas>
            </div>
        </div>
        <div>
            <div style="margin-bottom:30px;">
                <h2 style="font-size:2rem; margin-bottom:10px; color:var(--secondary);">Statistik Platform</h2>
                <p style="color:var(--text-muted);">Data per: <strong>{{ last_updated_time }}</strong></p>
            </div>
            <div class="stat-items">
                <div class="stat-item"><h3>{{ jumlah_wilayah_layanan }}</h3><p>Wilayah</p></div>
                <div class="stat-item"><h3>{{ jumlah_penyelenggara_mux }}</h3><p>MUX</p></div>
                <div class="stat-item"><h3>{{ jumlah_siaran }}</h3><p>Saluran</p></div>
                <div class="stat-item"><h3>{{ most_common_siaran_count }}</h3><p>Jangkauan Luas</p></div>
            </div>
        </div>
    </div>
</section>

<script>
    // --- PLAYER & BITRATE FIX ---
    const video = document.getElementById('tvPlayer');
    const bitrateEl = document.getElementById('bitrate');
    const defaultUrl = 'https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8';
    let hls;

    function initPlayer(url) {
        if (Hls.isSupported()) {
            if(hls) hls.destroy();
            hls = new Hls();
            
            // 1. Attach listener DULUAN sebelum loadSource
            hls.on(Hls.Events.FRAG_LOADED, function(event, data) {
                // Estimasi bitrate dari fragmen yang diload
                const stats = data.stats;
                const bitrate = Math.round((stats.total / (stats.loading.end - stats.loading.start)) * 8 / 1000); // kbps kasar
                // Tapi lebih akurat pakai Level:
            });

            hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                const level = hls.levels[data.level];
                if (level) {
                    bitrateEl.innerText = (level.bitrate / 1000).toFixed(0) + " Kbps";
                }
            });

            // Fallback jika event tidak trigger di awal
            hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                video.play();
                if(data.levels && data.levels.length > 0) {
                    // Ambil level awal
                    const startLevel = data.levels[hls.startLevel];
                    if(startLevel) bitrateEl.innerText = (startLevel.bitrate/1000).toFixed(0) + " Kbps";
                    else bitrateEl.innerText = "Auto";
                }
            });

            hls.loadSource(url);
            hls.attachMedia(video);

        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.addEventListener('loadedmetadata', () => video.play());
            bitrateEl.innerText = "HLS Native";
        }
    }
    initPlayer(defaultUrl);

    window.playChannel = function(name, url, btn) {
        document.getElementById('channelName').innerText = name;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        initPlayer(url);
    }

    // --- CHART ---
    const ctx = document.getElementById('wilayahChart').getContext('2d');
    const labels = JSON.parse('{{ chart_labels | safe }}');
    const dataVal = JSON.parse('{{ chart_data | safe }}');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Wilayah', data: dataVal, backgroundColor: '#0088ff', borderRadius: 5
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: {display:false} },
            scales: { x: {grid: {display:false}}, y: {beginAtZero: true} }
        }
    });
</script>
{% endblock %}
