{% extends "base.html" %}

{% block title %}Komunitas TV Digital Indonesia{% endblock %}

{% block body_class %}home-page{% endblock %}

{% block content %}
    <section class="hero">
        <h1 id="headline">Selamat Datang di Website Komunitas TV Digital Indonesia</h1>
        <p id="paragraph" style="display: none;">
          KTVDI menjadi wadah diskusi bagi semua pemirsa siaran televisi digital di Indonesia untuk memperluas wawasan terkait segala hal yang berkaitan dengan siaran televisi, khususnya Televisi Digital Terestrial (DTT).
        </p>
        <a href="#statistic-tv" id="read-more" style="display:none;">Selengkapnya</a>
    </section>
    
    <div class="statistik" id="statistic-tv" style="display:none;">
      <h1 class="statistik-title">Siaran Digital dalam Angka</h1>

      <div class="card-statistik">
        <div class="card-header-statistik">
          <h2>{{ jumlah_wilayah_layanan }}</h2>
          <p>Wilayah Layanan</p>
        </div>
        <div class="card-body-statistik">
          <p>Saat ini jumlah Wilayah Layanan yang tersedia di seluruh Indonesia berjumlah {{ jumlah_wilayah_layanan }} Wilayah Layanan.</p>
        </div>
        <div class="card-footer-statistik">
          <p><i class="fa-solid fa-rotate"></i>last update {{ last_updated_time }}</p>
        </div>
      </div>
      <div class="card-statistik">
        <div class="card-header-statistik">
          <h2>{{ jumlah_penyelenggara_mux }}</h2>
          <p>Layanan MUX</p>
        </div>
        <div class="card-body-statistik">
          <p>Saat ini jumlah Layanan MUX yang beroperasi di seluruh Indonesia berjumlah {{ jumlah_penyelenggara_mux }} layanan MUX.</p>
        </div>
        <div class="card-footer-statistik">
          <p><i class="fa-solid fa-rotate"></i>last update {{ last_updated_time }}</p>
        </div>
      </div>
      <div class="card-statistik">
        <div class="card-header-statistik">
          <h2>{{ jumlah_siaran }}</h2>
          <p>Siaran TV Digital</p>
        </div>
        <div class="card-body-statistik">
          <p>Saat ini jumlah siaran TV Digital yang beroperasi di seluruh Indonesia berjumlah {{ jumlah_siaran }} siaran.</p>
        </div>
        <div class="card-footer-statistik">
          <p><i class="fa-solid fa-rotate"></i>last update {{ last_updated_time }}</p>
        </div>
      </div>
      <div class="card-statistik">
        <div class="card-header-statistik">
          <h2>{{ most_common_siaran_name }}</h2>
          <p>Siaran TV Digital Terluas</p>
        </div>
        <div class="card-body-statistik">
          <p>Saat ini {{ most_common_siaran_name }} merupakan saluran TV Digital dengan jangkauan terluas di Indonesia, yang tersedia di {{ most_common_siaran_count }} layanan MUX.</p>
        </div>
        <div class="card-footer-statistik">
          <p><i class="fa-solid fa-rotate"></i>last update {{ last_updated_time }}</p>
        </div>
      </div>
    </div>

    <button id="chat-toggle" style="display: none;"><i class="fa-solid fa-comments"></i></button>

    <div class="chatbot" id="chatbot" style="display: none;">
      <h1>ChatKTVDI</h1>
      <div class="chat-body" id="chat-body">
        </div>
      <div class="input-area">
        <textarea id="prompt" placeholder="Tulis pertanyaan..."></textarea>
        <button class="send-btn" onclick="sendPrompt()"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>

    <script>
      // Toggle Chat Widget
      const toggleBtn = document.getElementById("chat-toggle");
      const chatbot = document.getElementById("chatbot");
      const chatBody = document.getElementById("chat-body");
      const promptInput = document.getElementById("prompt");

      toggleBtn.addEventListener("click", () => {
        chatbot.style.display = chatbot.style.display === "flex" ? "none" : "flex";
      });

      // Fungsi kirim prompt ke server Flask
      async function sendPrompt() {
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        // Tampilkan pesan user
        appendMessage(prompt, "user");
        promptInput.value = "";

        // Tambahkan placeholder sementara
        const thinkingMsg = appendMessage("⏳ Sedang memproses...", "bot");

        try {
          const res = await fetch("/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt })
          });

          const data = await res.json();
          chatBody.removeChild(thinkingMsg);

          if (data.response) {
            appendMessage(data.response, "bot");
          } else {
            appendMessage("❌ Terjadi kesalahan: " + data.error, "bot");
          }
        } catch (err) {
          chatBody.removeChild(thinkingMsg);
          appendMessage("⚠️ Gagal terhubung ke server.", "bot");
        }
      }

      // Fungsi untuk mengupdate pesan bot secara animasi
      function appendMessage(text, sender) {
        const msg = document.createElement("div");
        msg.classList.add("message", sender);
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;

        // Replace newlines with <br> tags
        const formattedText = text.replace(/\n/g, '<br>');

        let i = 0;
        msg.innerText = ""; // Mulai dengan teks kosong

        // Fungsi untuk menambahkan karakter satu per satu
        function typeWriter() {
          if (i < text.length) {
            msg.textContent += text.charAt(i);
            i++;
            chatBody.scrollTop = chatBody.scrollHeight;
            setTimeout(typeWriter, 20); // Adjust kecepatan pengetikan di sini (50ms)
          } else {
            requestAnimationFrame(() => {
              chatBody.scrollTop = chatBody.scrollHeight;
            });
          }  
        }

        // Mulai efek pengetikan
        typeWriter();

        requestAnimationFrame(() => {
          chatBody.scrollTop = chatBody.scrollHeight;
        });

        return msg;
      }
      
      // Enter = kirim pesan
      promptInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendPrompt();
        }
      });
    </script>
{% endblock %}
