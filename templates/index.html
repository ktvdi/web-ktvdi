<script>
    document.addEventListener('DOMContentLoaded', () => {
        const channels = [
            {name: "Stara TV Malang", url: "https://malang.staratv.id/hls/stream.m3u8", logo: "https://iili.io/f8YVekl.md.png"},
            {name: "TVRI Nasional", url: "https://ott-balancer.tvri.go.id/live/eds/Nasional/hls/Nasional.m3u8", logo: "https://iili.io/f87NRoB.md.png"},
            {name: "Kompas TV HD", url: "https://www.youtube.com/embed/live_stream?channel=UC7tV3Qv0K6z7q9Z7X1x9x9g", type: "youtube", logo: "https://iili.io/f8YFc1R.jpg"},
            {name: "RTV HD-2", url: "https://rtvstream.rtv.co.id:4555/hls/rtv.m3u8", logo: "https://iili.io/f876F44.md.png"},
            {name: "Garuda TV", url: "https://hgmtv.com:19360/garudatvlivestreaming/garudatvlivestreaming.m3u8", logo: "https://iili.io/f8Y7QV4.png"},
            {name: "Nusantara TV", url: "https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8", logo: "https://iili.io/f8YIZPt.jpg"},
            {name: "Berita Satu", url: "https://beritasatu.secureswiftcontent.com/han/beritasatu/bsatu10008/srtoutput/manifest.m3u8", logo: "https://iili.io/f878bP2.jpg"},
            {name: "Matrix TV Yogyakarta", url: "https://stream.matrixtv.id/hls/stream.m3u8", logo: "https://iili.io/f87LXWX.md.png"},
            {name: "Semarang TV", url: "http://36.94.24.229/0.m3u8", logo: "https://iili.io/f87yF6P.png"},
            {name: "Caruban TV", url: "https://stream.carubantv.id/hls/stream.m3u8", logo: "https://iili.io/f8YnXh7.png"},
            {name: "Rasika USA TV", url: "https://rasika.siar.us/live/rasika.m3u8", logo: "https://rasika.siar.us/assets/img/logo.png"},
        ];

        const grid = document.getElementById('tv-grid');
        
        channels.forEach((ch, idx) => {
            const div = document.createElement('div');
            div.className = "ott-card bg-slate-800 rounded-2xl overflow-hidden border border-slate-700/50 flex flex-col h-full";
            
            let playerHtml = '';
            // Logic YouTube vs HLS
            if (ch.type === "youtube") {
                playerHtml = `
                    <iframe src="https://www.youtube.com/embed/DOOrIxw5xOw?autoplay=0&mute=0&controls=1" 
                        class="w-full h-full absolute inset-0 object-cover" 
                        frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
                    </iframe>`;
            } else {
                playerHtml = `
                    <div id="cover-${idx}" class="absolute inset-0 z-20 flex items-center justify-center bg-slate-900 cursor-pointer" onclick="loadHLS(this, '${ch.url}', 'vid-${idx}')">
                        <div class="relative z-10 w-16 h-16 rounded-full bg-blue-600 flex items-center justify-center shadow-lg hover:bg-blue-500 transition-colors group">
                            <i class="fa-solid fa-play text-white text-xl pl-1 group-hover:scale-110 transition-transform"></i>
                        </div>
                        <div class="absolute inset-0 bg-cover bg-center opacity-30 blur-sm" style="background-image: url('${ch.logo}')"></div>
                    </div>
                    
                    <div class="loading-spinner absolute inset-0 flex flex-col items-center justify-center bg-black z-10 hidden">
                        <i class="fa-solid fa-circle-notch fa-spin text-blue-500 text-3xl"></i>
                    </div>
                    
                    <video id="vid-${idx}" class="w-full h-full object-contain bg-black" muted playsinline></video>
                `;
            }

            // OTT Style Layout
            let controlBarHtml = '';
            if (ch.type !== "youtube") {
                controlBarHtml = `
                    <div class="h-10 bg-slate-900 border-t border-slate-700 flex items-center px-4 justify-between gap-2">
                        <button onclick="reloadVideo('vid-${idx}', '${ch.url}')" class="text-slate-400 hover:text-green-400 w-8 h-8 flex items-center justify-center" title="Reload"><i class="fa-solid fa-rotate-right"></i></button>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleMute('vid-${idx}', this)" class="text-slate-400 hover:text-white w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-volume-high"></i></button>
                            <button onclick="stopVideo('vid-${idx}', 'cover-${idx}')" class="text-slate-400 hover:text-red-400 w-8 h-8 flex items-center justify-center" title="Stop"><i class="fa-solid fa-stop"></i></button>
                            <button onclick="toggleFullScreen('vid-${idx}')" class="text-slate-400 hover:text-blue-400 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-expand"></i></button>
                        </div>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="relative aspect-video bg-black w-full">
                    ${playerHtml}
                </div>
                ${controlBarHtml}
                <div class="p-4 bg-slate-800 flex items-start gap-4 h-full">
                    <div class="w-12 h-12 bg-white rounded-xl p-1 flex-shrink-0 flex items-center justify-center shadow-md">
                        <img src="${ch.logo}" class="max-w-full max-h-full object-contain" onerror="this.src='{{ url_for('static', filename='icons/icon-192.png') }}'">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h3 class="text-white font-bold text-base truncate mb-1">${ch.name}</h3>
                            <span class="user-isp-badge text-[9px] bg-slate-700 text-slate-300 px-1.5 py-0.5 rounded border border-slate-600 hidden">
                                <i class="fa-solid fa-network-wired"></i> <span class="isp-name">Detecting...</span>
                            </span>
                        </div>
                        <div class="card-ticker-wrap">
                            <div class="card-ticker-content text-[10px] text-slate-400 font-mono">
                                • Streaming Digital HD • Resolusi Tinggi • Stereo Audio • ${ch.name} •
                            </div>
                        </div>
                    </div>
                </div>
            `;
            grid.appendChild(div);
        });

        detectISP();
    });

    async function detectISP() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            if (data && data.org) {
                const badges = document.querySelectorAll('.user-isp-badge');
                badges.forEach(badge => {
                    badge.classList.remove('hidden');
                    badge.querySelector('.isp-name').innerText = data.org; 
                });
            }
        } catch (error) { console.log("Gagal deteksi ISP"); }
    }

    function loadHLS(cover, url, vidId) {
        const video = document.getElementById(vidId);
        const spinner = cover.nextElementSibling;
        cover.style.display = 'none';
        spinner.classList.remove('hidden');

        if(Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play();
                spinner.classList.add('hidden');
            });
            window['hls_'+vidId] = hls;
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.addEventListener('loadedmetadata', () => {
                video.play();
                spinner.classList.add('hidden');
            });
        }
        video.muted = false;
    }

    function stopVideo(vidId, coverId) {
        const v = document.getElementById(vidId);
        const cover = document.getElementById(coverId);
        v.pause();
        if(window['hls_'+vidId]) {
            window['hls_'+vidId].destroy();
            delete window['hls_'+vidId];
        }
        v.removeAttribute('src'); 
        v.load();
        cover.style.display = 'flex'; 
    }

    function toggleMute(id, btn) {
        const v = document.getElementById(id);
        v.muted = !v.muted;
        btn.innerHTML = v.muted ? '<i class="fa-solid fa-volume-xmark"></i>' : '<i class="fa-solid fa-volume-high"></i>';
    }

    function reloadVideo(id, url) {
        const v = document.getElementById(id);
        const cover = v.previousElementSibling.previousElementSibling; 
        loadHLS(cover, url, id);
    }

    // --- PERBAIKAN FUNGSI FULL SCREEN (SUPPORT SEMUA DEVICE) ---
    function toggleFullScreen(id) {
        const video = document.getElementById(id);
        
        // 1. Khusus iOS (iPhone/iPad)
        if (video.webkitEnterFullscreen) {
            video.webkitEnterFullscreen();
        } 
        // 2. Standard API (Chrome/Android/Edge Terbaru)
        else if (video.requestFullscreen) {
            video.requestFullscreen();
        } 
        // 3. Safari/Chrome Lama
        else if (video.webkitRequestFullscreen) {
            video.webkitRequestFullscreen();
        } 
        // 4. Firefox
        else if (video.mozRequestFullScreen) {
            video.mozRequestFullScreen();
        } 
        // 5. IE/Edge Lama
        else if (video.msRequestFullscreen) {
            video.msRequestFullscreen();
        }
    }
</script>
