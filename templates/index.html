{% extends "base.html" %}

{% block title %}Komunitas TV Digital Indonesia{% endblock %}

{% block content %}
    <section class="hero">
        <h1>Selamat Datang di Website Komunitas TV Digital Indonesia</h1>
        <p>
          KTVDI menjadi wadah diskusi bagi semua pemirsa siaran televisi digital di Indonesia untuk memperluas wawasan terkait segala hal yang berkaitan dengan siaran televisi, khususnya Televisi Digital Terestrial (DTT).
        </p>
        <a href="#">Selengkapnya</a>
    </section>

    <!-- Tombol Toggle -->
    <button id="chat-toggle"><i class="fa-solid fa-comments"></i></button>

    <!-- Chat Popup -->
    <div class="chatbot" id="chatbot">
      <h1>ChatKTVDI</h1>
      <div class="chat-body" id="chat-body">
        <!-- Pesan muncul di sini -->
      </div>
      <div class="input-area">
        <textarea id="prompt" placeholder="Tulis pertanyaan..."></textarea>
        <button class="send-btn" onclick="sendPrompt()"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>

    <script>
      // Toggle Chat Widget
      const toggleBtn = document.getElementById("chat-toggle");
      const chatbot = document.getElementById("chatbot");
      const chatBody = document.getElementById("chat-body");
      const promptInput = document.getElementById("prompt");

      toggleBtn.addEventListener("click", () => {
        chatbot.style.display = chatbot.style.display === "flex" ? "none" : "flex";
      });

    // Fungsi kirim prompt ke server Flask
    async function sendPrompt() {
      const prompt = promptInput.value.trim();
      if (!prompt) return;

      // Tampilkan pesan user
      appendMessage(prompt, "user");
      promptInput.value = "";

      // Tambahkan placeholder sementara
      const thinkingMsg = appendMessage("⏳ Sedang memproses...", "bot");

      try {
        const res = await fetch("/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        const data = await res.json();
        chatBody.removeChild(thinkingMsg);

        if (data.response) {
          appendMessage(data.response, "bot");
        } else {
          appendMessage("❌ Terjadi kesalahan: " + data.error, "bot");
        }
      } catch (err) {
        chatBody.removeChild(thinkingMsg);
        appendMessage("⚠️ Gagal terhubung ke server.", "bot");
      }
    }

    // Tambahkan pesan ke chat body
    function appendMessage(text, sender) {
      const msg = document.createElement("div");
      msg.classList.add("message", sender);
      msg.innerText = text;
      chatBody.appendChild(msg);
      chatBody.scrollTop = chatBody.scrollHeight;
      return msg;
    }

    // Enter = kirim pesan
    promptInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendPrompt();
      }
    });
    </script>
{% endblock %}
