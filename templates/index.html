{% extends "base.html" %}

{% block title %}Beranda - KTVDI{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
    /* HERO */
    .hero-wrap { padding: 50px 0; background: linear-gradient(180deg, #f8f9fc, #eef2f7); border-bottom: 1px solid #dce4ec; }
    .hero-con { width: 92%; max-width: 1200px; margin: 0 auto; display: flex; align-items: flex-start; gap: 40px; flex-wrap: wrap; }
    
    .hero-txt { flex: 1; min-width: 300px; margin-top: 15px; }
    .hero-txt h1 { font-size: 2.8rem; font-weight: 800; color: #1a1a2e; margin-bottom: 15px; line-height: 1.2; }
    .hero-txt h1 span { color: #007bff; }
    .hero-txt p { font-size: 1.05rem; color: #666; line-height: 1.6; margin-bottom: 25px; }
    
    .hero-vid { flex: 1.3; min-width: 300px; position: relative; max-width: 100%; }
    .tv-box { width: 100%; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.25); border: 4px solid #222; background: black; position: relative; aspect-ratio: 16/9; }
    video { width: 100%; height: 100%; object-fit: contain; }
    .live-tag { position: absolute; top: 15px; left: 15px; background: red; color: white; padding: 4px 10px; font-weight: bold; border-radius: 4px; font-size: 0.75rem; z-index: 10; }

    /* CHANNELS */
    .chan-scroll { margin-top: 20px; overflow-x: auto; white-space: nowrap; padding-bottom: 10px; }
    .chan-btn { display: inline-flex; align-items: center; background: white; border: 1px solid #ddd; padding: 8px 15px; margin-right: 8px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #555; transition: 0.2s; }
    .chan-btn:hover, .chan-btn.active { background: #007bff; color: white; border-color: #007bff; transform: translateY(-2px); }

    /* STATS & WIDGETS */
    .stats-sec { padding: 40px 0; background: white; text-align: center; border-bottom: 1px solid #eee; }
    .stats-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1000px; margin: 0 auto; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; width: 200px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; text-align: left; display: flex; align-items: center; gap: 15px; }
    .s-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: #e3f2fd; color: #007bff; }

    .widgets-area { max-width: 1000px; margin: 40px auto; width: 92%; }
    #readiness { display: none; background: #e8f5e9; padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 30px; border: 1px solid #c8e6c9; }
    .gauge { width: 180px; height: 90px; margin: 10px auto; position: relative; overflow: hidden; }
    .gauge-bg { width: 180px; height: 180px; border-radius: 50%; background: conic-gradient(from 180deg, #ff5252 0deg 60deg, #ffca28 60deg 120deg, #66bb6a 120deg 180deg, transparent 180deg); position: absolute; top: 0; left: 0; mask: radial-gradient(transparent 55px, black 56px); -webkit-mask: radial-gradient(transparent 55px, black 56px); }
    .needle { width: 4px; height: 80px; background: #333; position: absolute; bottom: 0; left: 50%; transform-origin: bottom center; transform: rotate(-90deg); transition: 1.5s ease-out; border-radius: 2px; }

    .grid-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .card-info { background: white; padding: 20px; border-radius: 15px; border: 1px solid #eee; display: flex; align-items: center; gap: 15px; text-decoration: none; color: #333; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
    .card-info:hover { transform: translateY(-3px); }
    .c-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; }

    @media (max-width: 768px) {
        .hero-wrapper { padding: 30px 0; text-align: center; }
        .hero-container { flex-direction: column-reverse; gap: 30px; }
        .hero-buttons { justify-content: center; }
        .chan-scroll { padding-left: 5px; } 
    }
</style>

<div class="hero-wrap">
    <div class="hero-con">
        <div class="hero-txt">
            <div style="background:#e3f2fd; color:#007bff; display:inline-block; padding:5px 15px; border-radius:20px; font-size:0.85rem; font-weight:600; margin-bottom:15px;">#AyoNontonTVDigital</div>
            <h1>Komunitas TV Digital <span>Indonesia</span></h1>
            <p>KTVDI Menjadi Wadah Diskusi Bagi Semua Pemirsa Siaran Televisi Digital di Indonesia untuk Memperluas Wawasan Terkait Segala Hal Yang Berkaitan Dengan Siaran Televisi (DTT).</p>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <a href="/daftar-siaran" class="chan-btn active" style="background:#007bff; color:white; border:none;">Daftar Siaran</a>
                <a href="/about" class="chan-btn">Tentang Kami</a>
            </div>
        </div>

        <div class="hero-vid">
            <div class="tv-box">
                <div class="live-tag">LIVE</div>
                <video id="vPlayer" controls autoplay muted playsinline></video>
            </div>
            <div class="chan-scroll">
                <button class="chan-btn active" onclick="play('caruban')">Caruban TV</button>
                <button class="chan-btn" onclick="play('stara')">Stara TV</button>
                <button class="chan-btn" onclick="play('nusantara')">Nusantara TV</button>
                <button class="chan-btn" onclick="play('garuda')">Garuda TV</button>
                <button class="chan-btn" onclick="play('matrix')">Matrix TV</button>
                <button class="chan-btn" onclick="play('rtv')">RTV HD</button>
                <button class="chan-btn" onclick="play('elshinta')">Elshinta TV</button>
                <button class="chan-btn" onclick="play('tvri')">TVRI Nasional</button>
                <button class="chan-btn" onclick="play('tvri_sport')">TVRI Sport</button>
                <button class="chan-btn" onclick="play('magna')">Magna Channel</button>
                <button class="chan-btn" onclick="play('bn')">BN Channel</button>
                <button class="chan-btn" onclick="play('batv')">BATV</button>
                <button class="chan-btn" onclick="play('inspira')">Inspira TV</button>
            </div>
            <p id="now-play" style="text-align:center; font-size:0.85rem; color:#555; margin-top:10px;">Play: <b>Caruban TV</b></p>
        </div>
    </div>
</div>

<div class="stats-sec">
    <div style="margin-bottom:20px; font-weight:bold; color:#555;">Data Update: {{ stats.last_update }}</div>
    <div class="stats-grid">
        <div class="stat-card"><div class="s-icon"><i class="fas fa-map"></i></div><div><h3>{{ stats.wilayah }}</h3><small>Wilayah</small></div></div>
        <div class="stat-card"><div class="s-icon" style="background:#e8f5e9; color:#4caf50;"><i class="fas fa-broadcast-tower"></i></div><div><h3>{{ stats.mux }}</h3><small>MUX</small></div></div>
        <div class="stat-card"><div class="s-icon" style="background:#fff3e0; color:#ff9800;"><i class="fas fa-tv"></i></div><div><h3>{{ stats.siaran }}</h3><small>Saluran</small></div></div>
        {% if stats.top_name != '-' %}
        <div class="stat-card"><div class="s-icon" style="background:#ffebee; color:#f44336;"><i class="fas fa-globe"></i></div><div><h3>{{ stats.top_count }}x</h3><small>{{ stats.top_name }}</small></div></div>
        {% endif %}
    </div>
</div>

<div class="widgets-area">
    <div id="check-res" style="text-align:center; padding:20px; background:#fff; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,0.05); margin-bottom:20px; color:#555;">
        <i class="fas fa-satellite-dish fa-spin"></i> Mendeteksi Lokasi...
    </div>

    <div id="readiness">
        <h3 style="color:#2e7d32; margin-top:0;"><i class="fas fa-check-circle"></i> Tercover Digital!</h3>
        <p>Lokasi: <b id="u-loc">Indonesia</b> siap.</p>
        <div class="gauge"><div class="gauge-bg"></div><div class="needle" id="needle"></div></div>
        <p style="font-weight:bold; color:#333;">Sinyal: Sangat Baik</p>
    </div>

    <div class="grid-info">
        <div class="card-info">
            <div class="c-icon" style="background:linear-gradient(135deg, #f6d365, #fda085);"><i class="fas fa-cloud-sun"></i></div>
            <div><h5 id="w-city" style="margin:0; font-size:0.85rem; color:#777;">...</h5><h3 id="w-tmp" style="margin:0; font-size:1.5rem;">--°C</h3><small id="w-dsc">Cuaca</small></div>
        </div>
        <a href="https://binamarga.pu.go.id/contents/cctv_tol" target="_blank" class="card-info">
            <div class="c-icon" style="background:linear-gradient(135deg, #84fab0, #8fd3f4);"><i class="fas fa-road"></i></div>
            <div><h5 style="margin:0; font-size:0.9rem; font-weight:bold;">CCTV Tol</h5><small style="color:#777;">Pantau Macet</small></div>
        </a>
        <a href="https://magma.esdm.go.id" target="_blank" class="card-info">
            <div class="c-icon" style="background:linear-gradient(135deg, #a18cd1, #fbc2eb);"><i class="fas fa-mountain"></i></div>
            <div><h5 style="margin:0; font-size:0.9rem; font-weight:bold;">Info Bencana</h5><small style="color:#777;">Peta Longsor</small></div>
        </a>
    </div>
</div>

<script>
    // CHANNEL LIST (M3U8)
    const st = {
        'caruban': { n:'Caruban TV', u:'https://c2.siar.us/carubantv/live/playlist.m3u8' },
        'stara': { n:'Stara TV', u:'https://c2.siar.us/staratv/live/playlist.m3u8' },
        'nusantara': { n:'Nusantara TV', u:'https://stream.nusantaratv.com/live/smil:nusantaratv.smil/playlist.m3u8' },
        'garuda': { n:'Garuda TV', u:'https://edge.medcom.id/live-stream/garudatv/index.m3u8' },
        'matrix': { n:'Matrix TV', u:'https://cdn.matrix.co.id/live/matrix.m3u8' },
        'rtv': { n:'RTV HD', u:'https://str.rtv.co.id/live/rtv/index.m3u8' },
        'elshinta': { n:'Elshinta TV', u:'https://live.elshinta.com/hls/elshintatv.m3u8' },
        'tvri': { n:'TVRI Nasional', u:'https://live.tvri.co.id/live/nasional/index.m3u8' },
        'tvri_sport': { n:'TVRI Sport', u:'https://live.tvri.co.id/live/sport/index.m3u8' },
        'magna': { n:'Magna Channel', u:'https://edge.medcom.id/live-stream/magnachannel/index.m3u8' },
        'bn': { n:'BN Channel', u:'https://edge.medcom.id/live-stream/bnchannel/index.m3u8' },
        'batv': { n:'BATV', u:'https://live.batv.co.id/hls/batv.m3u8' },
        'inspira': { n:'Inspira TV', u:'https://stream.inspira.tv/hls/inspira.m3u8' }
    };

    var v = document.getElementById('vPlayer');
    var h = new Hls();

    function play(k) {
        document.querySelectorAll('.chan-btn').forEach(b => b.classList.remove('active'));
        if(event) event.target.classList.add('active');
        var c = st[k];
        document.getElementById('now-play').innerHTML = "Play: <b>" + c.n + "</b>";
        if (Hls.isSupported()) {
            h.loadSource(c.u); h.attachMedia(v);
            h.on(Hls.Events.MANIFEST_PARSED, function() { v.play().catch(()=>{}); });
        } else if (v.canPlayType('application/vnd.apple.mpegurl')) {
            v.src = c.u; v.addEventListener('loadedmetadata', function() { v.play(); });
        }
    }
    document.addEventListener('DOMContentLoaded', () => { play('caruban'); });

    // GPS & LOGIC
    document.addEventListener("DOMContentLoaded", function() {
        const provs = {{ provinsi_tersedia | tojson }};
        const res = document.getElementById('check-res');
        const read = document.getElementById('readiness');
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json()).then(d => {
                    let city = d.address.city || d.address.town || "Lokasi Anda";
                    let pr = (d.address.state || "").toLowerCase();
                    document.getElementById('w-city').innerText = city;
                    document.getElementById('u-loc').innerText = city + ", " + d.address.state;

                    let ok = false;
                    if(pr.includes('jawa') || pr.includes('jakarta') || pr.includes('banten') || provs.some(x=>pr.includes(x.toLowerCase()))) ok = true;

                    res.style.display = 'none'; 
                    if(ok) {
                        read.style.display = 'block';
                        setTimeout(() => { document.getElementById('needle').style.transform = "rotate(90deg)"; }, 500);
                    } else {
                        res.style.display = 'block';
                        res.innerHTML = `<h3 style="color:#c0392b;">Belum Tercover</h3><a href="https://www.vidio.com/live" class="chan-btn active" style="background:#ce0000;border:none;color:white;">Nonton di Vidio</a>`;
                    }
                });

                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`)
                .then(r=>r.json()).then(d=>{
                    document.getElementById('w-tmp').innerText = Math.round(d.current_weather.temperature) + "°C";
                    let c = d.current_weather.weathercode, t = "Cerah";
                    if(c>3) t="Berawan"; if(c>50) t="Hujan";
                    document.getElementById('w-dsc').innerText = t;
                });
            }, () => { res.innerHTML = "Aktifkan GPS untuk fitur lengkap."; });
        }
    });
</script>
{% endblock %}
