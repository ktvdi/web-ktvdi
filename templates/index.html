{% extends "base.html" %}

{% block title %}Komunitas TV Digital Indonesia{% endblock %}

{% block body_class %}home-page{% endblock %}

{% block content %}
    <section class="hero">
        <h1 id="headline">Selamat Datang di Website Komunitas TV Digital Indonesia</h1>
        <p id="paragraph" style="display: none;">
          KTVDI menjadi wadah diskusi bagi semua pemirsa siaran televisi digital di Indonesia untuk memperluas wawasan terkait segala hal yang berkaitan dengan siaran televisi, khususnya Televisi Digital Terestrial (DTT).
        </p>
        <a href="#statistic-tv" id="read-more" style="display:none;">Selengkapnya</a>
    </section>
    
    <div class="statistik" id="statistic-tv" style="display:none;">
      <h1 class="statistik-title">Siaran Digital dalam Angka</h1>

      <div class="card-statistik">
        <div class="card-header-statistik">
          <h2>{{ jumlah_wilayah_layanan }}</h2>
          <p>Wilayah Layanan</p>
        </div>
        <div class="card-body-statistik">
          <p>Saat ini jumlah Wilayah Layanan yang tersedia di seluruh Indonesia berjumlah {{ jumlah_wilayah_layanan }} Wilayah Layanan.</p>
        </div>
        <div class="card-footer-statistik">
          <p><i class="fa-solid fa-rotate"></i>last update {{ last_updated_time }}</p>
        </div>
      </div>
      <div class="card-statistik">
        <div class="card-header-statistik">
          <h2>{{ jumlah_penyelenggara_mux }}</h2>
          <p>Layanan MUX</p>
        </div>
        <div class="card-body-statistik">
          <p>Saat ini jumlah Layanan MUX yang beroperasi di seluruh Indonesia berjumlah {{ jumlah_penyelenggara_mux }} layanan MUX.</p>
        </div>
        <div class="card-footer-statistik">
          <p><i class="fa-solid fa-rotate"></i>last update {{ last_updated_time }}</p>
        </div>
      </div>
      <div class="card-statistik">
        <div class="card-header-statistik">
          <h2>{{ jumlah_siaran }}</h2>
          <p>Siaran TV Digital</p>
        </div>
        <div class="card-body-statistik">
          <p>Saat ini jumlah siaran TV Digital yang beroperasi di seluruh Indonesia berjumlah {{ jumlah_siaran }} siaran.</p>
        </div>
        <div class="card-footer-statistik">
          <p><i class="fa-solid fa-rotate"></i>last update {{ last_updated_time }}</p>
        </div>
      </div>
      <div class="card-statistik">
        <div class="card-header-statistik">
          <h2>{{ most_common_siaran_name }}</h2>
          <p>Siaran TV Digital Terluas</p>
        </div>
        <div class="card-body-statistik">
          <p>Saat ini {{ most_common_siaran_name }} merupakan saluran TV Digital dengan jangkauan terluas di Indonesia, yang tersedia di {{ most_common_siaran_count }} layanan MUX.</p>
        </div>
        <div class="card-footer-statistik">
          <p><i class="fa-solid fa-rotate"></i>last update {{ last_updated_time }}</p>
        </div>
      </div>
    </div>

    <section style="padding: 40px 20px; background-color: #f9f9f9; text-align: center;">
        <h1 class="statistik-title" style="margin-bottom: 30px;">Nonton TV Digital Online</h1>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto;">
            <div id="tv-grid" style="display: contents;"></div>
        </div>
    </section>

    <section style="padding: 40px 20px; max-width: 900px; margin: 0 auto;">
        <h1 class="statistik-title" style="margin-bottom: 30px;">Pertanyaan Umum (FAQ)</h1>
        
        <div class="faq-item" style="margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
            <details style="padding: 15px; background: white; cursor: pointer;">
                <summary style="font-weight: bold; color: #333; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    Apa itu MUX (Multiplexing)?
                    <i class="fa-solid fa-chevron-down"></i>
                </summary>
                <p style="margin-top: 10px; color: #666; line-height: 1.6;">MUX ibarat "Bus" yang mengangkut banyak penumpang (Channel TV). Satu frekuensi MUX bisa membawa 5-10 channel sekaligus. Jadi jika Anda menangkap sinyal MUX TVRI, otomatis Anda akan mendapatkan TVRI Nasional, TVRI Sport, TVRI World, dan TVRI Daerah sekaligus.</p>
            </details>
        </div>

        <div class="faq-item" style="margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
            <details style="padding: 15px; background: white; cursor: pointer;">
                <summary style="font-weight: bold; color: #333; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    Dimana Nonton Piala Dunia 2026?
                    <i class="fa-solid fa-chevron-down"></i>
                </summary>
                <p style="margin-top: 10px; color: #666; line-height: 1.6;">Hak siar <strong>Piala Dunia 2026</strong> untuk jalur terestrial (UHF gratis) dipegang oleh <strong>TVRI</strong>. Pastikan antena Anda mengarah ke pemancar TVRI terdekat untuk mendapatkan kualitas HD tanpa diacak.</p>
            </details>
        </div>

        <div class="faq-item" style="margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
            <details style="padding: 15px; background: white; cursor: pointer;">
                <summary style="font-weight: bold; color: #333; list-style: none; display: flex; justify-content: space-between; align-items: center;">
                    Kenapa Sinyal Saya Sering Hilang?
                    <i class="fa-solid fa-chevron-down"></i>
                </summary>
                <p style="margin-top: 10px; color: #666; line-height: 1.6;">Penyebab utama: 1. Arah antena salah, 2. Kabel antena tua/rusak, 3. Jack konektor karatan. Solusi: Gunakan antena outdoor, kabel RG6 berkualitas, dan pastikan konektor terpasang kencang.</p>
            </details>
        </div>
    </section>

    <button id="chat-toggle" style="display: none;"><i class="fa-solid fa-comments"></i></button>

    <div class="chatbot" id="chatbot" style="display: none;">
      <h1>ChatKTVDI</h1>
      <div class="chat-body" id="chat-body"></div>
      <div class="input-area">
        <textarea id="prompt" placeholder="Tulis pertanyaan..."></textarea>
        <button class="send-btn" onclick="sendPrompt()"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>

    <script>
      // 1. DATA CHANNEL TV (Dikembalikan)
      const channels = [
            {name: "TVRI Nasional", url: "https://ott-balancer.tvri.go.id/live/eds/Nasional/hls/Nasional.m3u8"},
            {name: "TVRI Sport", url: "https://ott-balancer.tvri.go.id/live/eds/Sport/hls/Sport.m3u8"},
            {name: "Nusantara TV", url: "https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8"},
            {name: "Kompas TV", url: "http://103.46.11.106:9981/stream/channelid/1691704072?ticket=933C4850FCC4D9EE7E8D7D37D095694F55914124&profile=pass"},
            {name: "Berita Satu", url: "https://beritasatu.secureswiftcontent.com/han/beritasatu/bsatu10008/srtoutput/manifest.m3u8"},
            {name: "Garuda TV", url: "https://hgmtv.com:19360/garudatvlivestreaming/garudatvlivestreaming.m3u8"},
            {name: "JTV Surabaya", url: "https://cctv.jtv.co.id/hls/test.m3u8"},
            {name: "Bali TV", url: "https://live.balitv.tv/hls/balitv.m3u8"}
      ];

      // Render TV Grid
      const tvGrid = document.getElementById('tv-grid');
      channels.forEach((ch, idx) => {
          const card = document.createElement('div');
          // Style Inline Card agar rapi tanpa CSS tambahan
          card.style.cssText = "background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);";
          card.innerHTML = `
            <div style="position: relative; padding-top: 56.25%; background: black;">
                <video id="vid-${idx}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" controls muted playsinline></video>
                <span style="position: absolute; top: 10px; left: 10px; background: red; color: white; padding: 2px 6px; font-size: 10px; border-radius: 4px; font-weight: bold;">LIVE</span>
            </div>
            <div style="padding: 10px;">
                <h3 style="margin: 0; font-size: 14px; font-weight: bold; color: #333;">${ch.name}</h3>
            </div>
          `;
          tvGrid.appendChild(card);

          // Init HLS
          const video = document.getElementById(`vid-${idx}`);
          if(Hls.isSupported()) {
              const hls = new Hls(); hls.loadSource(ch.url); hls.attachMedia(video);
          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
              video.src = ch.url;
          }
      });

      // 2. LOGIC BAWAAN (Animasi & Chatbot)
      const toggleBtn = document.getElementById("chat-toggle");
      const chatbot = document.getElementById("chatbot");
      const chatBody = document.getElementById("chat-body");
      const promptInput = document.getElementById("prompt");

      toggleBtn.addEventListener("click", () => {
        chatbot.style.display = chatbot.style.display === "flex" ? "none" : "flex";
      });

      async function sendPrompt() {
        const prompt = promptInput.value.trim();
        if (!prompt) return;
        appendMessage(prompt, "user");
        promptInput.value = "";
        const thinkingMsg = appendMessage("⏳ Sedang memproses...", "bot");

        try {
          const res = await fetch("/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt })
          });
          const data = await res.json();
          chatBody.removeChild(thinkingMsg);
          if (data.response) appendMessage(data.response, "bot");
          else appendMessage("❌ Error: " + data.error, "bot");
        } catch (err) {
          chatBody.removeChild(thinkingMsg);
          appendMessage("⚠️ Gagal terhubung ke server.", "bot");
        }
      }

      function appendMessage(text, sender) {
        const msg = document.createElement("div");
        msg.classList.add("message", sender);
        chatBody.appendChild(msg);
        chatBody.scrollTop = chatBody.scrollHeight;
        const formattedText = text.replace(/\n/g, '<br>');
        let i = 0;
        msg.innerText = "";
        function typeWriterChat() {
          if (i < text.length) {
            msg.textContent += text.charAt(i); i++;
            chatBody.scrollTop = chatBody.scrollHeight;
            setTimeout(typeWriterChat, 20);
          }
        }
        typeWriterChat();
        return msg;
      }
      
      promptInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
      });
    </script>
{% endblock %}
