{% extends "base.html" %}

{% block title %}Beranda - Komunitas TV Digital Indonesia{% endblock %}

{% block content %}
<style>
    /* HERO SECTION */
    .hero {
        max-width: 1280px;
        margin: 0 auto;
        padding: 60px 24px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 60px;
        align-items: center;
        min-height: 80vh;
    }

    .hero-content h1 {
        font-size: 3.5rem;
        line-height: 1.1;
        color: var(--secondary);
        margin-bottom: 24px;
        font-weight: 800;
    }
    
    .hero-content p {
        font-size: 1.125rem;
        color: var(--text-muted);
        line-height: 1.8;
        margin-bottom: 40px;
        max-width: 540px;
    }

    .tag {
        display: inline-block;
        background: #eff6ff;
        color: var(--primary);
        padding: 6px 16px;
        border-radius: 100px;
        font-weight: 600;
        font-size: 0.85rem;
        margin-bottom: 24px;
    }

    .hero-btns { display: flex; gap: 16px; }

    /* PLAYER CONTAINER (TV Look) */
    .player-card {
        background: white;
        padding: 16px;
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        border: 1px solid var(--border);
        position: relative;
    }

    .video-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background: black;
        border-radius: 16px;
        overflow: hidden;
    }
    
    video { width: 100%; height: 100%; object-fit: contain; }

    /* OVERLAYS PLAYER */
    .badge-live {
        position: absolute;
        top: 16px; left: 16px;
        background: #ef4444;
        color: white;
        padding: 4px 12px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 6px;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .badge-live::before {
        content: ''; width: 8px; height: 8px; background: white; border-radius: 50%;
        animation: blink 1s infinite;
    }

    .badge-bitrate {
        position: absolute;
        top: 16px; right: 16px;
        background: rgba(0,0,0,0.6);
        color: #fbbf24;
        padding: 4px 8px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.7rem;
        backdrop-filter: blur(4px);
        z-index: 10;
        display: none; /* Show by JS */
    }

    .player-meta {
        margin-top: 20px;
    }
    
    .now-playing-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .channel-list {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding-bottom: 8px;
    }
    
    .chip {
        background: var(--surface);
        border: 1px solid var(--border);
        padding: 8px 16px;
        border-radius: 50px;
        font-size: 0.85rem;
        color: var(--text-muted);
        cursor: pointer;
        transition: 0.2s;
        white-space: nowrap;
    }
    .chip:hover { border-color: var(--primary); color: var(--primary); }
    .chip.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* FEATURES SECTION (Why Us) */
    .features {
        background: var(--surface);
        padding: 80px 24px;
        border-top: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
    }
    
    .section-title { text-align: center; max-width: 700px; margin: 0 auto 60px; }
    .section-title h2 { font-size: 2.5rem; color: var(--secondary); margin-bottom: 16px; }
    
    .grid-3 {
        max-width: 1280px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 40px;
    }
    
    .feature-card {
        background: white;
        padding: 32px;
        border-radius: 16px;
        box-shadow: var(--shadow-sm);
        transition: 0.3s;
        border: 1px solid transparent;
    }
    .feature-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--shadow-lg); }
    
    .icon-box {
        width: 60px; height: 60px;
        background: #eff6ff;
        color: var(--primary);
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 24px;
    }

    /* STATS SECTION */
    .stats-section { padding: 80px 24px; background: white; }
    .stats-layout {
        max-width: 1280px; margin: 0 auto;
        display: grid; grid-template-columns: 1.5fr 1fr; gap: 60px;
        align-items: center;
    }
    .chart-box {
        padding: 24px; background: white; border-radius: 20px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-lg);
        height: 400px;
    }
    .stat-grid-mini {
        display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
    }
    .stat-mini-card {
        padding: 24px; background: var(--surface); border-radius: 16px;
        text-align: center;
    }
    .stat-mini-card h3 { font-size: 2.5rem; color: var(--primary); margin: 0; font-weight: 800; }
    .stat-mini-card p { margin-top: 8px; font-size: 0.9rem; color: var(--text-muted); }

    /* CHAT WIDGET */
    .chat-trigger {
        position: fixed; bottom: 30px; right: 30px;
        width: 64px; height: 64px;
        background: var(--primary); color: white;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 28px;
        box-shadow: 0 10px 25px rgba(0, 136, 255, 0.4);
        cursor: pointer; z-index: 999;
        transition: 0.3s;
        border: none;
    }
    .chat-trigger:hover { transform: scale(1.1); }
    
    /* Animations */
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Responsive */
    @media (max-width: 900px) {
        .hero { grid-template-columns: 1fr; text-align: center; padding-top: 40px; }
        .hero-content h1 { font-size: 2.5rem; }
        .hero-btns { justify-content: center; }
        .stats-layout { grid-template-columns: 1fr; }
    }
</style>

<section class="hero">
    <div class="hero-content">
        <span class="tag">#AyoNontonTVDigital</span>
        <h1>Revolusi Siaran Digital Indonesia</h1>
        <p>
            Bergabunglah dengan KTVDI. Wadah diskusi pemirsa siaran televisi digital terlengkap. 
            Dapatkan update frekuensi, daftar MUX, dan informasi ASO di wilayah Anda.
        </p>
        <div class="hero-btns">
            <a href="#statistik" class="btn btn-primary">Lihat Data Statistik</a>
            <a href="/daftar-siaran" class="btn btn-ghost" style="border:1px solid var(--border);">Cari Saluran</a>
        </div>
    </div>

    <div class="player-card">
        <div class="video-wrapper">
            <video id="tvPlayer" controls autoplay muted playsinline></video>
            <div class="badge-live">LIVE</div>
            <div class="badge-bitrate" id="bitrateDisplay">AUTO</div>
        </div>
        
        <div class="player-meta">
            <div class="now-playing-bar">
                <div style="font-weight: 600; color: var(--secondary); display: flex; align-items: center; gap: 8px;">
                    <div style="width: 8px; height: 8px; background: var(--primary); border-radius: 50%;"></div>
                    Sedang Memutar: <span id="channelName" style="color: var(--primary);">Nusantara TV</span>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">
                    <i class="fa-solid fa-signal"></i> Stabil
                </div>
            </div>
            
            <div class="channel-list">
                <button class="chip active" onclick="changeChannel('Nusantara TV', 'https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8', this)">Nusantara TV</button>
                <button class="chip" onclick="changeChannel('RTV HD', 'https://rtvstream.rtv.co.id:4555/hls/rtv.m3u8', this)">RTV</button>
                <button class="chip" onclick="changeChannel('Matrix TV', 'https://stream.matrixtv.id/hls/stream.m3u8', this)">Matrix TV</button>
                <button class="chip" onclick="changeChannel('Berita Satu', 'https://beritasatu.secureswiftcontent.com/han/beritasatu/bsatu10008/srtoutput/manifest.m3u8', this)">Berita Satu</button>
            </div>
        </div>
    </div>
</section>

<section class="features">
    <div class="section-title">
        <h2>Mengapa KTVDI?</h2>
        <p>Platform komunitas nomor satu yang menghubungkan pemirsa siaran digital dari Sabang sampai Merauke.</p>
    </div>
    
    <div class="grid-3">
        <div class="feature-card">
            <div class="icon-box"><i class="fa-solid fa-users"></i></div>
            <h3>Komunitas Solid</h3>
            <p style="color:var(--text-muted); margin-top:10px;">
                Berdiskusi langsung dengan ribuan anggota komunitas. Bagikan pengalaman dan kendala teknis Anda.
            </p>
        </div>
        <div class="feature-card">
            <div class="icon-box"><i class="fa-solid fa-database"></i></div>
            <h3>Data Akurat</h3>
            <p style="color:var(--text-muted); margin-top:10px;">
                Database frekuensi MUX dan wilayah layanan yang selalu diperbarui oleh kontributor terpercaya di seluruh Indonesia.
            </p>
        </div>
        <div class="feature-card">
            <div class="icon-box"><i class="fa-solid fa-tower-broadcast"></i></div>
            <h3>Informasi ASO</h3>
            <p style="color:var(--text-muted); margin-top:10px;">
                Pantau perkembangan Analog Switch Off (ASO) dan perluasan jangkauan siaran digital di daerah Anda.
            </p>
        </div>
    </div>
</section>

<section class="stats-section" id="statistik">
    <div class="stats-layout">
        <div class="chart-box">
            <h3 style="margin-bottom: 20px;">Sebaran Wilayah Layanan</h3>
            <div style="position: relative; height: 300px;">
                <canvas id="wilayahChart"></canvas>
            </div>
        </div>
        
        <div>
            <div style="margin-bottom: 30px;">
                <h2 style="font-size: 2rem; color: var(--secondary); margin-bottom: 10px;">Statistik Terkini</h2>
                <p style="color: var(--text-muted);">Data diperbarui pada: <strong>{{ last_updated_time }}</strong></p>
            </div>
            
            <div class="stat-grid-mini">
                <div class="stat-mini-card">
                    <h3>{{ jumlah_wilayah_layanan }}</h3>
                    <p>Wilayah Layanan</p>
                </div>
                <div class="stat-mini-card">
                    <h3>{{ jumlah_penyelenggara_mux }}</h3>
                    <p>Layanan MUX</p>
                </div>
                <div class="stat-mini-card">
                    <h3>{{ jumlah_siaran }}</h3>
                    <p>Total Siaran</p>
                </div>
                <div class="stat-mini-card">
                    <h3>{{ most_common_siaran_count }}</h3>
                    <p>Jangkauan Terluas</p>
                </div>
            </div>
        </div>
    </div>
</section>

<button class="chat-trigger"><i class="fa-solid fa-comments"></i></button>
<script>
    // --- PLAYER LOGIC + BITRATE ---
    const video = document.getElementById('tvPlayer');
    const bitrateEl = document.getElementById('bitrateDisplay');
    const defaultUrl = 'https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8';

    let hls;

    function initPlayer(url) {
        if (Hls.isSupported()) {
            if(hls) hls.destroy(); // Cleanup previous instance
            
            hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play();
                bitrateEl.style.display = 'block';
            });

            // Listen to level switch to show bitrate
            hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                const level = hls.levels[data.level];
                if(level) {
                    const bitrate = (level.bitrate / 1000).toFixed(0);
                    bitrateEl.innerText = `${bitrate} Kbps`;
                }
            });

        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.addEventListener('loadedmetadata', function() {
                video.play();
            });
            bitrateEl.innerText = "HLS Native";
            bitrateEl.style.display = 'block';
        }
    }

    initPlayer(defaultUrl);

    window.changeChannel = function(name, url, btn) {
        document.getElementById('channelName').innerText = name;
        
        // Update Active Class
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        
        initPlayer(url);
    }

    // --- CHART JS ---
    const ctx = document.getElementById('wilayahChart').getContext('2d');
    const labels = JSON.parse('{{ chart_labels | safe }}');
    const dataValues = JSON.parse('{{ chart_data | safe }}');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Jumlah Wilayah',
                data: dataValues,
                backgroundColor: '#0088ff',
                borderRadius: 6,
                barThickness: 20
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                x: { grid: { display: false } }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}
