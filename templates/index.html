{% extends "base.html" %}

{% block title %}Beranda - Komunitas TV Digital Indonesia{% endblock %}

{% block body_class %}home-page{% endblock %}

{% block content %}
<style>
    /* 1. HERO SECTION */
    .hero-container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 60px 20px;
        display: grid;
        grid-template-columns: 1fr 1fr; /* Split 50:50 */
        gap: 50px;
        align-items: center;
        min-height: 85vh; /* Full screen feel */
    }

    /* Kiri: Teks */
    .hero-text h1 {
        font-size: 3.2rem;
        line-height: 1.2;
        color: var(--secondary);
        margin-bottom: 20px;
    }
    .hero-text p {
        font-size: 1.1rem;
        color: var(--text-gray);
        line-height: 1.7;
        margin-bottom: 35px;
        max-width: 550px;
    }
    .badge-modern {
        display: inline-block;
        background: #e0f2fe;
        color: var(--primary);
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.85rem;
        margin-bottom: 20px;
    }

    .cta-group {
        display: flex;
        gap: 15px;
    }
    .btn-hero {
        padding: 15px 35px;
        border-radius: 50px;
        font-weight: 600;
        text-decoration: none;
        transition: transform 0.2s;
    }
    .btn-primary-hero {
        background: var(--primary);
        color: white;
        box-shadow: 0 10px 25px rgba(0, 136, 255, 0.3);
    }
    .btn-primary-hero:hover { transform: translateY(-3px); background: var(--primary-dark); }
    .btn-outline-hero {
        border: 2px solid #eee;
        color: var(--secondary);
    }
    .btn-outline-hero:hover { background: #f8fafc; border-color: #ddd; }

    /* Kanan: Visual (TV Player) */
    .hero-visual {
        background: white;
        padding: 15px;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.08);
        border: 1px solid #f1f5f9;
        position: relative;
    }

    .video-frame {
        width: 100%;
        aspect-ratio: 16/9;
        background: black;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    video { width: 100%; height: 100%; object-fit: contain; }

    /* Channel Controls */
    .channel-controls {
        margin-top: 20px;
    }
    .now-playing {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--secondary);
    }
    .live-indicator {
        width: 10px; height: 10px;
        background: #ef4444;
        border-radius: 50%;
        animation: pulseRed 1.5s infinite;
    }
    .channel-list {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding-bottom: 5px;
        scrollbar-width: thin;
    }
    .btn-channel {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 8px 16px;
        border-radius: 50px;
        white-space: nowrap;
        cursor: pointer;
        color: var(--text-gray);
        font-size: 0.85rem;
        transition: 0.2s;
    }
    .btn-channel:hover { border-color: var(--primary); color: var(--primary); }
    .btn-channel.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* 2. STATISTIK SECTION */
    .stats-section {
        background: #f8fafc;
        padding: 80px 20px;
    }
    .stats-container {
        max-width: 1280px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1.5fr 1fr; /* Grafik Kiri Besar, Angka Kanan Kecil */
        gap: 50px;
        align-items: center;
    }

    /* Card Grafik */
    .chart-card {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        height: 400px;
        display: flex;
        flex-direction: column;
    }
    
    /* Grid Angka */
    .numbers-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .stat-box {
        background: white;
        padding: 25px;
        border-radius: 16px;
        border: 1px solid #eef2f6;
        transition: 0.3s;
    }
    .stat-box:hover { transform: translateY(-5px); }
    .stat-box h2 { font-size: 2.5rem; color: var(--primary); margin: 0; font-weight: 800; }
    .stat-box p { color: var(--text-gray); margin-top: 5px; font-weight: 500; font-size: 0.9rem; }

    /* CHAT BUTTON */
    #chat-float {
        position: fixed; bottom: 30px; right: 30px;
        width: 65px; height: 65px;
        background: var(--primary); color: white;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 28px;
        box-shadow: 0 10px 25px rgba(0,136,255,0.4);
        cursor: pointer; z-index: 999;
        transition: transform 0.3s;
        border: none;
    }
    #chat-float:hover { transform: scale(1.1); }

    /* CHAT BOX */
    .chat-window {
        position: fixed; bottom: 110px; right: 30px;
        width: 380px; height: 500px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        display: none; flex-direction: column;
        z-index: 999; overflow: hidden;
        border: 1px solid #eee;
    }
    .chat-header { background: var(--primary); padding: 20px; color: white; font-weight: 700; }
    .chat-body { flex: 1; padding: 20px; overflow-y: auto; background: #f9fafb; display: flex; flex-direction: column; gap: 15px; }
    .chat-input { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
    .chat-input input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 50px; outline: none; }
    .chat-input button { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
    
    .msg { padding: 10px 15px; border-radius: 12px; font-size: 0.9rem; max-width: 80%; line-height: 1.4; }
    .msg-bot { background: white; border: 1px solid #eee; align-self: flex-start; border-bottom-left-radius: 2px; }
    .msg-user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }

    /* Animations */
    @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* RESPONSIVE */
    @media (max-width: 968px) {
        .hero-container { grid-template-columns: 1fr; text-align: center; padding-top: 30px; }
        .hero-text h1 { font-size: 2.2rem; }
        .cta-group { justify-content: center; }
        .stats-container { grid-template-columns: 1fr; }
        .chart-card { height: 300px; }
        .chat-window { width: 90%; right: 5%; bottom: 100px; }
    }
</style>

<section class="hero-container">
    <div class="hero-text">
        <span class="badge-modern">#AyoNontonTVDigital</span>
        <h1>Komunitas TV Digital Indonesia</h1>
        <p>
            Platform informasi siaran televisi digital terlengkap di Indonesia. 
            Cek frekuensi, daftar MUX, dan pantau perkembangan migrasi Analog Switch Off (ASO) secara real-time.
        </p>
        <div class="cta-group">
            <a href="#statistik" class="btn-hero btn-primary-hero">Lihat Statistik</a>
            <a href="/daftar-siaran" class="btn-hero btn-outline-hero">Cari Siaran</a>
        </div>
    </div>

    <div class="hero-visual">
        <div class="video-frame">
            <video id="tvPlayer" controls autoplay muted playsinline></video>
        </div>
        <div class="channel-controls">
            <div class="now-playing">
                <div class="live-indicator"></div>
                Sedang Memutar: <span id="channelName" style="color:var(--primary);">Nusantara TV</span>
            </div>
            <div class="channel-list">
                <button class="btn-channel active" onclick="playChannel('Nusantara TV', 'https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8', this)">Nusantara TV</button>
                <button class="btn-channel" onclick="playChannel('RTV HD', 'https://rtvstream.rtv.co.id:4555/hls/rtv.m3u8', this)">RTV</button>
                <button class="btn-channel" onclick="playChannel('Matrix TV', 'https://stream.matrixtv.id/hls/stream.m3u8', this)">Matrix TV</button>
                <button class="btn-channel" onclick="playChannel('Berita Satu', 'https://beritasatu.secureswiftcontent.com/han/beritasatu/bsatu10008/srtoutput/manifest.m3u8', this)">Berita Satu</button>
            </div>
        </div>
    </div>
</section>

<section class="stats-section" id="statistik">
    <div class="stats-container">
        <div class="chart-card">
            <h3 style="margin-bottom: 15px; font-weight: 700;">Sebaran Wilayah Layanan</h3>
            <div style="flex:1; position: relative;">
                <canvas id="wilayahChart"></canvas>
            </div>
        </div>

        <div>
            <div style="margin-bottom: 25px;">
                <h2 style="font-size: 2rem; margin-bottom: 10px;">Data Terkini</h2>
                <p>Update terakhir sistem: <strong>{{ last_updated_time }}</strong></p>
            </div>
            <div class="numbers-grid">
                <div class="stat-box">
                    <h2>{{ jumlah_wilayah_layanan }}</h2>
                    <p>Wilayah Layanan</p>
                </div>
                <div class="stat-box">
                    <h2>{{ jumlah_penyelenggara_mux }}</h2>
                    <p>Layanan MUX</p>
                </div>
                <div class="stat-box">
                    <h2>{{ jumlah_siaran }}</h2>
                    <p>Total Siaran</p>
                </div>
                <div class="stat-box">
                    <h2>{{ most_common_siaran_count }}</h2>
                    <p>Jangkauan Terluas</p>
                </div>
            </div>
        </div>
    </div>
</section>

<button id="chat-float" onclick="toggleChat()"><i class="fa-solid fa-comments"></i></button>

<div class="chat-window" id="chatWindow">
    <div class="chat-header">
        <i class="fa-solid fa-robot"></i> Asisten KTVDI
        <span onclick="toggleChat()" style="float:right; cursor:pointer;"><i class="fa-solid fa-xmark"></i></span>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="msg msg-bot">Halo! Ada yang bisa saya bantu seputar TV Digital?</div>
    </div>
    <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Tulis pertanyaan..." onkeypress="handleEnter(event)">
        <button onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<script>
    // --- 1. PLAYER LOGIC ---
    const video = document.getElementById('tvPlayer');
    const defaultUrl = 'https://nusantaratv.siar.us/nusantaratv/live/playlist.m3u8';

    function loadStream(url) {
        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.addEventListener('loadedmetadata', () => video.play());
        }
    }
    loadStream(defaultUrl);

    window.playChannel = function(name, url, btn) {
        document.getElementById('channelName').innerText = name;
        document.querySelectorAll('.btn-channel').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadStream(url);
    }

    // --- 2. CHART JS LOGIC ---
    // Mengambil data JSON yang dikirim dari Flask (app.py)
    const labels = JSON.parse('{{ chart_labels | safe }}');
    const dataValues = JSON.parse('{{ chart_data | safe }}');

    const ctx = document.getElementById('wilayahChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Jumlah Wilayah',
                data: dataValues,
                backgroundColor: '#0088ff',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });

    // --- 3. CHATBOT LOGIC ---
    function toggleChat() {
        const win = document.getElementById('chatWindow');
        const btn = document.getElementById('chat-float');
        if (win.style.display === 'flex') {
            win.style.display = 'none';
            btn.innerHTML = '<i class="fa-solid fa-comments"></i>';
        } else {
            win.style.display = 'flex';
            btn.innerHTML = '<i class="fa-solid fa-xmark"></i>';
        }
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const body = document.getElementById('chatBody');
        const prompt = input.value.trim();
        if(!prompt) return;

        // User Msg
        body.innerHTML += `<div class="msg msg-user">${prompt}</div>`;
        input.value = '';
        body.scrollTop = body.scrollHeight;

        // Loading
        const loadMsg = document.createElement('div');
        loadMsg.className = 'msg msg-bot';
        loadMsg.innerText = 'Mengetik...';
        body.appendChild(loadMsg);

        try {
            const res = await fetch('/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({prompt: prompt})
            });
            const data = await res.json();
            
            body.removeChild(loadMsg);
            if(data.response) {
                // Konversi Markdown simple (Bold/List) ke HTML jika perlu, atau text biasa
                // Di sini text biasa tapi kita replace newline dengan <br>
                let safeText = data.response.replace(/\n/g, '<br>');
                // Replace **text** dengan <b>text</b> manual simple regex
                safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                
                body.innerHTML += `<div class="msg msg-bot">${safeText}</div>`;
            } else {
                body.innerHTML += `<div class="msg msg-bot">Maaf, terjadi kesalahan.</div>`;
            }
        } catch (err) {
            body.removeChild(loadMsg);
            body.innerHTML += `<div class="msg msg-bot">Gagal koneksi server.</div>`;
        }
        body.scrollTop = body.scrollHeight;
    }

    function handleEnter(e) {
        if(e.key === 'Enter') sendMessage();
    }
</script>
{% endblock %}
