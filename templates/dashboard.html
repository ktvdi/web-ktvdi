{% extends "base.html" %}

{% block title %}Dashboard - Komunitas TV Digital Indonesia{% endblock %}

{% block content %}
<style>
    /* --- CSS Khusus Dashboard (Responsive) --- */
    .dashboard-container {
        max-width: 900px;
        margin-top: 2rem;
    }

    /* Header: Logout tombol pindah ke bawah di HP */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 15px;
    }

    /* Kartu Profil */
    .profile-card {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap; /* Agar aman di layar sangat kecil */
    }

    .profile-icon {
        background: #e6f2ff;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* Mencegah ikon mengecil/gepeng */
    }

    /* Form & Select */
    .step-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #444;
    }

    .custom-select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        background-color: #fff;
        font-size: 1rem; /* Font enak dibaca di HP */
    }

    /* Grup Tombol Edit/Hapus */
    .action-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    /* List Saluran TV */
    .channel-list {
        padding-left: 20px;
        columns: 2; /* Default Desktop: 2 Kolom */
    }

    /* --- RESPONSIVE (Layar HP < 768px) --- */
    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .btn-logout {
            width: 100%;
            text-align: center;
            justify-content: center;
        }

        .action-group {
            flex-direction: column; /* Tombol Edit & Hapus jadi atas-bawah */
        }

        .channel-list {
            columns: 1 !important; /* Di HP jadi 1 kolom agar terbaca */
        }
    }
</style>

<div class="container fade-in-up dashboard-container">
    
    <div class="dashboard-header">
        <h1 style="color: var(--primary); margin: 0; font-size: 1.8rem;">Dashboard Pengguna</h1>
        <a href="/logout" class="btn-full btn-logout" style="width: auto; background: #e74c3c; padding: 10px 25px; font-size: 0.95rem; text-decoration: none; border-radius: 6px; color: white;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>

    <div class="auth-card" style="margin-bottom: 2rem; text-align: left; border-left: 5px solid var(--primary);">
        <div class="profile-card">
            <div class="profile-icon">
                <i class="fas fa-user" style="font-size: 1.8rem; color: var(--primary);"></i>
            </div>
            <div>
                <h3 style="margin: 0; color: #333;">Selamat Datang, {{ name }}!</h3>
                <p style="margin: 5px 0 0; color: #666; font-size: 0.95rem;">Terima kasih telah berkontribusi di komunitas.</p>
            </div>
        </div>
    </div>

    <div class="auth-card" style="text-align: left;">
        <h3 style="margin-bottom: 20px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <i class="fas fa-tv"></i> Kelola Data Siaran
        </h3>

        <div class="form-group">
            <label for="provinsi" class="step-label">1. Pilih Provinsi</label>
            <select id="provinsi" class="custom-select">
                <option value="">-- Silakan Pilih --</option>
                {% for p in provinsi_list %}
                    <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="wilayah" class="step-label">2. Pilih Wilayah Layanan</label>
            <select id="wilayah" class="custom-select" disabled>
                <option value="">-- Menunggu Provinsi --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="mux" class="step-label">3. Pilih Penyelenggara MUX</label>
            <select id="mux" class="custom-select" disabled>
                <option value="">-- Menunggu Wilayah --</option>
            </select>
        </div>

        <div id="action-buttons" style="margin-top: 25px; display: none;">
            <button id="addDataBtn" class="btn-full" style="background: var(--primary); display: none; width: 100%; padding: 12px; font-size: 1rem; border: none; border-radius: 8px; color: white; cursor: pointer;">
                <i class="fas fa-plus-circle"></i> Tambah Data Baru
            </button>

            <div id="editDeleteGroup" class="action-group" style="display: none;">
                <button id="editDataBtn" style="background: #f39c12; flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 1rem;">
                    <i class="fas fa-edit"></i> Edit Data
                </button>
                <button id="deleteDataBtn" style="background: #e74c3c; flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 1rem;">
                    <i class="fas fa-trash"></i> Hapus
                </button>
            </div>
        </div>
    </div>

    <div id="detail" style="margin-top: 20px;"></div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        
        // Helper: Reset Dropdown
        function resetDropdown(selector, defaultText) {
            $(selector).empty().append('<option value="">' + defaultText + '</option>').prop('disabled', true);
        }

        // Helper: Atur Tombol
        function updateButtons(isDataExist) {
            $("#action-buttons").slideDown(); // Efek animasi halus
            if (isDataExist) {
                $("#addDataBtn").hide();
                $("#editDeleteGroup").css("display", "flex"); // Pakai flex agar responsive class bekerja
            } else {
                $("#addDataBtn").show();
                $("#editDeleteGroup").hide();
            }
        }

        // 1. GANTI PROVINSI
        $("#provinsi").change(function () {
            var provinsi = $(this).val();
            resetDropdown("#wilayah", "-- Memuat... --");
            resetDropdown("#mux", "-- Menunggu Wilayah --");
            $("#detail").empty();
            $("#action-buttons").hide();

            if (provinsi) {
                $.getJSON("/get_wilayah", { provinsi: provinsi }, function (data) {
                    if (data.wilayah && data.wilayah.length > 0) {
                        $("#wilayah").empty().append('<option value="">-- Pilih Wilayah --</option>');
                        $.each(data.wilayah, function (i, w) {
                            $("#wilayah").append('<option value="' + w + '">' + w + "</option>");
                        });
                        $("#wilayah").prop('disabled', false);
                    } else {
                        resetDropdown("#wilayah", "-- Tidak ada data --");
                        updateButtons(false);
                        $("#detail").html('<div style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; border:1px solid #ffeeba;">‚ö†Ô∏è Belum ada data wilayah. Silakan tambah baru.</div>');
                    }
                });
            } else {
                resetDropdown("#wilayah", "-- Menunggu Provinsi --");
            }
        });

        // 2. GANTI WILAYAH
        $("#wilayah").change(function () {
            var provinsi = $("#provinsi").val();
            var wilayah = $(this).val();
            resetDropdown("#mux", "-- Memuat... --");
            $("#detail").empty();
            $("#action-buttons").hide();

            if (wilayah) {
                $.getJSON("/get_mux", { provinsi: provinsi, wilayah: wilayah }, function (data) {
                    if (data.mux && data.mux.length > 0) {
                        $("#mux").empty().append('<option value="">-- Pilih MUX --</option>');
                        $.each(data.mux, function (i, m) {
                            $("#mux").append('<option value="' + m + '">' + m + "</option>");
                        });
                        $("#mux").prop('disabled', false);
                    } else {
                        resetDropdown("#mux", "-- Tidak ada data --");
                        updateButtons(false);
                        $("#detail").html('<div style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; border:1px solid #ffeeba;">‚ö†Ô∏è Belum ada data MUX. Silakan tambah.</div>');
                    }
                });
            } else {
                resetDropdown("#mux", "-- Menunggu Wilayah --");
            }
        });

        // 3. GANTI MUX (TAMPILKAN DATA)
        $("#mux").change(function () {
            var provinsi = $("#provinsi").val();
            var wilayah = $("#wilayah").val();
            var mux = $(this).val();

            if (mux) {
                $("#detail").html('<p style="text-align:center; color:#666; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Memuat data...</p>');
                
                $.getJSON("/get_siaran", { provinsi: provinsi, wilayah: wilayah, mux: mux }, function (data) {
                    if (data.siaran && data.siaran.length > 0) {
                        var html = `
                            <div class="auth-card fade-in-up" style="text-align:left; border-top: 5px solid var(--primary);">
                                <h2 style="color:var(--primary); margin-top:0; font-size:1.5rem;">üì° ${mux}</h2>
                                <p style="font-size:0.9rem; color:#666; margin-bottom:15px; line-height: 1.6;">
                                    <i class="fas fa-clock"></i> Update: ${data.last_updated_date || "-"} ${data.last_updated_time || ""} <br>
                                    <i class="fas fa-user"></i> Oleh: <strong>${data.last_updated_by_name || "-"}</strong>
                                </p>
                                <h4 style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom: 10px;">Daftar Saluran:</h4>
                                <ul class="channel-list">
                                    ${data.siaran.map(s => `<li style="margin-bottom:5px;">${s}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        $("#detail").html(html);
                        updateButtons(true);
                    } else {
                        $("#detail").html('<div style="background:#e8f5e9; color:#2e7d32; padding:15px; border-radius:8px;">Data kosong atau belum lengkap.</div>');
                        updateButtons(false);
                    }
                });
            } else {
                $("#detail").empty();
                $("#action-buttons").hide();
            }
        });

        // --- BUTTON ACTIONS ---
        $("#addDataBtn").click(function() {
            window.location.href = "{{ url_for('add_data') }}"; 
        });

        $("#editDataBtn").click(function() {
            var p = $("#provinsi").val(), w = $("#wilayah").val(), m = $("#mux").val();
            if(p && w && m) window.location.href = `/edit_data/${p}/${w}/${m}`;
        });

        $("#deleteDataBtn").click(function() {
            var p = $("#provinsi").val(), w = $("#wilayah").val(), m = $("#mux").val();
            if(p && w && m && confirm("Yakin ingin menghapus data MUX ini? Tindakan tidak bisa dibatalkan.")) {
                $.post(`/delete_data/${p}/${w}/${m}`, function() {
                    alert("Data berhasil dihapus.");
                    location.reload();
                });
            }
        });

    });
</script>
{% endblock %}
