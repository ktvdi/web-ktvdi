{% extends "base.html" %}

{% block title %}Dashboard - Komunitas TV Digital Indonesia{% endblock %}

{% block content %}
<div class="container fade-in-up" style="max-width: 900px; margin-top: 2rem;">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 15px;">
        <h1 style="color: var(--primary); margin: 0;">Dashboard Pengguna</h1>
        <a href="/logout" class="btn-full" style="width: auto; background: #e74c3c; padding: 8px 20px; font-size: 0.9rem;">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>

    <div class="auth-card" style="margin-bottom: 2rem; text-align: left; border-left: 5px solid var(--primary);">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="background: #e6f2ff; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user" style="font-size: 1.8rem; color: var(--primary);"></i>
            </div>
            <div>
                <h3 style="margin: 0; color: #333;">Selamat Datang, {{ name }}!</h3>
                <p style="margin: 0; color: #666; font-size: 0.95rem;">Terima kasih telah berkontribusi di komunitas.</p>
            </div>
        </div>
    </div>

    <div class="auth-card" style="text-align: left;">
        <h3 style="margin-bottom: 20px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <i class="fas fa-tv"></i> Kelola Data Siaran
        </h3>

        <div class="form-group">
            <label for="provinsi"><strong>1. Pilih Provinsi</strong></label>
            <select id="provinsi" class="form-control" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="">-- Silakan Pilih --</option>
                {% for p in provinsi_list %}
                    <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="wilayah"><strong>2. Pilih Wilayah Layanan</strong></label>
            <select id="wilayah" class="form-control" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;" disabled>
                <option value="">-- Menunggu Provinsi --</option>
            </select>
        </div>

        <div class="form-group">
            <label for="mux"><strong>3. Pilih Penyelenggara MUX</strong></label>
            <select id="mux" class="form-control" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;" disabled>
                <option value="">-- Menunggu Wilayah --</option>
            </select>
        </div>

        <div id="action-buttons" style="margin-top: 25px; display: none;">
            <button id="addDataBtn" class="btn-full" style="background: var(--primary); display: none;">
                <i class="fas fa-plus-circle"></i> Tambah Data Baru
            </button>

            <div id="editDeleteGroup" style="display: flex; gap: 10px; display: none;">
                <button id="editDataBtn" class="btn-full" style="background: #f39c12; flex: 1;">
                    <i class="fas fa-edit"></i> Edit Data
                </button>
                <button id="deleteDataBtn" class="btn-full" style="background: #e74c3c; flex: 1;">
                    <i class="fas fa-trash"></i> Hapus
                </button>
            </div>
        </div>
    </div>

    <div id="detail" style="margin-top: 20px;"></div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        
        // Reset Dropdown Helper
        function resetDropdown(selector, defaultText) {
            $(selector).empty().append('<option value="">' + defaultText + '</option>').prop('disabled', true);
        }

        // Toggle Tombol Aksi
        function updateButtons(isDataExist) {
            $("#action-buttons").show();
            if (isDataExist) {
                $("#addDataBtn").hide();
                $("#editDeleteGroup").css("display", "flex");
            } else {
                $("#addDataBtn").show();
                $("#editDeleteGroup").hide();
            }
        }

        // 1. GANTI PROVINSI
        $("#provinsi").change(function () {
            var provinsi = $(this).val();
            resetDropdown("#wilayah", "-- Memuat... --");
            resetDropdown("#mux", "-- Menunggu Wilayah --");
            $("#detail").empty();
            $("#action-buttons").hide();

            if (provinsi) {
                $.getJSON("/get_wilayah", { provinsi: provinsi }, function (data) {
                    if (data.wilayah && data.wilayah.length > 0) {
                        $("#wilayah").empty().append('<option value="">-- Pilih Wilayah --</option>');
                        $.each(data.wilayah, function (i, w) {
                            $("#wilayah").append('<option value="' + w + '">' + w + "</option>");
                        });
                        $("#wilayah").prop('disabled', false);
                    } else {
                        resetDropdown("#wilayah", "-- Tidak ada data --");
                        // Tampilkan tombol tambah karena data kosong
                        updateButtons(false);
                        $("#detail").html('<div style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; border:1px solid #ffeeba;">‚ö†Ô∏è Belum ada data wilayah di provinsi ini. Silakan tambah baru.</div>');
                    }
                });
            } else {
                resetDropdown("#wilayah", "-- Menunggu Provinsi --");
            }
        });

        // 2. GANTI WILAYAH
        $("#wilayah").change(function () {
            var provinsi = $("#provinsi").val();
            var wilayah = $(this).val();
            resetDropdown("#mux", "-- Memuat... --");
            $("#detail").empty();
            $("#action-buttons").hide();

            if (wilayah) {
                $.getJSON("/get_mux", { provinsi: provinsi, wilayah: wilayah }, function (data) {
                    if (data.mux && data.mux.length > 0) {
                        $("#mux").empty().append('<option value="">-- Pilih MUX --</option>');
                        $.each(data.mux, function (i, m) {
                            $("#mux").append('<option value="' + m + '">' + m + "</option>");
                        });
                        $("#mux").prop('disabled', false);
                    } else {
                        resetDropdown("#mux", "-- Tidak ada data --");
                        updateButtons(false);
                        $("#detail").html('<div style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; border:1px solid #ffeeba;">‚ö†Ô∏è Belum ada data MUX di wilayah ini.</div>');
                    }
                });
            } else {
                resetDropdown("#mux", "-- Menunggu Wilayah --");
            }
        });

        // 3. GANTI MUX (TAMPILKAN DATA)
        $("#mux").change(function () {
            var provinsi = $("#provinsi").val();
            var wilayah = $("#wilayah").val();
            var mux = $(this).val();

            if (mux) {
                $("#detail").html('<p style="text-align:center; color:#666;">‚è≥ Memuat data...</p>');
                
                $.getJSON("/get_siaran", { provinsi: provinsi, wilayah: wilayah, mux: mux }, function (data) {
                    if (data.siaran && data.siaran.length > 0) {
                        var html = `
                            <div class="auth-card fade-in-up" style="text-align:left; border-top: 5px solid var(--primary);">
                                <h2 style="color:var(--primary); margin-top:0;">üì° ${mux}</h2>
                                <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">
                                    <i class="fas fa-clock"></i> Update: ${data.last_updated_date || "-"} ${data.last_updated_time || ""} <br>
                                    <i class="fas fa-user"></i> Oleh: <strong>${data.last_updated_by_name || "-"}</strong>
                                </p>
                                <h4 style="border-bottom:1px solid #eee; padding-bottom:5px;">Daftar Saluran:</h4>
                                <ul style="padding-left:20px; columns: 2;">
                                    ${data.siaran.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        $("#detail").html(html);
                        updateButtons(true); // Ada data -> Tampilkan Edit/Hapus
                    } else {
                        $("#detail").html('<div style="background:#e8f5e9; color:#2e7d32; padding:15px; border-radius:8px;">Data kosong atau belum lengkap.</div>');
                        updateButtons(false);
                    }
                });
            } else {
                $("#detail").empty();
                $("#action-buttons").hide();
            }
        });

        // --- BUTTON ACTIONS ---
        $("#addDataBtn").click(function() {
            window.location.href = "{{ url_for('add_data') }}"; 
        });

        $("#editDataBtn").click(function() {
            var p = $("#provinsi").val(), w = $("#wilayah").val(), m = $("#mux").val();
            if(p && w && m) window.location.href = `/edit_data/${p}/${w}/${m}`;
        });

        $("#deleteDataBtn").click(function() {
            var p = $("#provinsi").val(), w = $("#wilayah").val(), m = $("#mux").val();
            if(p && w && m && confirm("Yakin ingin menghapus data MUX ini? Tindakan tidak bisa dibatalkan.")) {
                $.post(`/delete_data/${p}/${w}/${m}`, function() {
                    alert("Data berhasil dihapus.");
                    location.reload();
                });
            }
        });

    });
</script>
{% endblock %}
