<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kelola Data Siaran</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="dashboard-container">
    <header>
      <h1>Halo, {{ nama }} üëã</h1>
      <p>Username Anda: <strong>{{ username }}</strong></p>
      <p>Kelola data siaran di database</p>
    </header>

    <main>
      <!-- Form tambah siaran -->
      <div class="card">
        <h2>‚ûï Tambah Siaran</h2>
        <form method="POST" action="{{ url_for('tambah_siaran') }}">
          <label for="provinsi">Provinsi:</label>
          <select id="provinsi" name="provinsi" required>
            {% if data_siaran %}
              {% for provinsi in data_siaran.keys() %}
                <option value="{{ provinsi }}">{{ provinsi }}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled selected>Tidak ada provinsi (data kosong)</option>
            {% endif %}
          </select>

          <label for="wilayah_num">Nomor Wilayah:</label>
          <input type="number" id="wilayah_num" name="wilayah_num" placeholder="Contoh: 1" required>

          <label for="wilayah">Wilayah Layanan:</label>
          <input type="text" id="wilayah" name="wilayah" readonly required>

          <label for="uhf">Nomor UHF:</label>
          <input type="number" id="uhf" name="uhf" placeholder="Contoh: 30" required>

          <label for="nama_mux">Nama MUX:</label>
          <input type="text" id="nama_mux" name="nama_mux" placeholder="Contoh: Indosiar" required>

          <label for="mux">MUX:</label>
          <input type="text" id="mux" name="mux" readonly required>

          <label for="nama_siaran">Nama Siaran:</label>
          <input type="text" id="nama_siaran" name="nama_siaran" required>

          <button type="submit">Tambah</button>
        </form>
      </div>

      <!-- Daftar siaran -->
      <div class="card">
        <h2>üì∫ Daftar Siaran</h2>
        {% if data_siaran %}
          {% for provinsi, wilayah_data in (data_siaran or {}).items() %}
            <h3>{{ provinsi }}</h3>
            {% for wilayah, mux_data in (wilayah_data or {}).items() %}
              <h4>{{ wilayah }}</h4>
              {% for mux, isi in (mux_data or {}).items() %}
                <div class="mux-box">
                  <strong>{{ mux }}</strong>
                  <ul>
                    {% set siaran_list = isi.get('siaran', {}) %}
                    
                    {# Jika dict (format baru) #}
                    {% if siaran_list is mapping %}
                      {% for i, ch in siaran_list.items() %}
                        <li>
                          {{ ch }}
                          <a href="{{ url_for('hapus_siaran', provinsi=provinsi, wilayah=wilayah, mux=mux, index=i) }}" onclick="return confirm('Yakin ingin menghapus siaran ini?')">üóëÔ∏è Hapus</a>
                        </li>
                      {% endfor %}
                    
                    {# Jika list (format lama) #}
                    {% elif siaran_list is iterable %}
                      {% for i in range(siaran_list|length) %}
                        <li>
                          {{ siaran_list[i] }}
                          <a href="{{ url_for('hapus_siaran', provinsi=provinsi, wilayah=wilayah, mux=mux, index=i) }}" onclick="return confirm('Yakin ingin menghapus siaran ini?')">üóëÔ∏è Hapus</a>
                        </li>
                      {% endfor %}
                    
                    {% else %}
                      <li><em>Tidak ada siaran</em></li>
                    {% endif %}
                  </ul>
                </div>
              {% endfor %}
            {% endfor %}
          {% endfor %}
        {% else %}
          <p>Belum ada data siaran.</p>
        {% endif %}
      </div>
    </main>

    <footer>
      <a href="{{ url_for('logout') }}" class="logout-btn">Keluar</a>
    </footer>
  </div>

  <script>
    // Auto-generate Wilayah
    const provEl = document.getElementById('provinsi');
    const wilayahNumEl = document.getElementById('wilayah_num');
    function updateWilayah() {
      const prov = provEl ? provEl.value : '';
      const num = wilayahNumEl ? wilayahNumEl.value : '';
      const out = document.getElementById('wilayah');
      if (out) out.value = (prov && num) ? (prov + '-' + num) : '';
    }
    if (provEl) provEl.addEventListener('change', updateWilayah);
    if (wilayahNumEl) wilayahNumEl.addEventListener('input', updateWilayah);

    // Auto-generate MUX
    const uhfEl = document.getElementById('uhf');
    const namaMuxEl = document.getElementById('nama_mux');
    function updateMux() {
      const uhf = uhfEl ? uhfEl.value : '';
      const nama = namaMuxEl ? namaMuxEl.value : '';
      const out = document.getElementById('mux');
      if (out) out.value = (uhf && nama) ? ("UHF " + uhf + " - " + nama) : '';
    }
    if (uhfEl) uhfEl.addEventListener('input', updateMux);
    if (namaMuxEl) namaMuxEl.addEventListener('input', updateMux);
  </script>
</body>
</html>
