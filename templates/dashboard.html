{% extends "base.html" %}

{% block title %}Dashboard - Komunitas TV Digital Indonesia{% endblock %}

{% block content %}
<div class="min-h-screen bg-brand-surface py-12 px-4 relative overflow-hidden font-['Plus_Jakarta_Sans']">
    
    <div class="absolute top-0 right-0 w-96 h-96 bg-blue-100 rounded-full blur-3xl opacity-50 -mr-20 -mt-20"></div>
    <div class="absolute bottom-0 left-0 w-96 h-96 bg-purple-100 rounded-full blur-3xl opacity-50 -ml-20 -mb-20"></div>

    <div class="max-w-4xl mx-auto relative z-10 space-y-8">
        
        <div class="bg-white/90 backdrop-blur-xl rounded-3xl shadow-xl border border-white/50 p-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-full bg-gradient-to-r from-brand-blue to-brand-navy flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                    {{ name[0] | upper }}
                </div>
                <div>
                    <h1 class="text-2xl font-extrabold text-brand-navy">Halo, {{ name }}! ðŸ‘‹</h1>
                    <p class="text-slate-500 text-sm">Selamat datang kembali di panel kontributor.</p>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="px-6 py-2.5 bg-red-50 text-red-600 font-bold rounded-xl border border-red-100 hover:bg-red-600 hover:text-white transition-all shadow-sm flex items-center gap-2">
                <i class="fa-solid fa-right-from-bracket"></i> Keluar
            </a>
        </div>

        <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8">
            <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                <div class="p-2 bg-brand-blue/10 rounded-lg text-brand-blue">
                    <i class="fa-solid fa-database text-xl"></i>
                </div>
                <h2 class="text-xl font-bold text-brand-navy">Kelola Data Siaran</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Provinsi</label>
                    <div class="relative">
                        <select id="provinsi" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-semibold focus:ring-2 focus:ring-brand-blue focus:border-brand-blue appearance-none cursor-pointer transition-all">
                            <option value="">-- Pilih Provinsi --</option>
                            {% for p in provinsi_list %}
                                <option value="{{ p }}">{{ p }}</option>
                            {% endfor %}
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Wilayah</label>
                    <div class="relative">
                        <select id="wilayah" disabled class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-semibold focus:ring-2 focus:ring-brand-blue disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-all">
                            <option value="">-- Pilih Wilayah --</option>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider ml-1">Penyelenggara MUX</label>
                    <div class="relative">
                        <select id="mux" disabled class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-semibold focus:ring-2 focus:ring-brand-blue disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer transition-all">
                            <option value="">-- Pilih MUX --</option>
                        </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div id="detail" class="mt-8 transition-all duration-300">
                <div class="text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50">
                    <i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-50"></i>
                    <p class="text-sm font-medium">Silakan pilih filter di atas untuk melihat data.</p>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-100 flex flex-wrap gap-4 justify-end">
                <button id="addDataBtn" class="px-6 py-3 bg-brand-blue text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 hover:shadow-blue-500/30 transition-all flex items-center gap-2 transform active:scale-95">
                    <i class="fa-solid fa-plus-circle"></i> Tambah Data Baru
                </button>
                
                <div id="data-buttons" class="hidden flex gap-3">
                    <button id="editDataBtn" class="px-5 py-3 bg-yellow-500 text-white font-bold rounded-xl shadow-lg hover:bg-yellow-600 transition-all flex items-center gap-2 transform active:scale-95">
                        <i class="fa-solid fa-pen-to-square"></i> Edit
                    </button>
                    <button id="deleteDataBtn" class="px-5 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition-all flex items-center gap-2 transform active:scale-95">
                        <i class="fa-solid fa-trash-can"></i> Hapus
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {
    
    // Fungsi Toggle Tombol
    function toggleButtons() {
        var p = $("#provinsi").val(), w = $("#wilayah").val(), m = $("#mux").val();
        
        if (p && !w && !m) {
            $("#data-buttons").addClass("hidden").removeClass("flex");
            $("#addDataBtn").removeClass("hidden");
        } else if (p && w && m) {
            $("#addDataBtn").addClass("hidden");
            $("#data-buttons").removeClass("hidden").addClass("flex");
        } else {
            $("#addDataBtn").removeClass("hidden");
            $("#data-buttons").addClass("hidden").removeClass("flex");
        }
    }

    // Efek Loading pada Dropdown
    function setLoading(selector) {
        $(selector).prop('disabled', true).html('<option>Memuat...</option>');
    }

    // Change Provinsi
    $("#provinsi").change(function () {
        var val = $(this).val();
        setLoading("#wilayah"); 
        setLoading("#mux"); 
        $("#detail").html('<div class="text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><p>Memuat Wilayah...</p></div>');

        if (val) {
            $.getJSON("/get_wilayah", { provinsi: val }, function (data) {
                var w = $("#wilayah").empty().append('<option value="">-- Pilih Wilayah --</option>').prop('disabled', false);
                $("#mux").empty().append('<option value="">-- Pilih MUX --</option>').prop('disabled', true);
                
                if (data.wilayah && data.wilayah.length > 0) {
                    $.each(data.wilayah, function (i, item) { w.append('<option value="' + item + '">' + item + '</option>'); });
                    $("#detail").html('<div class="text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50"><i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-50"></i><p class="text-sm font-medium">Pilih Wilayah untuk melanjutkan.</p></div>');
                } else {
                    $("#detail").html('<div class="p-4 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-xl flex items-center gap-3"><i class="fa-solid fa-triangle-exclamation text-xl"></i><span>Belum ada data wilayah di provinsi ini.</span></div>');
                }
                toggleButtons();
            });
        } else {
            $("#wilayah, #mux").prop('disabled', true).html('<option value="">-- Pilih --</option>');
            $("#detail").empty();
            toggleButtons();
        }
    });

    // Change Wilayah
    $("#wilayah").change(function () {
        var p = $("#provinsi").val(), w = $(this).val();
        setLoading("#mux");

        if (w) {
            $.getJSON("/get_mux", { provinsi: p, wilayah: w }, function (data) {
                var m = $("#mux").empty().append('<option value="">-- Pilih MUX --</option>').prop('disabled', false);
                
                if (data.mux && data.mux.length > 0) {
                    $.each(data.mux, function (i, item) { m.append('<option value="' + item + '">' + item + '</option>'); });
                    $("#detail").html('<div class="text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50"><i class="fa-solid fa-tower-broadcast text-4xl mb-3 opacity-50"></i><p class="text-sm font-medium">Pilih MUX untuk melihat daftar siaran.</p></div>');
                } else {
                    $("#detail").html('<div class="p-4 bg-yellow-50 text-yellow-700 border border-yellow-200 rounded-xl flex items-center gap-3"><i class="fa-solid fa-triangle-exclamation text-xl"></i><span>Belum ada data MUX di wilayah ini.</span></div>');
                }
                toggleButtons();
            });
        }
    });

    // Change MUX (Show Detail)
    $("#mux").change(function () {
        var p = $("#provinsi").val(), w = $("#wilayah").val(), m = $(this).val();

        if (m) {
            $("#detail").html('<div class="text-center py-8"><i class="fa-solid fa-circle-notch fa-spin text-3xl text-brand-blue"></i></div>');
            
            $.getJSON("/get_siaran", { provinsi: p, wilayah: w, mux: m }, function (data) {
                if (data.siaran && data.siaran.length > 0) {
                    var html = `
                        <div class="bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
                            <div class="bg-brand-navy p-4 flex justify-between items-center text-white">
                                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fa-solid fa-tower-cell"></i> ${m}</h3>
                                <span class="bg-white/10 px-3 py-1 rounded-full text-xs font-mono">${data.last_updated_date || '-'}</span>
                            </div>
                            <div class="p-6">
                                <div class="flex items-center gap-2 mb-4 text-xs text-slate-500 bg-white p-2 rounded-lg border border-slate-100 inline-block">
                                    <i class="fa-solid fa-user-pen text-brand-blue"></i> Diupdate oleh: 
                                    <strong class="text-slate-700">${data.last_updated_by_name || 'Admin'}</strong>
                                </div>
                                <h4 class="font-bold text-brand-navy mb-3 text-sm uppercase tracking-wide">Daftar Channel:</h4>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    `;
                    
                    $.each(data.siaran, function(i, s) {
                        html += `<div class="bg-white p-3 rounded-lg border border-slate-200 flex items-center gap-2 shadow-sm">
                                    <i class="fa-solid fa-tv text-brand-blue"></i> 
                                    <span class="text-sm font-semibold text-slate-700 truncate">${s}</span>
                                 </div>`;
                    });

                    html += `</div></div></div>`;
                    $("#detail").html(html);
                    toggleButtons();
                }
            });
        }
    });

    // Button Actions
    $("#addDataBtn").click(function() { window.location.href = "{{ url_for('add_data') }}"; });
    
    $("#editDataBtn").click(function() {
        var url = `/edit_data/${$("#provinsi").val()}/${$("#wilayah").val()}/${$("#mux").val()}`;
        window.location.href = url;
    });

    $("#deleteDataBtn").click(function() {
        if(confirm("Yakin ingin menghapus data ini secara permanen?")) {
            var url = `/delete_data/${$("#provinsi").val()}/${$("#wilayah").val()}/${$("#mux").val()}`;
            $.post(url, function() {
                alert("Data berhasil dihapus!");
                location.reload();
            });
        }
    });
});
</script>
{% endblock %}
