<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Dashboard KTVDI</h1>

        <div class="card">
            <div class="card-header">
                <h4>Selamat Datang, {{ name }}!</h4>
            </div>
            <div class="card-body">
                <p>Anda berhasil login. Berikut adalah informasi akun Anda:</p>
                <ul>
                    <li><strong>Nama Lengkap:</strong> {{ name }}</li>
                </ul>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>

        <!-- Daftar Siaran TV Digital -->
        <h2 class="mt-4">üì∫ Daftar Siaran TV Digital</h2>

        <!-- Filter Provinsi -->
        <label class="select-label" for="provinsi">Pilih Provinsi:</label>
        <select id="provinsi">
            <option value="">-- Pilih Provinsi --</option>
            {% for p in provinsi_list %}
                <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
        </select>

        <!-- Filter Wilayah -->
        <label class="select-label" for="wilayah">Pilih Wilayah:</label>
        <select id="wilayah">
            <option value="">-- Pilih Wilayah --</option>
        </select>

        <!-- Filter MUX -->
        <label class="select-label" for="mux">Pilih MUX:</label>
        <select id="mux">
            <option value="">-- Pilih MUX --</option>
        </select>

        <!-- Detail Siaran -->
        <div id="detail"></div>

        <!-- Manage Data Buttons -->
        {% if session.get('user') %}
            <div class="mt-4">
                <button id="addDataBtn" class="btn-primer">Tambah Data</button>
                <div id="data-buttons" style="display: none;">
                    <button id="editDataBtn" class="btn-warning">Edit Data</button>
                    <button id="deleteDataBtn" class="btn-danger">Hapus Data</button>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Script -->
    <script>
        $(document).ready(function () {
            // Saat pilih provinsi
            $("#provinsi").change(function () {
                var provinsi = $(this).val();

                if (provinsi) {
                    $.getJSON("/get_wilayah", { provinsi: provinsi }, function (data) {
                        if (!data.wilayah || data.wilayah.length === 0) {
                            $("#wilayah").empty().append('<option value="">-- Pilih Wilayah --</option>');
                            $("#mux").empty().append('<option value="">-- Pilih MUX --</option>');
                            $("#detail").html(
                                '<div class="alert-siaran">‚ö†Ô∏è Data siaran untuk provinsi ini belum ditambahkan. Silahkan untuk menambahkan data siaran!</div>'
                            );
                        } else {
                            $("#wilayah").empty().append('<option value="">-- Pilih Wilayah --</option>');
                            $.each(data.wilayah, function (i, w) {
                                $("#wilayah").append('<option value="' + w + '">' + w + "</option>");
                            });
                            $("#mux").empty().append('<option value="">-- Pilih MUX --</option>');
                            $("#detail").html("");
                        }
                    });
                } else {
                    $("#wilayah").empty().append('<option value="">-- Pilih Wilayah --</option>');
                    $("#mux").empty().append('<option value="">-- Pilih MUX --</option>');
                    $("#detail").html("");
                }
            });

            // Saat pilih wilayah
            $("#wilayah").change(function () {
                var provinsi = $("#provinsi").val();
                var wilayah = $(this).val();

                if (wilayah) {
                    $.getJSON("/get_mux", { provinsi: provinsi, wilayah: wilayah }, function (data) {
                        if (!data.mux || data.mux.length === 0) {
                            $("#mux").empty().append('<option value="">-- Pilih MUX --</option>');
                            $("#detail").html(
                                '<div class="alert alert-warning">‚ö†Ô∏è Data siaran untuk provinsi ini belum ditambahkan. Silahkan <a href="/login">login</a> untuk menambahkan data siaran!</div>'
                            );
                        } else {
                            $("#mux").empty().append('<option value="">-- Pilih MUX --</option>');
                            $.each(data.mux, function (i, m) {
                                $("#mux").append('<option value="' + m + '">' + m + "</option>");
                            });
                            $("#detail").html("");
                        }
                    });
                }
            });

            // Saat pilih mux
            $("#mux").change(function () {
                var provinsi = $("#provinsi").val();
                var wilayah = $("#wilayah").val();
                var mux = $(this).val();

                if (mux) {
                    $.getJSON(
                        "/get_siaran",
                        { provinsi: provinsi, wilayah: wilayah, mux: mux },
                        function (data) {
                            if (!data.siaran || data.siaran.length === 0) {
                                $("#detail").html(
                                    '<div class="alert alert-warning">‚ö†Ô∏è Data siaran untuk provinsi ini belum ditambahkan. Silahkan <a href="/login">login</a> untuk menambahkan data siaran!</div>'
                                );
                            } else {
                                var html = '<div class="card">';
                                html += "<h3>üì° " + mux + "</h3>";
                                html +=
                                    "<p><strong>Update:</strong> " +
                                    (data.last_updated_date || "-") +
                                    " " +
                                    (data.last_updated_time || "") +
                                    "</p>";
                                html +=
                                    "<p><strong>Oleh:</strong> " +
                                    (data.last_updated_by_name || "-") +
                                    " (" +
                                    (data.last_updated_by_username || "-") +
                                    ")</p>";
                                html += "<h4>üì∫ Daftar Siaran:</h4><ul>";

                                $.each(data.siaran, function (i, s) {
                                    html += "<li>" + s + "</li>";
                                });

                                html += "</ul></div>";
                                $("#detail").html(html);
                            }
                        }
                    );
                }
            });

            // Handle Add Data Button
            $("#addDataBtn").click(function() {
                window.location.href = "{{ url_for('add_data') }}";
            });

            // Handle Edit Data Button
            $("#editDataBtn").click(function() {
                var provinsi = $("#provinsi").val();
                var wilayah = $("#wilayah").val();
                var mux = $("#mux").val();

                if (provinsi && wilayah && mux) {
                    window.location.href = "/edit_data/" + provinsi + "/" + wilayah + "/" + mux;
                } else {
                    alert("Harap pilih Provinsi, Wilayah, dan MUX terlebih dahulu.");
                }
            });

            // Handle Delete Data Button
            $("#deleteDataBtn").click(function() {
                var provinsi = $("#provinsi").val();
                var wilayah = $("#wilayah").val();
                var mux = $("#mux").val();

                if (provinsi && wilayah && mux) {
                    if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
                        $.post("/delete_data/" + provinsi + "/" + wilayah + "/" + mux, function(data) {
                            alert("Data berhasil dihapus.");
                            location.reload();
                        });
                    }
                } else {
                    alert("Harap pilih Provinsi, Wilayah, dan MUX terlebih dahulu.");
                }
            });
        });

        $(document).ready(function() {
        // Fungsi untuk memeriksa apakah ketiga pilihan telah dipilih
        function checkSelections() {
            var provinsi = $('#provinsi').val();
            var wilayah = $('#wilayah').val();
            var mux = $('#mux').val();

            // Jika Provinsi, Wilayah, dan MUX telah dipilih, tampilkan tombol
            if (provinsi && wilayah && mux) {
                $('#addDataBtn').hide();

                setTimeout(function() {
                    $('#data-buttons').fadeIn(); // Tampilkan tombol Edit dan Hapus setelah jeda
                }, 2000);
            } else {
                $('#addDataBtn').show();
                $('#data-buttons').hide();
            }
        }

        // Menjalankan fungsi setiap kali pilihan berubah
        $('#provinsi, #wilayah, #mux').change(function() {
            checkSelections();
        });

        // Memeriksa status saat halaman dimuat
        checkSelections();
    });
    </script>

    <!-- Footer -->
    <div id="footer"></div>
</body>
</html>
